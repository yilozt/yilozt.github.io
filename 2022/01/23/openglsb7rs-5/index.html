<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="这是自己阅读 OpenGL 超级宝典（第七版）的笔记，使用 Rust 学习书上的示例。点击代码块上的眼睛按钮  可以展开代码，点击复制按钮  可以复制完整代码。  随书源码：https:&#x2F;&#x2F;github.com&#x2F;openglsuperbible&#x2F;sb7code demo： https:&#x2F;&#x2F;github.com&#x2F;yilozt&#x2F;sb7coders  第五章主要介绍了 OpenGL 中两种重要的数据形式">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenGL超级宝典第七版学习笔记 (5)：数据">
<meta property="og:url" content="https://yilozt.github.io/2022/01/23/openglsb7rs-5/index.html">
<meta property="og:site_name" content="笔记本">
<meta property="og:description" content="这是自己阅读 OpenGL 超级宝典（第七版）的笔记，使用 Rust 学习书上的示例。点击代码块上的眼睛按钮  可以展开代码，点击复制按钮  可以复制完整代码。  随书源码：https:&#x2F;&#x2F;github.com&#x2F;openglsuperbible&#x2F;sb7code demo： https:&#x2F;&#x2F;github.com&#x2F;yilozt&#x2F;sb7coders  第五章主要介绍了 OpenGL 中两种重要的数据形式">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yilozt.github.io/2022/01/23/openglsb7rs-5/uniform_blk_buffers.png">
<meta property="og:image" content="https://yilozt.github.io/2022/01/23/openglsb7rs-5/Opengl-logo.png">
<meta property="og:image" content="https://yilozt.github.io/2022/01/23/openglsb7rs-5/tex_coords.png">
<meta property="og:image" content="https://yilozt.github.io/2022/01/23/openglsb7rs-5/sampler_texture.png">
<meta property="og:image" content="https://yilozt.github.io/2022/01/23/openglsb7rs-5/assert_1.png">
<meta property="og:image" content="https://yilozt.github.io/2022/01/23/openglsb7rs-5/assert_2.png">
<meta property="og:image" content="https://yilozt.github.io/2022/01/23/openglsb7rs-5/assert_3.png">
<meta property="og:image" content="https://yilozt.github.io/2022/01/23/openglsb7rs-5/assert_4.png">
<meta property="og:image" content="https://yilozt.github.io/2022/01/23/openglsb7rs-5/assert_5.png">
<meta property="og:image" content="https://yilozt.github.io/2022/01/23/openglsb7rs-5/assert_6.png">
<meta property="og:image" content="https://yilozt.github.io/2022/01/23/openglsb7rs-5/mipmaps.png">
<meta property="og:image" content="https://yilozt.github.io/2022/01/23/openglsb7rs-5/linklist.png">
<meta property="og:image" content="https://yilozt.github.io/2022/01/23/openglsb7rs-5/fragmentlist.png">
<meta property="article:published_time" content="2022-01-23T05:35:55.000Z">
<meta property="article:author" content="yilozt">
<meta property="article:tag" content="OpenGL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yilozt.github.io/2022/01/23/openglsb7rs-5/uniform_blk_buffers.png">
    
    
      
        
          <link rel="shortcut icon" href="../../../../images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="../../../../images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="../../../../images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>OpenGL超级宝典第七版学习笔记 (5)：数据</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="atom.xml" title="笔记本" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="../../../../index.html">首页</a></li><!--
     --><!--
       --><li><a href="../../../../archives/">归档</a></li><!--
     --><!--
       --><li><a href="../../../../tags/">标签</a></li><!--
     --><!--
       --><li><a href="../../../../categories/">分类</a></li><!--
     --><!--
       --><li><a href="../../../../booklist/">书单</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="../../../03/04/openglsb7rs-6/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="../../21/Rust-code-hide-Test/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://yilozt.github.io/2022/01/23/openglsb7rs-5/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&text=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&title=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&is_video=false&description=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=OpenGL超级宝典第七版学习笔记 (5)：数据&body=Check out this article: https://yilozt.github.io/2022/01/23/openglsb7rs-5/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&title=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&title=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&title=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&title=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&name=OpenGL超级宝典第七版学习笔记 (5)：数据&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&t=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%86%B2"><span class="toc-number">1.</span> <span class="toc-text"> 缓冲</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%BC%93%E5%86%B2%E5%8C%BA%E5%AF%B9%E8%B1%A1-%E5%88%86%E9%85%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">1.1.</span> <span class="toc-text"> 创建缓冲区对象 &#x2F; 分配空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-number">1.2.</span> <span class="toc-text"> 更新缓冲区的内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A1%AB%E5%85%85%E6%95%B0%E6%8D%AE-%E7%BC%93%E5%86%B2%E5%8C%BA%E9%97%B4%E5%A4%8D%E5%88%B6%E6%95%B0%E6%8D%AE"><span class="toc-number">1.3.</span> <span class="toc-text"> 填充数据、缓冲区间复制数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E7%BC%93%E5%86%B2%E5%8C%BA%E4%BD%9C%E4%B8%BA%E9%A1%B6%E7%82%B9%E7%9D%80%E8%89%B2%E5%99%A8%E7%9A%84%E8%BE%93%E5%85%A5"><span class="toc-number">1.4.</span> <span class="toc-text"> 将缓冲区作为顶点着色器的输入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uniform-%E5%8F%98%E9%87%8F"><span class="toc-number">2.</span> <span class="toc-text"> Uniform 变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%91-uniform-%E5%8F%98%E9%87%8F%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE"><span class="toc-number">2.1.</span> <span class="toc-text"> 向 uniform 变量传递数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#uniform-%E5%8C%BA%E5%9D%97"><span class="toc-number">2.2.</span> <span class="toc-text"> Uniform 区块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9D%80%E8%89%B2%E5%99%A8%E5%AD%98%E5%82%A8%E5%8C%BA%E5%9D%97"><span class="toc-number">3.</span> <span class="toc-text"> 着色器存储区块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="toc-number">3.1.</span> <span class="toc-text"> 原子操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E5%86%85%E5%AD%98"><span class="toc-number">3.2.</span> <span class="toc-text"> 同步访问内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-opengl-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%86%85%E4%BD%BF%E7%94%A8%E5%B1%8F%E9%9A%9C"><span class="toc-number">3.3.</span> <span class="toc-text"> 在 OpenGL 应用程序内使用屏障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E7%9D%80%E8%89%B2%E5%99%A8%E5%86%85%E4%BD%BF%E7%94%A8%E5%B1%8F%E9%9A%9C"><span class="toc-number">3.4.</span> <span class="toc-text"> 在着色器内使用屏障</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E8%AE%A1%E6%95%B0%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text"> 原子计数器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E8%AE%A1%E6%95%B0%E5%99%A8%E7%9A%84%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE"><span class="toc-number">4.1.</span> <span class="toc-text"> 原子计数器的同步访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%B9%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text"> 纹理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BA%B9%E7%90%86"><span class="toc-number">5.1.</span> <span class="toc-text"> 创建、初始化纹理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%B9%E7%90%86%E7%9B%AE%E6%A0%87%E5%92%8C%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.</span> <span class="toc-text"> 纹理目标和类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E7%9D%80%E8%89%B2%E5%99%A8%E9%87%8C%E8%AF%BB%E5%8F%96%E7%BA%B9%E7%90%86%E6%95%B0%E6%8D%AE"><span class="toc-number">5.3.</span> <span class="toc-text"> 在着色器里读取纹理数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%87%E6%A0%B7%E5%99%A8%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.3.1.</span> <span class="toc-text"> 采样器类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E6%96%87%E4%BB%B6%E8%BD%BD%E5%85%A5%E7%BA%B9%E7%90%86"><span class="toc-number">5.4.</span> <span class="toc-text"> 从文件载入纹理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%B9%E7%90%86%E5%9D%90%E6%A0%87"><span class="toc-number">5.4.1.</span> <span class="toc-text"> 纹理坐标</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E7%BA%B9%E7%90%86%E6%95%B0%E6%8D%AE%E7%9A%84%E8%AF%BB%E5%8F%96%E6%96%B9%E5%BC%8F"><span class="toc-number">5.5.</span> <span class="toc-text"> 控制纹理数据的读取方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%B9%E7%90%86%E8%BF%87%E6%BB%A4"><span class="toc-number">5.5.1.</span> <span class="toc-text"> 纹理过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E6%B8%90%E8%BF%9C%E7%BA%B9%E7%90%86mipmap"><span class="toc-number">5.5.2.</span> <span class="toc-text"> 多级渐远纹理（mipmap）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E7%BB%95%E6%96%B9%E5%BC%8F"><span class="toc-number">5.5.3.</span> <span class="toc-text"> 环绕方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E7%BA%B9%E7%90%86"><span class="toc-number">5.6.</span> <span class="toc-text"> 数组纹理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E7%9D%80%E8%89%B2%E5%99%A8%E4%B8%AD%E5%90%91%E7%BA%B9%E7%90%86%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">5.7.</span> <span class="toc-text"> 在着色器中向纹理写入数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-image-%E5%8F%98%E9%87%8F%E4%B8%8A%E7%9A%84%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="toc-number">5.8.</span> <span class="toc-text"> 在 image 变量上的原子操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%AD%98%E5%8F%96%E5%9B%BE%E5%83%8F"><span class="toc-number">5.9.</span> <span class="toc-text"> 同步存取图像</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        OpenGL超级宝典第七版学习笔记 (5)：数据
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">yilozt</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-01-23T05:35:55.000Z" itemprop="datePublished">2022-01-23</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="../../../../categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="../../../../tags/OpenGL/" rel="tag">OpenGL</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>这是自己阅读 OpenGL 超级宝典（第七版）的笔记，使用 Rust 学习书上的示例。点击代码块上的眼睛按钮 <i class="far fa-eye"></i> 可以展开代码，点击复制按钮 <i class="far fa-clone"></i> 可以复制完整代码。</p>
<ul>
<li>随书源码：<a target="_blank" rel="noopener" href="https://github.com/openglsuperbible/sb7code">https://github.com/openglsuperbible/sb7code</a></li>
<li>demo： <a target="_blank" rel="noopener" href="https://github.com/yilozt/sb7coders">https://github.com/yilozt/sb7coders</a></li>
</ul>
<p>第五章主要介绍了 OpenGL 中两种重要的数据形式：缓冲（Buffer）和纹理（Texture）：</p>
<ul>
<li>缓冲：OpenGL 里最常用的、用来存储数据的容器，可以类比成 C 里使用 malloc() 分配的一块空间，常用来存储模型的顶点数据。里面的数据线性存储，类似于一维数组。</li>
<li>纹理：用来存储多维的数据结构。最常见的应该就是 2D 纹理了，用来当作模型的贴图。</li>
</ul>
<h2 id="缓冲"><a class="markdownIt-Anchor" href="#缓冲"></a> 缓冲</h2>
<p>一般用来存储顶点数据，然后作为顶点着色器的输入。也可以作为一般容器，用来在 OpenGL 程序和着色器之间传递数据。</p>
<h3 id="创建缓冲区对象-分配空间"><a class="markdownIt-Anchor" href="#创建缓冲区对象-分配空间"></a> 创建缓冲区对象 / 分配空间</h3>
<p>一般使用 <code>glCreateBuffers() / glGenBuffers()</code>，这两个函数功能、原型相同：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glCreateBuffers</span> <span class="params">(GLsizei n, GLuint *buffers)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">glGenBuffers</span>    <span class="params">(GLsizei n, GLuint *buffers)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>第一个参数 <code>n</code> 为要创建 buffer 对象的个数，也就是说这个函数可以一次性创建多个缓冲区对象</li>
<li>第二个参数是一个 <code>GLuint</code> 类型的指针，用来存储返回的缓冲区对象</li>
</ul>
<p>创建单个缓冲区对象：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br></pre></td></tr></table></figure>
<p>创建多个缓冲区对象，第二个参数传一个数组：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = [<span class="number">0u32</span>; <span class="number">3</span>];</span><br><span class="line">gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">3</span>, buf.<span class="title function_ invoke__">as_mut_ptr</span>());  </span><br></pre></td></tr></table></figure>
<p>OpenGL 里使用 GLuint 变量来代表通过 <code>glCreate...() / glGen...()</code> 创建的对象。</p>
<p>创建缓冲区对象之后，可以通过 <code>glBindBuffer()</code> 将对象绑定到当前 OpenGL 环境中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glBindBuffer</span><span class="params">(GLenum target, GLuint buffer)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>target</code> 称为绑定点（靶点）
<ul>
<li>最常用的 target 应该就是 <code>GL_ARRAY_BUFFER</code> 了，用来将缓冲区作为顶点着色器的输入</li>
</ul>
</li>
<li><code>buffer</code> 类型是 GLuint， 即之前 <code>glCreate...() / glGen...()</code> 返回的 GLuint 变量（创建的对象）</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);  </span><br><span class="line">gl::<span class="title function_ invoke__">BindBuffer</span>(gl::ARRAY_BUFFER, buf);</span><br></pre></td></tr></table></figure>
<p>到这里只是创建和绑定了一个缓冲区，实际上还没有分配空间:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">size</span> = -<span class="number">1</span>;</span><br><span class="line">gl::<span class="title function_ invoke__">GetNamedBufferParameteriv</span>(buf, gl::BUFFER_SIZE, &amp;<span class="keyword">mut</span> size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// size of buffer: 0 bytes</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;size of buffer: &#123;&#125; bytes&quot;</span>, size);</span><br></pre></td></tr></table></figure>
<p>分配空间的操作主要是通过 <code>gl[Named]BufferStorage()</code> 来完成：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glBufferStorage</span><span class="params">(GLenum target,</span></span><br><span class="line"><span class="params">                     GLsizeiptr size,</span></span><br><span class="line"><span class="params">                     <span class="type">const</span> GLvoid * data,</span></span><br><span class="line"><span class="params">                     GLbitfield flags)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">glNamedBufferStorage</span><span class="params">(GLuint buffer,</span></span><br><span class="line"><span class="params">                          GLsizei size,</span></span><br><span class="line"><span class="params">                          <span class="type">const</span> <span class="type">void</span> *data,</span></span><br><span class="line"><span class="params">                          GLbitfield flags)</span>;</span><br></pre></td></tr></table></figure>
<p>只是第一个参数不同，<code>glBufferStorage()</code> 传入的是缓冲区的绑定点，而 <code>glNamedBufferStorage()</code> 传入缓冲区对象本身。代表缓冲区对象的 GLuint 变量称为对象的<strong>名称</strong>(name)</p>
<ul>
<li><code>size</code>：分配多少内存，以字节为单位</li>
<li><code>data</code>：用来初始化（复制到） buffer 的数据，可以传递 null，这样就不会复制任何数据，如果要传入 data 对 buffer 进行初始化，<code>data</code> 的大小必须大于等于 <code>size</code> 字节</li>
<li><code>flags</code>：只起到给 OpenGL 提供信息的作用，让 OpenGL 分配符合预期的内存</li>
</ul>
<p>在分配内存后，无法再修改缓冲区的 size 和 flag 属性。只能将缓冲区销毁后重新创建。</p>
<p>给缓冲区分配 100MB 的内存空间:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span>;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">buf_test</span>() &#123;</span><br><span class="line">  <span class="keyword">use</span> std::ptr::null;</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 100MB = 100 * 1024 * 1024 Btye</span></span><br><span class="line">  <span class="keyword">let</span> <span class="variable">size</span> = <span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">#   <span class="built_in">println!</span>(<span class="string">&quot;Press any key to alloc storage...&quot;</span>);</span><br><span class="line">#   std::io::<span class="title function_ invoke__">stdin</span>().<span class="title function_ invoke__">read_line</span>(&amp;<span class="keyword">mut</span> <span class="type">String</span>::<span class="title function_ invoke__">new</span>()).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"># </span><br><span class="line">  gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line">  gl::<span class="title function_ invoke__">NamedBufferStorage</span>(buf, size <span class="keyword">as</span> _, <span class="title function_ invoke__">null</span>(), gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line"># </span><br><span class="line">#   <span class="built_in">println!</span>(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="title function_ invoke__">buf_test</span>();</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App.<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>调用 <code>glNamedBufferStorage()</code> 之前用 <code>nvidia-smi</code> 命令查询显存：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                  |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span><br><span class="line">|        ID   ID                                                   Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|    0   N/A  N/A      3035      G   target/debug/test                   2MiB |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>调用 <code>glNamedBufferStorage()</code> 之后用 <code>nvidia-smi</code> 命令查询显存：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                  |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span><br><span class="line">|        ID   ID                                                   Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|    0   N/A  N/A      3035      G   target/debug/test                 102MiB |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>显存占用从 2M 增加到了 102M，说明缓冲区对象的存储空间其实是分配内显存里的。</p>
<p>如果要使用 <code>glBufferStorage()</code> 的话就需要将缓冲区绑定到靶点上：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::ptr::null;</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 100MB = 100 * 1024 * 1024 Btye</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">size</span> = <span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line">gl::<span class="title function_ invoke__">BindBuffer</span>(gl::ARRAY_BUFFER, buf)</span><br><span class="line">gl::<span class="title function_ invoke__">BufferStorage</span>(gl::ARRAY_BUFFER, buf, size <span class="keyword">as</span> _, <span class="title function_ invoke__">null</span>(),</span><br><span class="line">                  gl::DYNAMIC_STORAGE_BIT);</span><br></pre></td></tr></table></figure>
<p>这两种方法功能一致。</p>
<p><code>gl[Named]BufferStorage()</code> 的 <code>flag</code> 参数可能的取值：</p>
<table>
<thead>
<tr>
<th style="text-align:left">标志</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GL_DYNAMIC_STORAGE_BIT</td>
<td style="text-align:left">可以直接更新缓冲区的数据</td>
</tr>
<tr>
<td style="text-align:left">GL_MAP_READ_BIT</td>
<td style="text-align:left">缓冲区映射时，可以通过指针读取缓冲</td>
</tr>
<tr>
<td style="text-align:left">GL_MAP_WRITE_BIT</td>
<td style="text-align:left">缓冲区映射时，可以通过指针写入缓存</td>
</tr>
<tr>
<td style="text-align:left">GL_MAP_PERSISTENT_BIT</td>
<td style="text-align:left">在绘制内容时保持缓冲区映射（持久映射）</td>
</tr>
<tr>
<td style="text-align:left">GL_MAP_COHERENT_BIT</td>
<td style="text-align:left">缓冲区映射图是连贯的</td>
</tr>
<tr>
<td style="text-align:left">GL_CLIENT_STORAGE_BIT</td>
<td style="text-align:left">优先将缓冲区的存储空间分配到应用内存上，而不是在显存上分配</td>
</tr>
</tbody>
</table>
<p>OpenGL 在执行绘制命令（<code>glDraw...()</code>）时会结束缓冲区映射，设置 <code>GL_MAP_PERSISTENT_BIT</code> 则可以一直保持映射状态，会牺牲一定性能。</p>
<p>GL_MAP_CORCORMENT_BIT 表示缓存区在 CPU 和 GPU 之间映射是密切相关的，保证了在 CPU 或 GPU 对缓冲区的写入效果最终会对另一方可见，而不需要应用程序进一步干预。如果不设置这个标志位，只有在结束缓冲区映射或者调用 <code>glFlushMappedBufferRange() / glMemoryBarrier()</code> 来应用更改。</p>
<h3 id="更新缓冲区的内容"><a class="markdownIt-Anchor" href="#更新缓冲区的内容"></a> 更新缓冲区的内容</h3>
<p><code>gl[Named]BufferSubData()</code> 用来将数据写入缓冲区（内存 -&gt; 显存）<br />
需要将 <code>GL_DYNAMIC_STORAGE_BIT</code> 写入 <code>gl[Named]BufferStorage()</code> 的 flag 参数里：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glBufferSubData</span><span class="params">(GLenum target,</span></span><br><span class="line"><span class="params">                     GLintptr offset,</span></span><br><span class="line"><span class="params">                     GLsizeiptr size,</span></span><br><span class="line"><span class="params">                     <span class="type">const</span> GLvoid * data)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">glNamedBufferSubData</span><span class="params">(GLuint buffer,</span></span><br><span class="line"><span class="params">                          GLintptr offset,</span></span><br><span class="line"><span class="params">                          GLsizei size,</span></span><br><span class="line"><span class="params">                          <span class="type">const</span> <span class="type">void</span> *data)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>offset</code> 表示要写入的起始位置，以字节为单位</li>
<li><code>size</code> 表示要写入多大的数据，以字节为单位</li>
</ul>
<p>向缓冲区写入一组三角形的顶点数据：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::mem::size_of_val;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::null;</span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span>;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">buf_test</span>() &#123;</span><br><span class="line">#   <span class="comment">// 创建 buffer</span></span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">  gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line">  gl::<span class="title function_ invoke__">BindBuffer</span>(gl::ARRAY_BUFFER, buf);</span><br><span class="line"># </span><br><span class="line">#   <span class="comment">// 分配 1 KB 空间</span></span><br><span class="line">#   <span class="comment">// 毕竟要更新 buffer 的内容，传入 DYNAMIC_STORAGE_BIT</span></span><br><span class="line">#   gl::<span class="title function_ invoke__">BufferStorage</span>(gl::ARRAY_BUFFER, <span class="number">1024</span>, <span class="title function_ invoke__">null</span>(), gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line"># </span><br><span class="line">#   <span class="comment">// 三角形的顶点数据</span></span><br><span class="line">  <span class="keyword">let</span> <span class="variable">data</span> = [</span><br><span class="line">     <span class="number">0.25</span>, -<span class="number">0.25</span>, <span class="number">0.5</span>, <span class="number">1.0</span>,</span><br><span class="line">    -<span class="number">0.25</span>, -<span class="number">0.25</span>, <span class="number">0.5</span>, <span class="number">1.0</span>,</span><br><span class="line">     <span class="number">0.25</span>,  <span class="number">0.25</span>, <span class="number">0.5</span>, <span class="number">1.0</span></span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将顶点数据传入 buffer</span></span><br><span class="line">  gl::<span class="title function_ invoke__">BufferSubData</span>(gl::ARRAY_BUFFER, <span class="number">0</span>,</span><br><span class="line">                    <span class="title function_ invoke__">size_of_val</span>(&amp;data) <span class="keyword">as</span> _,</span><br><span class="line">                    data.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _);</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="title function_ invoke__">buf_test</span>();</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App.<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>也可以通过<strong>缓冲区映射</strong>，将存储在显卡的缓冲区映射到 OpenGL 应用程序的内存上，这样就可以通过指针直接写入缓冲区：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::null;</span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span>;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line">      gl::<span class="title function_ invoke__">NamedBufferStorage</span>(buf, <span class="number">1024</span> * <span class="number">1024</span>, <span class="title function_ invoke__">null</span>(), gl::MAP_READ_BIT);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">let</span> <span class="variable">data</span> = [ <span class="number">0.25</span>, -<span class="number">0.25</span>, <span class="number">0.5</span>, <span class="number">1.0</span>,</span><br><span class="line">                  -<span class="number">0.25</span>, -<span class="number">0.25</span>, <span class="number">0.5</span>, <span class="number">1.0</span>,</span><br><span class="line">                   <span class="number">0.25</span>,  <span class="number">0.25</span>, <span class="number">0.5</span>, <span class="number">1.0</span>, ];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> <span class="variable">ptr</span> = gl::<span class="title function_ invoke__">MapNamedBuffer</span>(buf, gl::WRITE_ONLY);</span><br><span class="line"># </span><br><span class="line">#       <span class="comment">// 缓冲区映射失败时返回 null</span></span><br><span class="line">#       <span class="built_in">assert_ne!</span>(ptr <span class="keyword">as</span> <span class="type">usize</span>, <span class="number">0</span>, <span class="string">&quot;buf map to null&quot;</span>);</span><br><span class="line"></span><br><span class="line">      std::ptr::<span class="title function_ invoke__">copy</span>(data.<span class="title function_ invoke__">as_ptr</span>(), ptr <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f64</span>, data.<span class="title function_ invoke__">len</span>());</span><br><span class="line">      gl::<span class="title function_ invoke__">UnmapNamedBuffer</span>(buf);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App.<span class="title function_ invoke__">run</span>();</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>对应的原型如下，<code>gl[Named]MapBuffer()</code> 用来将缓冲区映射到内存上，<code>gl[Named]UnmapBuffer()</code> 用来结束缓冲区映射：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">glMapBuffer</span><span class="params">(GLenum target,</span></span><br><span class="line"><span class="params">                  GLenum access)</span>;</span><br><span class="line"><span class="type">void</span> *<span class="title function_">glMapNamedBuffer</span><span class="params">(GLuint buffer,</span></span><br><span class="line"><span class="params">	                     GLenum access)</span>;</span><br><span class="line"></span><br><span class="line">GLboolean <span class="title function_">glUnmapBuffer</span><span class="params">(GLenum target)</span>;</span><br><span class="line">GLboolean <span class="title function_">glUnmapNamedBuffer</span><span class="params">(GLuint buffer)</span>;</span><br></pre></td></tr></table></figure>
<p><code>access</code> 有三种取值：<code>GL_READ_ONLY</code>，<code>GL_WRITE_ONLY</code>，<code>GL_READ_WRITE</code><br />
对应 <code>gl[Named]BufferStorage()</code> 的 flag 参数：<code>GL_MAP_READ_BIT</code>， <code>GL_MAP_WRITE_BIT</code></p>
<p>将 Hello World 写入缓冲区，然后再读取到内存：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::mem::size_of_val <span class="keyword">as</span> sizeof;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::null;</span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span>;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferStorage</span>(buf,</span><br><span class="line">#                              <span class="number">1024</span> * <span class="number">1024</span>,</span><br><span class="line">#                              <span class="title function_ invoke__">null</span>(),</span><br><span class="line">#                              gl::MAP_READ_BIT | gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">str</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">        <span class="type">str</span>.<span class="title function_ invoke__">resize</span>(<span class="number">100</span>, <span class="number">0</span>);</span><br><span class="line">        gl::<span class="title function_ invoke__">NamedBufferSubData</span>(buf, <span class="number">0</span>, <span class="title function_ invoke__">sizeof</span>(&amp;<span class="type">str</span>[..]) <span class="keyword">as</span> _,</span><br><span class="line">                               <span class="type">str</span>.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> <span class="variable">str</span> = &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">str</span> = [<span class="number">0u8</span>; <span class="number">100</span>];</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr</span> = gl::<span class="title function_ invoke__">MapNamedBuffer</span>(buf, gl::READ_ONLY);</span><br><span class="line">        <span class="built_in">assert_ne!</span>(ptr <span class="keyword">as</span> <span class="type">usize</span>, <span class="number">0</span>, <span class="string">&quot;buf map to null&quot;</span>);</span><br><span class="line"># </span><br><span class="line">        std::ptr::<span class="title function_ invoke__">copy</span>(ptr <span class="keyword">as</span> _, <span class="type">str</span>.<span class="title function_ invoke__">as_mut_ptr</span>(), <span class="number">100</span>);</span><br><span class="line">#         </span><br><span class="line">        gl::<span class="title function_ invoke__">UnmapNamedBuffer</span>(buf);</span><br><span class="line">        <span class="type">str</span></span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// [Hello World]</span></span><br><span class="line">      <span class="built_in">println!</span>(<span class="string">&quot;[&#123;&#125;]&quot;</span>,</span><br><span class="line">               std::<span class="type">str</span>::<span class="title function_ invoke__">from_utf8</span>(&amp;<span class="type">str</span>).<span class="title function_ invoke__">unwrap_or</span>(<span class="string">&quot;err&quot;</span>)</span><br><span class="line">                                        .<span class="title function_ invoke__">trim_matches</span>(&#x27;\u&#123;<span class="number">0</span>&#125;&#x27;));</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App.<span class="title function_ invoke__">run</span>();</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p><code>glMap[Named]Buffer()</code> 映射的是整个缓冲区，如果缓冲区越大，缓冲区映射的开销就越高。也可以通过下面的函数来映射特定范围的缓冲区：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">glMapBufferRange</span><span class="params">(GLenum target,</span></span><br><span class="line"><span class="params">                       GLintptr offset,</span></span><br><span class="line"><span class="params">                       GLsizeiptr length,</span></span><br><span class="line"><span class="params">                       GLbitfield access)</span>;</span><br><span class="line"><span class="type">void</span> *<span class="title function_">glMapNamedBufferRange</span><span class="params">(GLuint buffer,</span></span><br><span class="line"><span class="params">                            GLintptr offset,</span></span><br><span class="line"><span class="params">                            GLsizei length,</span></span><br><span class="line"><span class="params">                            GLbitfield access)</span>;</span><br></pre></td></tr></table></figure>
<p><code>access</code> 是标志位，可以的取值：</p>
<table>
<thead>
<tr>
<th style="text-align:left">标志</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GL_MAP_READ_BIT</td>
<td style="text-align:left">可以通过缓冲区映射读取</td>
</tr>
<tr>
<td style="text-align:left">GL_MAP_WRITE_BIT</td>
<td style="text-align:left">可以通过缓冲区映射写入</td>
</tr>
<tr>
<td style="text-align:left">GL_MAP_PERSISTENT_BIT</td>
<td style="text-align:left">持久映射</td>
</tr>
<tr>
<td style="text-align:left">GL_MAP_COHERENT_BIT</td>
<td style="text-align:left">缓冲映射图是连贯的</td>
</tr>
<tr>
<td style="text-align:left">GL_MAP_INVALIDATE_RANGE_BIT</td>
<td style="text-align:left">表示我们不再关心范围内数据，与 GL_MAP_READ_BIT 冲突</td>
</tr>
<tr>
<td style="text-align:left">GL_MAP_INVALIDATE_BUFFER_BIT</td>
<td style="text-align:left">表示我们不再关心整个缓冲区内的数据，与 GL_MAP_READ_BIT 冲突</td>
</tr>
<tr>
<td style="text-align:left">GL_MAP_FLUSH_EXPLICIT_BIT</td>
<td style="text-align:left">表示我们会在映射范围内修改数据</td>
</tr>
<tr>
<td style="text-align:left">GL_MAP_UNSYNCHRONIZED_BIT</td>
<td style="text-align:left">表示我们会自己会自己执行所有的同步</td>
</tr>
</tbody>
</table>
<p>其中 <code>GL_MAP_READ_BIT</code>、<code>GL_MAP_WRITE_BIT</code>、<code>GL_MAP_PERSISTENT_BIT</code>、<code>GL_MAP_COHERENT_BIT</code> 必须和 <code>gl[Named]BufferStorage</code> 的 <code>flag</code> 相匹配，其作用相同。</p>
<ul>
<li><code>GL_MAP_INVALIDATE_RANGE_BIT</code>：在映射范围之前的数据可能会丢弃，而映射到 CPU 的那段缓冲区将会被擦除</li>
<li><code>GL_MAP_INVALIDATE_BUFFER_BIT</code>：在将缓冲区映射到 CPU 时，缓冲区内所有数据将被擦除</li>
</ul>
<p>这里使用 0xFF 初始化缓冲区，再缓冲区内 15~45 字节 以 <code>GL_MAP_INVALIDATE_RANGE_BIT | GL_MAP_WRITE_BIT</code> 映射到 CPU：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::mem::size_of_val <span class="keyword">as</span> sizeof;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::null;</span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span>;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">print_buf</span>(buf: [<span class="type">u8</span>; <span class="number">15</span> * <span class="number">6</span>]) &#123;</span><br><span class="line">#   <span class="keyword">for</span> <span class="variable">j</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">6</span> &#123;</span><br><span class="line">#     <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">15</span> &#123;</span><br><span class="line">#       <span class="built_in">print!</span>(<span class="string">&quot;&#123;:-02X&#125;, &quot;</span>, buf[j * <span class="number">15</span> + i])</span><br><span class="line">#     &#125;</span><br><span class="line">#     <span class="built_in">println!</span>()</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferStorage</span>(buf,</span><br><span class="line">#                              <span class="number">15</span> * <span class="number">6</span>,</span><br><span class="line">#                              <span class="title function_ invoke__">null</span>(),</span><br><span class="line">#                              gl::MAP_READ_BIT | gl::MAP_WRITE_BIT |</span><br><span class="line">#                              gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line">#       &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">data</span> = [<span class="number">255u8</span>; <span class="number">15</span> * <span class="number">6</span>];</span><br><span class="line">        gl::<span class="title function_ invoke__">NamedBufferSubData</span>(buf, <span class="number">0</span>, <span class="title function_ invoke__">sizeof</span>(&amp;data) <span class="keyword">as</span> _,</span><br><span class="line">                               data.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _);</span><br><span class="line">#       &#125;</span><br><span class="line">#       &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr</span> = gl::<span class="title function_ invoke__">MapNamedBufferRange</span>(buf, <span class="number">15</span>, <span class="number">30</span>,</span><br><span class="line">                                          gl::MAP_WRITE_BIT |</span><br><span class="line">                                          gl::MAP_INVALIDATE_BUFFER_BIT);</span><br><span class="line">        <span class="built_in">assert_ne!</span>(ptr <span class="keyword">as</span> <span class="type">usize</span>, <span class="number">0</span>, <span class="string">&quot;MapNamedBufferRange() failed&quot;</span>);</span><br><span class="line">        gl::<span class="title function_ invoke__">UnmapNamedBuffer</span>(buf);</span><br><span class="line">#       &#125;</span><br><span class="line">#       &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr</span> = gl::<span class="title function_ invoke__">MapNamedBuffer</span>(buf, gl::READ_ONLY);</span><br><span class="line">#         <span class="built_in">assert_ne!</span>(ptr <span class="keyword">as</span> <span class="type">usize</span>, <span class="number">0</span>, <span class="string">&quot;MapBuffer() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">read</span> = [<span class="number">0u8</span>; <span class="number">15</span> * <span class="number">6</span>];</span><br><span class="line">        std::ptr::<span class="title function_ invoke__">copy</span>(ptr <span class="keyword">as</span> _, read.<span class="title function_ invoke__">as_mut_ptr</span>(), <span class="number">120</span>);</span><br><span class="line"># </span><br><span class="line">        gl::<span class="title function_ invoke__">UnmapNamedBuffer</span>(buf);</span><br><span class="line"># </span><br><span class="line">        <span class="title function_ invoke__">print_buf</span>(read);</span><br><span class="line">#       &#125;</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App.<span class="title function_ invoke__">run</span>();</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p><code>print_buf()</code> 输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF </span><br><span class="line">00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 </span><br><span class="line">00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 </span><br><span class="line">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF </span><br><span class="line">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF </span><br><span class="line">FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF</span><br></pre></td></tr></table></figure>
<p>在缓冲区映射的时候那段内存已经被清零了。如果给 <code>Map[Named]BufferRange()</code> 传入 <code>MAP_INVALIDATE_BUFFER_BIT</code>，那么整个缓冲区在映射时会被清零</p>
<h3 id="填充数据-缓冲区间复制数据"><a class="markdownIt-Anchor" href="#填充数据-缓冲区间复制数据"></a> 填充数据、缓冲区间复制数据</h3>
<p>填充数据<sub>作者在整本书里就没有用过这个函数</sub>……：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glClearBufferSubData</span><span class="params">(GLenum target,</span></span><br><span class="line"><span class="params">                          GLenum internalformat,</span></span><br><span class="line"><span class="params">                          GLintptr offset,</span></span><br><span class="line"><span class="params">                          GLsizeiptr size,</span></span><br><span class="line"><span class="params">                          GLenum format,</span></span><br><span class="line"><span class="params">                          GLenum type,</span></span><br><span class="line"><span class="params">                          <span class="type">const</span> <span class="type">void</span> * data)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">glClearNamedBufferSubData</span><span class="params">(GLuint buffer,</span></span><br><span class="line"><span class="params">                               GLenum internalformat,</span></span><br><span class="line"><span class="params">                               GLintptr offset,</span></span><br><span class="line"><span class="params">                               GLsizei size,</span></span><br><span class="line"><span class="params">                               GLenum format,</span></span><br><span class="line"><span class="params">                               GLenum type,</span></span><br><span class="line"><span class="params">                               <span class="type">const</span> <span class="type">void</span> *data)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>size</code>, <code>offset</code>：填充区域，字节为单位</li>
<li><code>type</code> <code>format</code> 说明指向 <code>data</code> 的数据的信息</li>
<li><code>type</code>: 传入的数据类型，取值和对应的数据类型：
<table>
<thead>
<tr>
<th style="text-align:left">type</th>
<th style="text-align:left">对应的 OpenGL 类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GL_BYTE</td>
<td style="text-align:left">GLchar</td>
</tr>
<tr>
<td style="text-align:left">GL_UNSIGNED_BYTE</td>
<td style="text-align:left">GLuchar</td>
</tr>
<tr>
<td style="text-align:left">GL_SHORT</td>
<td style="text-align:left">GLshort</td>
</tr>
<tr>
<td style="text-align:left">GL_UNSIGNED_SHORT</td>
<td style="text-align:left">GLushort</td>
</tr>
<tr>
<td style="text-align:left">GL_INT</td>
<td style="text-align:left">GLint</td>
</tr>
<tr>
<td style="text-align:left">GL_UNSIGNED_INT</td>
<td style="text-align:left">GLuint</td>
</tr>
<tr>
<td style="text-align:left">GL_FLOAT</td>
<td style="text-align:left">GLfloat</td>
</tr>
<tr>
<td style="text-align:left">GL_DOUBLE</td>
<td style="text-align:left">GLdouble</td>
</tr>
</tbody>
</table>
</li>
<li><code>format</code>: 传入的数据格式
<ul>
<li><code>RED</code>、<code>GREEN</code>、<code>BLUE</code>、<code>RED_INTEGER</code>、<code>GREEN_INTEGER</code>、<code>BLUE_INTEGER</code></li>
<li><code>RG</code>、<code>RG_INTEGER</code></li>
<li><code>RGB</code>、<code>BGR</code>、<code>RGB_INTEGER</code>、<code>BGR_INTEGER</code></li>
<li><code>RGBA</code>、<code>BGRA</code>、<code>RGBA_INTEGER</code>、<code>BGRA_INTEGER</code></li>
</ul>
</li>
<li><code>internalformat</code>：buffer 内部存储的数据格式，参考 <a target="_blank" rel="noopener" href="https://docs.gl/gl4/glClearBufferSubData">gl4/glClearBufferSubData</a></li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::GLfloat;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::ffi::c_void;</span><br><span class="line"># <span class="keyword">use</span> std::mem::size_of_val;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::null;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">buf_test</span>() &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">recv</span>: [GLfloat; <span class="number">20</span>] = [<span class="number">0.0</span>; <span class="number">20</span>];</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">len</span> = <span class="title function_ invoke__">size_of_val</span>(&amp;recv) <span class="keyword">as</span> <span class="type">isize</span>;</span><br><span class="line"></span><br><span class="line">  gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line">  gl::<span class="title function_ invoke__">NamedBufferStorage</span>(buf, len, <span class="title function_ invoke__">null</span>(),</span><br><span class="line">                         gl::MAP_READ_BIT | gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 填充数据</span></span><br><span class="line">  <span class="keyword">let</span> <span class="variable">d</span>: [GLfloat; <span class="number">4</span>] = [<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>];</span><br><span class="line">  gl::<span class="title function_ invoke__">ClearNamedBufferSubData</span>(</span><br><span class="line">    buf,</span><br><span class="line">    gl::RGBA32F, <span class="comment">// 内部存储格式 https://docs.gl/gl4/glClearBufferSubData</span></span><br><span class="line">    <span class="number">0</span>,           <span class="comment">// 偏移量</span></span><br><span class="line">    len,         <span class="comment">// 填充长度</span></span><br><span class="line">    gl::RGBA,    <span class="comment">// data 格式, 如果是整形: gl::RGBA_INTEGER</span></span><br><span class="line">#                  <span class="comment">//  - 参见：https://github.com/d-scott-phillips/piglit/blob/2ada920d5702aa86853066559e7f941f8f5f37f2/tests/spec/arb_sparse_buffer/commit.c#L138</span></span><br><span class="line">    gl::FLOAT,   <span class="comment">// data 数据类型</span></span><br><span class="line">    d.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> c_void);</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">let</span> <span class="variable">handler</span> = gl::<span class="title function_ invoke__">MapNamedBuffer</span>(buf, gl::READ_ONLY);</span><br><span class="line">#   std::intrinsics::<span class="title function_ invoke__">copy</span>(handler <span class="keyword">as</span> *<span class="keyword">const</span> GLfloat, recv.<span class="title function_ invoke__">as_mut_ptr</span>(), recv.<span class="title function_ invoke__">len</span>());</span><br><span class="line">#   gl::<span class="title function_ invoke__">UnmapNamedBuffer</span>(buf);</span><br><span class="line"># </span><br><span class="line">  <span class="comment">// 1.0, 2.0, 3.0, 4.0, 1.0, 2.0, ...</span></span><br><span class="line">#   <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, recv);</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>在缓冲区之间复制，类似于 C 里的 <code>memcpy()</code> 或者 <code>strcpy()</code>（Rust 里对应<code>std::intrinsics::copy</code>）:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glCopyBufferSubData</span><span class="params">(GLenum readTarget,</span></span><br><span class="line"><span class="params">                         GLenum writeTarget,</span></span><br><span class="line"><span class="params">                         GLintptr readOffset,</span></span><br><span class="line"><span class="params">                         GLintptr writeOffset,</span></span><br><span class="line"><span class="params">                         GLsizeiptr size)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">glCopyNamedBufferSubData</span><span class="params">(GLuint readBuffer,</span></span><br><span class="line"><span class="params">                              GLuint writeBuffer,</span></span><br><span class="line"><span class="params">                              GLintptr readOffset,</span></span><br><span class="line"><span class="params">                              GLintptr writeOffset,</span></span><br><span class="line"><span class="params">                              GLsizei size)</span>;</span><br></pre></td></tr></table></figure>
<p><code>glCopyBufferSubData()</code> 需要两个不同的绑定点。 openGL 也提供了 GL_COPY_READ_BUFFER 和 GL_COPY_WRITE_BUFFER 这两个靶点，这时候就可以用上了。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::ffi::c_void;</span><br><span class="line"># <span class="keyword">use</span> std::intrinsics::copy;</span><br><span class="line"># <span class="keyword">use</span> std::mem::size_of_val;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::null;</span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span>;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">buf_test</span>() &#123;</span><br><span class="line">#   <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">bufs</span> = [<span class="number">0</span>; <span class="number">2</span>];</span><br><span class="line">#   gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">2</span>, bufs.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#   <span class="keyword">let</span> [read, write] = bufs;</span><br><span class="line"># </span><br><span class="line">  <span class="keyword">let</span> <span class="variable">str</span> = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">len</span> = <span class="title function_ invoke__">size_of_val</span>(&amp;<span class="type">str</span>) <span class="keyword">as</span> <span class="type">isize</span>;</span><br><span class="line">  gl::<span class="title function_ invoke__">NamedBufferStorage</span>(read, len, <span class="type">str</span>.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> c_void, </span><br><span class="line">                         gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line">  gl::<span class="title function_ invoke__">NamedBufferStorage</span>(write, len, <span class="title function_ invoke__">null</span>(),</span><br><span class="line">                         gl::DYNAMIC_STORAGE_BIT | gl::MAP_READ_BIT);</span><br><span class="line"></span><br><span class="line">  gl::<span class="title function_ invoke__">CopyNamedBufferSubData</span>(read, write, <span class="number">0</span>, <span class="number">0</span>, len);</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">recv</span> = [<span class="number">0u8</span>; <span class="number">1024</span>];</span><br><span class="line">#   <span class="keyword">let</span> <span class="variable">read_handler</span> = gl::<span class="title function_ invoke__">MapNamedBuffer</span>(write, gl::READ_ONLY);</span><br><span class="line">#   <span class="title function_ invoke__">copy</span>(read_handler <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u8</span>, recv.<span class="title function_ invoke__">as_mut_ptr</span>(), <span class="type">str</span>.<span class="title function_ invoke__">len</span>());</span><br><span class="line">#   gl::<span class="title function_ invoke__">UnmapNamedBuffer</span>(write);</span><br><span class="line">#   <span class="keyword">let</span> <span class="variable">recv</span> = std::<span class="type">str</span>::<span class="title function_ invoke__">from_utf8</span>(&amp;recv).<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">trim_matches</span>(&#x27;\u&#123;<span class="number">0</span>&#125;&#x27;);</span><br><span class="line">#   <span class="built_in">assert_eq!</span>(recv, <span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="title function_ invoke__">buf_test</span>();</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App.<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<h3 id="将缓冲区作为顶点着色器的输入"><a class="markdownIt-Anchor" href="#将缓冲区作为顶点着色器的输入"></a> 将缓冲区作为顶点着色器的输入</h3>
<p>顶点着色器的输入——顶点数组对象(vao)，用来存储顶点数组的状态，可以绑定多个缓冲区，将缓冲区的内容传入顶点着色器。创建 vao：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::GLuint;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::ffi::&#123;c_void, CString&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::mem::&#123;size_of_val, size_of&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::null;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   vao: GLuint,</span><br><span class="line">#   bufs: [GLuint; <span class="number">2</span>],</span><br><span class="line">#   program: GLuint</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="comment">// 顶点属性</span></span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">position</span> = [ -<span class="number">0.5</span>, -<span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, </span><br><span class="line">#                       <span class="number">0.5</span>, -<span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#                       <span class="number">0.0</span>,  <span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">1.0f32</span>,];</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">color</span> = [ <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#                   <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#                   <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">1.0f32</span>, ];</span><br><span class="line"># </span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 创建 vao</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vao</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> vao);</span><br><span class="line">      gl::<span class="title function_ invoke__">BindVertexArray</span>(vao);</span><br><span class="line">    &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 创建 buffer，初始化 buffer</span></span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">bufs</span> = [<span class="number">0</span>; <span class="number">2</span>];</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">2</span>, bufs.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindBuffer</span>(gl::VERTEX_ARRAY, bufs[<span class="number">0</span>]);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindBuffer</span>(gl::VERTEX_ARRAY, bufs[<span class="number">1</span>]);</span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferStorage</span>(bufs[<span class="number">0</span>], <span class="title function_ invoke__">size_of_val</span>(&amp;position) <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">#                              position.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> c_void,</span><br><span class="line">#                              gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferStorage</span>(bufs[<span class="number">1</span>], <span class="title function_ invoke__">size_of_val</span>(&amp;color) <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">#                              color.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> c_void,</span><br><span class="line">#                              gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line"># </span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 绑定 buffer 与 vao</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayVertexBuffer</span>(vao, <span class="number">0</span>, bufs[<span class="number">0</span>], <span class="number">0</span>,</span><br><span class="line">#                                   (size_of::&lt;<span class="type">f32</span>&gt;() * <span class="number">4</span>) <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayVertexBuffer</span>(vao, <span class="number">1</span>, bufs[<span class="number">1</span>], <span class="number">0</span>,</span><br><span class="line">#                                   (size_of::&lt;<span class="type">f32</span>&gt;() * <span class="number">4</span>) <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 设置顶点属性对应的 buffer</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribBinding</span>(vao, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribBinding</span>(vao, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 设置顶点属性的格式</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribFormat</span>(vao, <span class="number">0</span>,</span><br><span class="line">#                                   <span class="number">4</span>,</span><br><span class="line">#                                   gl::FLOAT, gl::FALSE, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribFormat</span>(vao, <span class="number">1</span>,</span><br><span class="line">#                                   <span class="number">4</span>,</span><br><span class="line">#                                   gl::FLOAT, gl::FALSE, <span class="number">0</span>);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 启用顶点属性</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">1</span>);  </span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">program</span> = <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="comment">// 创建顶点着色器</span></span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         layout (location = 0) in vec4 position;</span></span><br><span class="line"><span class="string">#         layout (location = 1) in vec4 color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         out vec4 vs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           gl_Position = position;</span></span><br><span class="line"><span class="string">#           vs_color = color;</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::VERTEX_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(vs, <span class="number">1</span>, &amp;vs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(vs);</span><br><span class="line">#       </span><br><span class="line">#       <span class="comment">// 创建片段着色器</span></span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         in vec4 vs_color;</span></span><br><span class="line"><span class="string">#         out vec4 fs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           fs_color = vs_color;</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::FRAGMENT_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(fs, <span class="number">1</span>, &amp;fs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       <span class="comment">// 创建着色器程序</span></span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">program</span> = gl::<span class="title function_ invoke__">CreateProgram</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, fs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">LinkProgram</span>(program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       <span class="comment">// 启用着色器程序</span></span><br><span class="line">#       gl::<span class="title function_ invoke__">UseProgram</span>(program);</span><br><span class="line">#       program</span><br><span class="line">#     &#125;;</span><br><span class="line"># </span><br><span class="line">#     *<span class="keyword">self</span> = <span class="keyword">Self</span> &#123; vao, program, bufs &#125;;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, _current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR,<span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0f32</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">2</span>, <span class="keyword">self</span>.bufs.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vao);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>建立顶点着色器里顶点属性与缓冲区的关系，将 bindingindex 对应的缓冲区作为顶点属性 attribindex 的输入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glVertexArrayAttribBinding</span><span class="params">(GLuint vaobj,</span></span><br><span class="line"><span class="params">                                GLuint attribindex,</span></span><br><span class="line"><span class="params">                                GLuint bindingindex)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>attribindex</code> 顶点属性的位置，可以用 <code>glGetAttribLocation()</code> 查询，或者直接在顶点着色器里指定</li>
<li><code>bindingindex</code> vao绑定的顶点缓冲区下标</li>
</ul>
<p><code>glVertexArrayVertexBuffer()</code> 用来将缓冲区挂载到 vao 上：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glVertexArrayVertexBuffer</span><span class="params">(GLuint vaobj,</span></span><br><span class="line"><span class="params">                               GLuint bindingindex,</span></span><br><span class="line"><span class="params">                               GLuint buffer,</span></span><br><span class="line"><span class="params">                               GLintptr offset,</span></span><br><span class="line"><span class="params">                               GLsizei stride)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>bindingindex</code>: 可以随便设，指定缓冲区在 vao 的位置，和 <code>glVertexArrayAttribBinding()</code> 对应</li>
<li><code>buffer</code>: 要挂载到 vao 的缓冲区</li>
<li><code>offset</code>: 偏移量（起始位置），字节为单位，着色器从哪里开始读入顶点数据</li>
<li><code>stride</code>: 每个顶点数据的大小，字节为单位</li>
</ul>
<p>将两个缓冲区对象挂载到 vao 上，分别作为着色器内两个顶点属性的输入：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::GLuint;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::ffi::&#123;c_void, CString&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::mem::&#123;size_of_val, size_of&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::null;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   vao: GLuint,</span><br><span class="line">#   bufs: [GLuint; <span class="number">2</span>],</span><br><span class="line">#   program: GLuint</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="comment">// 顶点属性</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">position</span> = [ -<span class="number">0.5</span>, -<span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, </span><br><span class="line">                      <span class="number">0.5</span>, -<span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">                      <span class="number">0.0</span>,  <span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">1.0f32</span>,];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">color</span> = [ <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">                  <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">                  <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">1.0f32</span>, ];</span><br><span class="line"># </span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 创建 vao</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vao</span> = <span class="number">0</span>;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> vao);</span><br><span class="line">      gl::<span class="title function_ invoke__">BindVertexArray</span>(vao);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 创建 buffer，初始化 buffer</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">bufs</span> = [<span class="number">0</span>; <span class="number">2</span>];</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">2</span>, bufs.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">      gl::<span class="title function_ invoke__">BindBuffer</span>(gl::VERTEX_ARRAY, bufs[<span class="number">0</span>]);</span><br><span class="line">      gl::<span class="title function_ invoke__">BindBuffer</span>(gl::VERTEX_ARRAY, bufs[<span class="number">1</span>]);</span><br><span class="line">      gl::<span class="title function_ invoke__">NamedBufferStorage</span>(bufs[<span class="number">0</span>], <span class="title function_ invoke__">size_of_val</span>(&amp;position) <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">                             position.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> c_void,</span><br><span class="line">                             gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line">      gl::<span class="title function_ invoke__">NamedBufferStorage</span>(bufs[<span class="number">1</span>], <span class="title function_ invoke__">size_of_val</span>(&amp;color) <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">                             color.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> c_void,</span><br><span class="line">                             gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line"># </span><br><span class="line">#     &#125;</span><br><span class="line"></span><br><span class="line">#     <span class="comment">// 绑定 buffer 与 vao</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayVertexBuffer</span>(vao, <span class="number">0</span>, bufs[<span class="number">0</span>], <span class="number">0</span>,</span><br><span class="line">                                  (size_of::&lt;<span class="type">f32</span>&gt;() * <span class="number">4</span>) <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayVertexBuffer</span>(vao, <span class="number">1</span>, bufs[<span class="number">1</span>], <span class="number">0</span>,</span><br><span class="line">                                  (size_of::&lt;<span class="type">f32</span>&gt;() * <span class="number">4</span>) <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">#     &#125;</span><br><span class="line"></span><br><span class="line">#     <span class="comment">// 设置顶点属性对应的 buffer</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayAttribBinding</span>(vao, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayAttribBinding</span>(vao, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 设置顶点属性的格式</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribFormat</span>(vao, <span class="number">0</span>,</span><br><span class="line">#                                   <span class="number">4</span>,</span><br><span class="line">#                                   gl::FLOAT, gl::FALSE, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribFormat</span>(vao, <span class="number">1</span>,</span><br><span class="line">#                                   <span class="number">4</span>,</span><br><span class="line">#                                   gl::FLOAT, gl::FALSE, <span class="number">0</span>);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 启用顶点属性</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">1</span>);  </span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">program</span> = <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="comment">// 创建顶点着色器</span></span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         layout (location = 0) in vec4 position;</span></span><br><span class="line"><span class="string">#         layout (location = 1) in vec4 color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         out vec4 vs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           gl_Position = position;</span></span><br><span class="line"><span class="string">#           vs_color = color;</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::VERTEX_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(vs, <span class="number">1</span>, &amp;vs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(vs);</span><br><span class="line">#       </span><br><span class="line">#       <span class="comment">// 创建片段着色器</span></span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         in vec4 vs_color;</span></span><br><span class="line"><span class="string">#         out vec4 fs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           fs_color = vs_color;</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::FRAGMENT_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(fs, <span class="number">1</span>, &amp;fs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       <span class="comment">// 创建着色器程序</span></span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">program</span> = gl::<span class="title function_ invoke__">CreateProgram</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, fs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">LinkProgram</span>(program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       <span class="comment">// 启用着色器程序</span></span><br><span class="line">#       gl::<span class="title function_ invoke__">UseProgram</span>(program);</span><br><span class="line">#       program</span><br><span class="line">#     &#125;;</span><br><span class="line"># </span><br><span class="line">#     *<span class="keyword">self</span> = <span class="keyword">Self</span> &#123; vao, program, bufs &#125;;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, _current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR,<span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0f32</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">2</span>, <span class="keyword">self</span>.bufs.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vao);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>在通过 vao 搭建好缓冲区与顶点属性的桥梁之后，还需要给 OpenGL 说明顶点属性的格式（顶点属性由几个元素组成，每个元素的数据类型是什么）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glVertexArrayAttribFormat</span><span class="params">(GLuint vaobj,</span></span><br><span class="line"><span class="params">                               GLuint attribindex,</span></span><br><span class="line"><span class="params">                               GLint size,</span></span><br><span class="line"><span class="params">                               GLenum type,</span></span><br><span class="line"><span class="params">                               GLboolean normalized,</span></span><br><span class="line"><span class="params">                               GLuint relativeoffset)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><code>size</code>: 这个顶点属性由几个数组成：1、2、3、4</p>
</li>
<li>
<p><code>type</code>: 数据类型：GL::FLOAT, GL::UCHAT 等</p>
</li>
<li>
<p><code>normalized</code>: 在传入着色器之前，是否对数据进行正规化处理。浮点数不会进行正规化</p>
<ul>
<li>无符号整数转换成 [0.0~1.0] 的浮点数</li>
<li>有符号整数转换成 [-1.0~1.0] 的浮点数</li>
</ul>
</li>
<li>
<p>relativeoffset： 相对偏移量</p>
<ul>
<li>第 n 个顶点在在缓冲区的读取位置与offset, relativeoffset 的关系：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location = offset + n * stride + relativeoffset</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>之后就可以调用 <code>glEnableVertexArrayAttrub()</code> 来启用之前的配置了：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::GLuint;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::ffi::&#123;c_void, CString&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::mem::&#123;size_of_val, size_of&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::null;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   vao: GLuint,</span><br><span class="line">#   bufs: [GLuint; <span class="number">2</span>],</span><br><span class="line">#   program: GLuint</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="comment">// 顶点属性</span></span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">position</span> = [ -<span class="number">0.5</span>, -<span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, </span><br><span class="line">#                       <span class="number">0.5</span>, -<span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#                       <span class="number">0.0</span>,  <span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">1.0f32</span>,];</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">color</span> = [ <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#                   <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#                   <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">1.0f32</span>, ];</span><br><span class="line"># </span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 创建 vao</span></span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vao</span> = <span class="number">0</span>;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> vao);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindVertexArray</span>(vao);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 创建 buffer，初始化 buffer</span></span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">bufs</span> = [<span class="number">0</span>; <span class="number">2</span>];</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">2</span>, bufs.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindBuffer</span>(gl::VERTEX_ARRAY, bufs[<span class="number">0</span>]);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindBuffer</span>(gl::VERTEX_ARRAY, bufs[<span class="number">1</span>]);</span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferStorage</span>(bufs[<span class="number">0</span>], <span class="title function_ invoke__">size_of_val</span>(&amp;position) <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">#                              position.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> c_void,</span><br><span class="line">#                              gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferStorage</span>(bufs[<span class="number">1</span>], <span class="title function_ invoke__">size_of_val</span>(&amp;color) <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">#                              color.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> c_void,</span><br><span class="line">#                              gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line"># </span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 绑定 buffer 与 vao</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayVertexBuffer</span>(vao, <span class="number">0</span>, bufs[<span class="number">0</span>], <span class="number">0</span>,</span><br><span class="line">#                                   (size_of::&lt;<span class="type">f32</span>&gt;() * <span class="number">4</span>) <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayVertexBuffer</span>(vao, <span class="number">1</span>, bufs[<span class="number">1</span>], <span class="number">0</span>,</span><br><span class="line">#                                   (size_of::&lt;<span class="type">f32</span>&gt;() * <span class="number">4</span>) <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 设置顶点属性对应的 buffer</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribBinding</span>(vao, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribBinding</span>(vao, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 设置顶点属性的格式</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayAttribFormat</span>(vao, <span class="number">0</span>, <span class="number">4</span>, gl::FLOAT, gl::FALSE, <span class="number">0</span>);</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayAttribFormat</span>(vao, <span class="number">1</span>, <span class="number">4</span>, gl::FLOAT, gl::FALSE, <span class="number">0</span>);</span><br><span class="line">#     &#125;</span><br><span class="line"></span><br><span class="line">#     <span class="comment">// 启用顶点属性</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">0</span>);</span><br><span class="line">      gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">1</span>);  </span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">program</span> = <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="comment">// 创建顶点着色器</span></span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         layout (location = 0) in vec4 position;</span></span><br><span class="line"><span class="string">#         layout (location = 1) in vec4 color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         out vec4 vs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           gl_Position = position;</span></span><br><span class="line"><span class="string">#           vs_color = color;</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::VERTEX_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(vs, <span class="number">1</span>, &amp;vs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(vs);</span><br><span class="line">#       </span><br><span class="line">#       <span class="comment">// 创建片段着色器</span></span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         in vec4 vs_color;</span></span><br><span class="line"><span class="string">#         out vec4 fs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           fs_color = vs_color;</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::FRAGMENT_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(fs, <span class="number">1</span>, &amp;fs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       <span class="comment">// 创建着色器程序</span></span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">program</span> = gl::<span class="title function_ invoke__">CreateProgram</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, fs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">LinkProgram</span>(program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       <span class="comment">// 启用着色器程序</span></span><br><span class="line">#       gl::<span class="title function_ invoke__">UseProgram</span>(program);</span><br><span class="line">#       program</span><br><span class="line">#     &#125;;</span><br><span class="line"># </span><br><span class="line">#     *<span class="keyword">self</span> = <span class="keyword">Self</span> &#123; vao, program, bufs &#125;;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, _current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR,<span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0f32</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">2</span>, <span class="keyword">self</span>.bufs.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vao);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>完整的配置过程如下：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::GLuint;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::ffi::&#123;c_void, CString&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::mem::&#123;size_of_val, size_of&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::null;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   vao: GLuint,</span><br><span class="line">#   bufs: [GLuint; <span class="number">2</span>],</span><br><span class="line">#   program: GLuint</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      <span class="comment">// 顶点属性</span></span><br><span class="line">      <span class="keyword">let</span> <span class="variable">position</span> = [ -<span class="number">0.5</span>, -<span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, </span><br><span class="line">                        <span class="number">0.5</span>, -<span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">                        <span class="number">0.0</span>,  <span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">1.0f32</span>,];</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">color</span> = [ <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">                    <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">                    <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">1.0f32</span>, ];</span><br><span class="line"># </span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vao</span> = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">bufs</span> = [<span class="number">0</span>; <span class="number">2</span>];</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> vao);</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">2</span>, bufs.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#       </span><br><span class="line">      <span class="comment">// 将顶点的位置属性复制到 buffer 里</span></span><br><span class="line">      gl::<span class="title function_ invoke__">NamedBufferStorage</span>(bufs[<span class="number">0</span>], <span class="title function_ invoke__">size_of_val</span>(&amp;position) <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">                            position.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> c_void,</span><br><span class="line">                            gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line">#       </span><br><span class="line">      <span class="comment">// 将 buffer 挂载到 vao 上</span></span><br><span class="line">      <span class="comment">// offset = 0, stride = suzeof([f32; 4])</span></span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayVertexBuffer</span>(vao, <span class="number">0</span>, bufs[<span class="number">0</span>], <span class="number">0</span>,</span><br><span class="line">                                  size_of::&lt;[<span class="type">f32</span>; <span class="number">4</span>]&gt;() <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">#       </span><br><span class="line">      <span class="comment">// 配置顶点属性的格式</span></span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayAttribFormat</span>(vao, <span class="number">0</span>, <span class="number">4</span>, gl::FLOAT, gl::FALSE, <span class="number">0</span>);</span><br><span class="line"># </span><br><span class="line">      <span class="comment">// 从哪个 buffer 作为顶点属性的输入</span></span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayAttribBinding</span>(vao, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"># </span><br><span class="line">      <span class="comment">// 配置完成</span></span><br><span class="line">      gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 配置第二个顶点属性</span></span><br><span class="line">      gl::<span class="title function_ invoke__">NamedBufferStorage</span>(bufs[<span class="number">1</span>], <span class="title function_ invoke__">size_of_val</span>(&amp;color) <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">                            color.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> c_void,</span><br><span class="line">                            gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayVertexBuffer</span>(vao, <span class="number">1</span>, bufs[<span class="number">1</span>], <span class="number">0</span>,</span><br><span class="line">                                  size_of::&lt;[<span class="type">f32</span>; <span class="number">4</span>]&gt;() <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayAttribBinding</span>(vao, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayAttribFormat</span>(vao, <span class="number">1</span>, <span class="number">4</span>, gl::FLOAT, gl::FALSE, <span class="number">0</span>);</span><br><span class="line">      gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">1</span>);  </span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         layout (location = 0) in vec4 position;</span></span><br><span class="line"><span class="string">#         layout (location = 1) in vec4 color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         out vec4 vs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           gl_Position = position;</span></span><br><span class="line"><span class="string">#           vs_color = color;</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::VERTEX_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(vs, <span class="number">1</span>, &amp;vs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(vs);</span><br><span class="line">#         </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         in vec4 vs_color;</span></span><br><span class="line"><span class="string">#         out vec4 fs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           fs_color = vs_color;</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::FRAGMENT_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(fs, <span class="number">1</span>, &amp;fs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">program</span> = gl::<span class="title function_ invoke__">CreateProgram</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, fs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">LinkProgram</span>(program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">UseProgram</span>(program);</span><br><span class="line"># </span><br><span class="line">#       *<span class="keyword">self</span> = <span class="keyword">Self</span> &#123; vao, program, bufs &#125;;</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">BindVertexArray</span>(vao);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, _current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR,<span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0f32</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">2</span>, <span class="keyword">self</span>.bufs.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vao);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>结果大概长这样：</p>

<div class="demo_app" id="_ch5_1_vao"></div>

<p>也可以将顶点属性放到一个结构体里，然后存到同一个缓冲区上：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::GLuint;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::ffi::&#123;c_void, CString&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::mem::&#123;size_of_val, size_of&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::null;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   vao: GLuint,</span><br><span class="line">#   buf: GLuint,</span><br><span class="line">#   program: GLuint</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="meta">#[allow(dead_code)]</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Vertex</span> &#123;</span><br><span class="line">      x: <span class="type">f32</span>, y: <span class="type">f32</span>, z: <span class="type">f32</span>, <span class="comment">// position</span></span><br><span class="line">      r: <span class="type">f32</span>, g: <span class="type">f32</span>, b: <span class="type">f32</span>, <span class="comment">// color</span></span><br><span class="line">    &#125;</span><br><span class="line"># </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">vertices</span> = [</span><br><span class="line">      Vertex &#123; x: -<span class="number">0.5</span>, y: -<span class="number">0.5</span>, z: <span class="number">0.0</span>, r: <span class="number">1.0</span>, g: <span class="number">0.0</span>, b: <span class="number">0.0</span> &#125;,</span><br><span class="line">      Vertex &#123; x:  <span class="number">0.5</span>, y: -<span class="number">0.5</span>, z: <span class="number">0.0</span>, r: <span class="number">0.0</span>, g: <span class="number">1.0</span>, b: <span class="number">0.0</span> &#125;,</span><br><span class="line">      Vertex &#123; x:  <span class="number">0.0</span>, y:  <span class="number">0.5</span>, z: <span class="number">0.0</span>, r: <span class="number">0.0</span>, g: <span class="number">0.0</span>, b: <span class="number">1.0</span> &#125;,</span><br><span class="line">    ];</span><br><span class="line">#   </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vao</span> = <span class="number">0</span>;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> vao);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line">      </span><br><span class="line">      gl::<span class="title function_ invoke__">NamedBufferStorage</span>(buf, <span class="title function_ invoke__">size_of_val</span>(&amp;vertices) <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">                             vertices.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> c_void,</span><br><span class="line">                             gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayVertexBuffer</span>(vao, <span class="number">0</span>, buf, <span class="number">0</span>, size_of::&lt;Vertex&gt;() <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayAttribFormat</span>(vao, <span class="number">0</span>, <span class="number">3</span>, gl::FLOAT, gl::FALSE, <span class="number">0</span>);</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayAttribFormat</span>(vao, <span class="number">1</span>, <span class="number">3</span>, gl::FLOAT, gl::FALSE,</span><br><span class="line">                                  <span class="number">3</span> * size_of::&lt;<span class="type">f32</span>&gt;() <span class="keyword">as</span> <span class="type">u32</span>);</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayAttribBinding</span>(vao, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexArrayAttribBinding</span>(vao, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">      gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">0</span>);</span><br><span class="line">      gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">1</span>);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         layout (location = 0) in vec3 position;</span></span><br><span class="line"><span class="string">#         layout (location = 1) in vec3 color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         out vec4 vs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           gl_Position = vec4(position, 1.0);</span></span><br><span class="line"><span class="string">#           vs_color = vec4(color, 1.0);</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::VERTEX_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(vs, <span class="number">1</span>, &amp;vs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(vs);</span><br><span class="line">#         </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         in vec4 vs_color;</span></span><br><span class="line"><span class="string">#         out vec4 fs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           fs_color = vs_color;</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::FRAGMENT_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(fs, <span class="number">1</span>, &amp;fs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">program</span> = gl::<span class="title function_ invoke__">CreateProgram</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, fs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">LinkProgram</span>(program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">UseProgram</span>(program);</span><br><span class="line"># </span><br><span class="line">#       *<span class="keyword">self</span> = <span class="keyword">Self</span> &#123; vao, program, buf &#125;;</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">BindVertexArray</span>(vao);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, _current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR,<span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0f32</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">2</span>, &amp;<span class="keyword">self</span>.buf);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vao);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>对于将所有顶点数据存到同一个缓冲区的情况，也可以用 <code>glVertexAttribPointer()</code> 向顶点着色器传入数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glVertexAttribPointer</span><span class="params">(GLuint index,</span></span><br><span class="line"><span class="params">                           GLint size,</span></span><br><span class="line"><span class="params">                           GLenum type,</span></span><br><span class="line"><span class="params">                           GLboolean normalized,</span></span><br><span class="line"><span class="params">                           GLsizei stride,</span></span><br><span class="line"><span class="params">                           <span class="type">const</span> GLvoid * pointer)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>index</code>：顶点属性在着色器的位置（顶点属性）</li>
<li><code>size</code>：顶点属性包含的数据个数：1、2、3、4、……</li>
<li><code>type</code>：数据类型：<code>GL_FLOAT</code>、<code>GL_UNSIGNED_BYTE</code>……</li>
<li><code>normalized</code>：是否进行正规化处理</li>
<li><code>stride</code>：所有顶点属性的大小之和，字节为单位</li>
<li><code>pointer</code>：顶点属性数据相对与 <code>stride</code> 的位置</li>
</ul>
<p>使用前提：</p>
<ol>
<li>已经创建 vao 并绑定到 OpenGL 环境里</li>
<li>已经创建好缓冲区对象，填充数据后绑定到 <code>GL_ARRAY_BUFFER</code> 上</li>
</ol>
<p>用 <code>glVertexAttribPointer()</code> 重写上面的例子，整个配置过程非常简便：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::GLuint;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::ffi::CString;</span><br><span class="line"># <span class="keyword">use</span> std::mem::&#123;size_of_val, size_of&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::null;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   vao: GLuint,</span><br><span class="line">#   buf: GLuint,</span><br><span class="line">#   program: GLuint</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">vertices_data</span> = [</span><br><span class="line">        <span class="comment">// position               // color</span></span><br><span class="line">        -<span class="number">0.5</span>, -<span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,     <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, </span><br><span class="line">         <span class="number">0.5</span>, -<span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,     <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">         <span class="number">0.0</span>,  <span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">1.0</span>,     <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">1.0f32</span>,</span><br><span class="line">      ];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vao</span> = <span class="number">0</span>;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> vao);</span><br><span class="line">      gl::<span class="title function_ invoke__">BindVertexArray</span>(vao);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line">      gl::<span class="title function_ invoke__">NamedBufferStorage</span>(buf, <span class="title function_ invoke__">size_of_val</span>(&amp;vertices_data) <span class="keyword">as</span> _,</span><br><span class="line">                             vertices_data.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _,</span><br><span class="line">                             gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line"></span><br><span class="line">      gl::<span class="title function_ invoke__">BindBuffer</span>(gl::ARRAY_BUFFER, buf);</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexAttribPointer</span>(<span class="number">0</span>, <span class="number">4</span>, gl::FLOAT, gl::FALSE,</span><br><span class="line">                              (<span class="number">8</span> * size_of::&lt;<span class="type">f32</span>&gt;()) <span class="keyword">as</span> _, <span class="number">0</span> <span class="keyword">as</span> _);</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexAttribPointer</span>(<span class="number">1</span>, <span class="number">4</span>, gl::FLOAT, gl::FALSE,</span><br><span class="line">                             (<span class="number">8</span> * size_of::&lt;<span class="type">f32</span>&gt;()) <span class="keyword">as</span> _,</span><br><span class="line">                             (<span class="number">4</span> * size_of::&lt;<span class="type">f32</span>&gt;()) <span class="keyword">as</span> _);</span><br><span class="line">      gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">0</span>);</span><br><span class="line">      gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">1</span>);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         layout (location = 0) in vec4 position;</span></span><br><span class="line"><span class="string">#         layout (location = 1) in vec4 color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         out vec4 vs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           gl_Position = position;</span></span><br><span class="line"><span class="string">#           vs_color = color;</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::VERTEX_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(vs, <span class="number">1</span>, &amp;vs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(vs);</span><br><span class="line">#         </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         in vec4 vs_color;</span></span><br><span class="line"><span class="string">#         out vec4 fs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           fs_color = vs_color;</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::FRAGMENT_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(fs, <span class="number">1</span>, &amp;fs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">program</span> = gl::<span class="title function_ invoke__">CreateProgram</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, fs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">LinkProgram</span>(program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">UseProgram</span>(program);</span><br><span class="line"># </span><br><span class="line">#       *<span class="keyword">self</span> = <span class="keyword">Self</span> &#123; vao, program, buf &#125;;</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">BindVertexArray</span>(vao);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, _current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR,<span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0f32</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.buf);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vao);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<h2 id="uniform-变量"><a class="markdownIt-Anchor" href="#uniform-变量"></a> Uniform 变量</h2>
<p>uniform 变量可以在任何着色器里声明，是一种很重要的数据形式，可以理解为着色器暴露给 OpenGL 应用程序的全局变量。可以在 OpenGL 应用程序里将数据直接传递给着色器。最常见的 uniform 变量应该就是变换矩阵了。</p>
<p>声明 uniform 变量：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uniform</span> <span class="type">float</span> time;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">int</span> <span class="keyword">index</span>;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">vec4</span> color;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> vpmat;</span><br></pre></td></tr></table></figure>
<p>在着色器里不能对 uniform 变量赋值，只能在声明的时候赋初值：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uniform</span> <span class="type">float</span> a = <span class="number">12</span>;</span><br></pre></td></tr></table></figure>
<h3 id="向-uniform-变量传递数据"><a class="markdownIt-Anchor" href="#向-uniform-变量传递数据"></a> 向 uniform 变量传递数据</h3>
<p>先用 <code>glGetUniformLocation()</code> 查询 uniform 变量在哪，再用 <code>glUniform*()</code> 给 uniform 变量传递数据（类似于赋值）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GLint <span class="title function_">glGetUniformLocation</span><span class="params">(GLuint program,</span></span><br><span class="line"><span class="params">                           <span class="type">const</span> GLchar *name)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">glUniform1f</span><span class="params">(GLint location,</span></span><br><span class="line"><span class="params">                 GLfloat v0)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">glUniform2f</span><span class="params">(GLint location,</span></span><br><span class="line"><span class="params">                 GLfloat v0,</span></span><br><span class="line"><span class="params">                 GLfloat v1)</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以在 <a target="_blank" rel="noopener" href="http://docs.gl">docs.gl</a> 查看所有的 <code>glUniform*()</code> 函数：<a target="_blank" rel="noopener" href="https://docs.gl/gl4/glUniform">https://docs.gl/gl4/glUniform</a></p>
<p>对于这两个 uniform 变量：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uniform</span> <span class="type">float</span> time;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">vec3</span> <span class="keyword">offset</span>;</span><br></pre></td></tr></table></figure>
<p>在 OpenGL 应用程序里给它们赋值：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">name</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;time&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"><span class="keyword">let</span> <span class="variable">ltime</span> = gl::<span class="title function_ invoke__">GetUniformLocation</span>(program, name.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">gl::<span class="title function_ invoke__">Uniform1f</span>(ltime, <span class="number">1.0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">name</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;offset&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"><span class="keyword">let</span> <span class="variable">loffset</span> = gl::<span class="title function_ invoke__">GetUniformLocation</span>(program, name.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">gl::<span class="title function_ invoke__">Uniform3f</span>(loffset, <span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>);</span><br></pre></td></tr></table></figure>
<p>也可以在着色器里直接指定 uniform 变量的位置:</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">uniform</span> <span class="type">float</span> time;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">uniform</span> <span class="type">int</span> <span class="keyword">index</span>;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">2</span>) <span class="keyword">uniform</span> <span class="type">vec4</span> color;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">3</span>) <span class="keyword">uniform</span> <span class="type">bool</span> flag;</span><br></pre></td></tr></table></figure>
<p>这样就不需要调用 <code>GetUniformLocation()</code> 了：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gl::<span class="title function_ invoke__">Uniform1f</span>(<span class="number">0</span>, <span class="number">1.0</span>);</span><br><span class="line">gl::<span class="title function_ invoke__">Uniform1i</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">gl::<span class="title function_ invoke__">Uniform3f</span>(<span class="number">2</span>, <span class="number">3.0</span>, <span class="number">4.0</span>, <span class="number">5.0</span>);</span><br><span class="line">gl::<span class="title function_ invoke__">Uniform1i</span>(<span class="number">3</span>, gl::FALSE);</span><br></pre></td></tr></table></figure>
<p><code>glUniform*()</code> 有一组以 <code>v</code> 作为后缀的函数，可以传入指向数据的指针：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glUniform3fv</span><span class="params">(GLint location,</span></span><br><span class="line"><span class="params">                  GLsizei count,</span></span><br><span class="line"><span class="params">                  <span class="type">const</span> GLfloat *value)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">glUniform4fv</span><span class="params">(GLint location,</span></span><br><span class="line"><span class="params">                  GLsizei count,</span></span><br><span class="line"><span class="params">                  <span class="type">const</span> GLfloat *value)</span>;</span><br></pre></td></tr></table></figure>
<p>用 <code>Uniform4fv()</code> 传 vec4 变量：</p>
<figure class="highlight glsl"><figcaption><span>glsl:</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uniform</span> <span class="type">vec4</span> vcolor;</span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><figcaption><span>rust:</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">vcolor</span> = [<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>];</span><br><span class="line">gl::<span class="title function_ invoke__">Uniform4fv</span>(vcolor_location, <span class="number">1</span>, vcolor.<span class="title function_ invoke__">as_ptr</span>());</span><br></pre></td></tr></table></figure>
<p>传递数组，将 <code>glUniform4fv()</code> 的 count 设置为数组长度就行：</p>
<figure class="highlight glsl"><figcaption><span>glsl, 顶点着色器:</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># #version 460 core</span></span><br><span class="line"><span class="meta"># layout (location = 0) in vec3 position;</span></span><br><span class="line"><span class="meta"># out vec4 vs_color;</span></span><br><span class="line"><span class="meta"># </span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">vec4</span> colors[<span class="number">3</span>];</span><br><span class="line"><span class="meta"># </span></span><br><span class="line"><span class="meta"># void main() &#123;</span></span><br><span class="line"><span class="meta">#   gl_Position = vec4(position, 1.0);</span></span><br><span class="line"><span class="meta">#   vs_color = colors[gl_VertexID];</span></span><br><span class="line"><span class="meta"># &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><figcaption><span>rust:</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::GLuint;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::ffi::&#123;c_void, CString&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::mem::&#123;size_of_val, size_of&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::null;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   vao: GLuint,</span><br><span class="line">#   buf: GLuint,</span><br><span class="line">#   program: GLuint</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">positions</span> = [ -<span class="number">0.5</span>, -<span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">0.5</span>, -<span class="number">0.5</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.5</span>, <span class="number">0.0f32</span>,];</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vao</span> = <span class="number">0</span>;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> vao);</span><br><span class="line">#       </span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line">#       </span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferStorage</span>(buf, <span class="title function_ invoke__">size_of_val</span>(&amp;positions) <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">#                             positions.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> c_void,</span><br><span class="line">#                             gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayVertexBuffer</span>(vao, <span class="number">0</span>, buf, <span class="number">0</span>,</span><br><span class="line">#                                     size_of::&lt;[<span class="type">f32</span>; <span class="number">3</span>]&gt;() <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribFormat</span>(vao, <span class="number">0</span>, <span class="number">3</span>, gl::FLOAT, gl::FALSE, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribBinding</span>(vao, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">0</span>);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         layout (location = 0) in vec3 position;</span></span><br><span class="line"><span class="string">#         out vec4 vs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         uniform vec4 colors[3];</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           gl_Position = vec4(position, 1.0);</span></span><br><span class="line"><span class="string">#           vs_color = colors[gl_VertexID];</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::VERTEX_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(vs, <span class="number">1</span>, &amp;vs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(vs);</span><br><span class="line">#         </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         in vec4 vs_color;</span></span><br><span class="line"><span class="string">#         out vec4 fs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           fs_color = vs_color;</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::FRAGMENT_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(fs, <span class="number">1</span>, &amp;fs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">program</span> = gl::<span class="title function_ invoke__">CreateProgram</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, fs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">LinkProgram</span>(program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">UseProgram</span>(program);</span><br><span class="line"># </span><br><span class="line">#       *<span class="keyword">self</span> = <span class="keyword">Self</span> &#123; vao, program, buf &#125;;</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">BindVertexArray</span>(vao);</span><br><span class="line"># </span><br><span class="line">      <span class="keyword">let</span> <span class="variable">colors</span> = [[<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>],</span><br><span class="line">                    [<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>],</span><br><span class="line">                    [<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0f32</span>],];</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">name</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;colors&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">colors_location</span> = gl::<span class="title function_ invoke__">GetUniformLocation</span>(program, name.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">      gl::<span class="title function_ invoke__">Uniform4fv</span>(colors_location, <span class="number">3</span>, colors.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">f32</span>);</span><br><span class="line">#       </span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, _current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR,<span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0f32</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">2</span>, &amp;<span class="keyword">self</span>.buf);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vao);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>传一维数据：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">data</span> = <span class="number">1.0f32</span>;</span><br><span class="line">gl::<span class="title function_ invoke__">Uniform1fv</span>(data_location, <span class="number">1</span>, &amp;data);</span><br></pre></td></tr></table></figure>
<p>传递矩阵：</p>
<figure class="highlight glsl"><figcaption><span>顶点着色器:</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># #version 460 core</span></span><br><span class="line"><span class="meta"># layout (location = 0) in vec3 position;</span></span><br><span class="line"><span class="meta"># layout (location = 1) in vec3 color;</span></span><br><span class="line"><span class="meta"># </span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> mv_mat = <span class="type">mat4</span>(<span class="number">1.0</span>);</span><br><span class="line"><span class="meta"># </span></span><br><span class="line"><span class="meta"># out vec4 vs_color;</span></span><br><span class="line"><span class="meta"># </span></span><br><span class="line"><span class="meta"># void main() &#123;</span></span><br><span class="line"><span class="meta">#   gl_Position = mv_mat * vec4(position, 1.0);</span></span><br><span class="line"><span class="meta">#   vs_color = vec4(color, 1.0);</span></span><br><span class="line"><span class="meta"># &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::GLuint;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::ffi::&#123;c_void, CString&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::mem::&#123;size_of_val, size_of&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::&#123;null, addr_of&#125;;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   vao: GLuint,</span><br><span class="line">#   buf: GLuint,</span><br><span class="line">#   program: GLuint</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="meta">#[allow(dead_code)]</span></span><br><span class="line">#     <span class="keyword">struct</span> <span class="title class_">Vertex</span> &#123;</span><br><span class="line">#       x: <span class="type">f32</span>, y: <span class="type">f32</span>, z: <span class="type">f32</span>, <span class="comment">// position</span></span><br><span class="line">#       r: <span class="type">f32</span>, g: <span class="type">f32</span>, b: <span class="type">f32</span>, <span class="comment">// color</span></span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vertices</span> = [</span><br><span class="line">#       Vertex &#123; x: -<span class="number">0.5</span>, y: -<span class="number">0.5</span>, z: <span class="number">0.0</span>, r: <span class="number">1.0</span>, g: <span class="number">0.0</span>, b: <span class="number">0.0</span> &#125;,</span><br><span class="line">#       Vertex &#123; x:  <span class="number">0.5</span>, y: -<span class="number">0.5</span>, z: <span class="number">0.0</span>, r: <span class="number">0.0</span>, g: <span class="number">1.0</span>, b: <span class="number">0.0</span> &#125;,</span><br><span class="line">#       Vertex &#123; x:  <span class="number">0.0</span>, y:  <span class="number">0.5</span>, z: <span class="number">0.0</span>, r: <span class="number">0.0</span>, g: <span class="number">0.0</span>, b: <span class="number">1.0</span> &#125;,</span><br><span class="line">#     ];</span><br><span class="line">#   </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vao</span> = <span class="number">0</span>;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> vao);</span><br><span class="line">#       </span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line">#       </span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferStorage</span>(buf, <span class="title function_ invoke__">size_of_val</span>(&amp;vertices) <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">#                             vertices.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> c_void,</span><br><span class="line">#                             gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayVertexBuffer</span>(vao, <span class="number">0</span>, buf, <span class="number">0</span>, size_of::&lt;Vertex&gt;() <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribFormat</span>(vao, <span class="number">0</span>, <span class="number">3</span>, gl::FLOAT, gl::FALSE, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribFormat</span>(vao, <span class="number">1</span>, <span class="number">3</span>, gl::FLOAT, gl::FALSE, <span class="number">3</span> * size_of::&lt;<span class="type">f32</span>&gt;() <span class="keyword">as</span> <span class="type">u32</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribBinding</span>(vao, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribBinding</span>(vao, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">1</span>);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         layout (location = 0) in vec3 position;</span></span><br><span class="line"><span class="string">#         layout (location = 1) in vec3 color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         uniform mat4 mv_mat = mat4(1.0);</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         out vec4 vs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           gl_Position = mv_mat * vec4(position, 1.0);</span></span><br><span class="line"><span class="string">#           vs_color = vec4(color, 1.0);</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::VERTEX_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(vs, <span class="number">1</span>, &amp;vs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(vs);</span><br><span class="line">#         </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string">#         in vec4 vs_color;</span></span><br><span class="line"><span class="string">#         out vec4 fs_color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           fs_color = vs_color;</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::FRAGMENT_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(fs, <span class="number">1</span>, &amp;fs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">program</span> = gl::<span class="title function_ invoke__">CreateProgram</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, fs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">LinkProgram</span>(program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">UseProgram</span>(program);</span><br><span class="line"># </span><br><span class="line">#       *<span class="keyword">self</span> = <span class="keyword">Self</span> &#123; vao, program, buf &#125;;</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">BindVertexArray</span>(vao);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, _current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">mv_mat</span> = sb7::vmath::<span class="title function_ invoke__">rotate</span>(<span class="number">0.0</span>, _current_time <span class="keyword">as</span> <span class="type">f32</span> * <span class="number">45.0</span>, <span class="number">0.0</span>);</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">name</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;mv_mat&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">location_mv_mat</span> = gl::<span class="title function_ invoke__">GetUniformLocation</span>(<span class="keyword">self</span>.program,</span><br><span class="line">                                                   name.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _);</span><br><span class="line">      gl::<span class="title function_ invoke__">UniformMatrix4fv</span>(location_mv_mat, <span class="number">1</span>,</span><br><span class="line">                           gl::FALSE, addr_of!(mv_mat) <span class="keyword">as</span> _);</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR,<span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0f32</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">2</span>, &amp;<span class="keyword">self</span>.buf);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vao);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>对应的效果如下：</p>

<div class="demo_app" id="_ch5_1_0_uniform_mat"></div>

<p><code>glUniformMatrix4fv()</code> 原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glUniformMatrix4fv</span><span class="params">(GLint location,</span></span><br><span class="line"><span class="params">                        GLsizei count,</span></span><br><span class="line"><span class="params">                        GLboolean transpose,</span></span><br><span class="line"><span class="params">                        <span class="type">const</span> GLfloat *value)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>count</code>：矩阵个数，传 mat4 数组的时候传元素个数</li>
<li><code>transpose</code>：传递时是否将矩阵转置，如果线性代数库里的矩阵是以行优先存储的，需要设置为 GL_TRUE，来对矩阵进行转置，以符合 OpenGL 的期望格式</li>
</ul>
<p><strong>通过 uniform 变量设置变换矩阵</strong></p>
<p>初始化顶点数据：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::*;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::&#123;Application, AppConfig&#125;;</span><br><span class="line"># <span class="keyword">use</span> sb7::mat4;</span><br><span class="line"># <span class="keyword">use</span> sb7::vmath::&#123;Mat4, translate, rotate_with_axis&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::ffi::CString;</span><br><span class="line"># <span class="keyword">use</span> std::mem::size_of_val;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::&#123;null, addr_of&#125;;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   vao: GLuint,</span><br><span class="line">#   buf: GLuint,</span><br><span class="line">#   program: GLuint,</span><br><span class="line">#   proj_matrix: Mat4,</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="meta">#[rustfmt::skip]</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">vertex_position</span> : &amp;[<span class="type">f32</span>]= &amp;[</span><br><span class="line">      -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">      -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">       <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">       <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">      -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">      -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span></span><br><span class="line">    ];</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vao</span> = <span class="number">0</span>;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> vao);</span><br><span class="line">      gl::<span class="title function_ invoke__">BindVertexArray</span>(vao);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line">      gl::<span class="title function_ invoke__">BindBuffer</span>(gl::ARRAY_BUFFER, buf);</span><br><span class="line">      gl::<span class="title function_ invoke__">NamedBufferData</span>(buf,</span><br><span class="line">                          <span class="title function_ invoke__">size_of_val</span>(vertex_position) <span class="keyword">as</span> _,</span><br><span class="line">                          vertex_position.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _,</span><br><span class="line">                          gl::STATIC_DRAW);</span><br><span class="line">      gl::<span class="title function_ invoke__">VertexAttribPointer</span>(<span class="number">0</span>, <span class="number">3</span>, gl::FLOAT, gl::FALSE, <span class="number">0</span>, <span class="title function_ invoke__">null</span>());</span><br><span class="line">      gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">0</span>);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         in vec4 position;</span></span><br><span class="line"><span class="string">#         </span></span><br><span class="line"><span class="string">#         out VS_OUT &#123;</span></span><br><span class="line"><span class="string">#           vec4 color;</span></span><br><span class="line"><span class="string">#         &#125; vs_out;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         layout (location = 0) uniform mat4 mv_matrix = mat4(1.0);</span></span><br><span class="line"><span class="string">#         layout (location = 1) uniform mat4 proj_matrix = mat4(1.0);</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           gl_Position =  proj_matrix * mv_matrix * position;</span></span><br><span class="line"><span class="string">#           vs_out.color = position * 2.0 + vec4(0.5, 0.5, 0.5, 0.0);</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::VERTEX_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(vs, <span class="number">1</span>, &amp;vs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(vs);</span><br><span class="line">#         </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         out vec4 color;</span></span><br><span class="line"><span class="string">#         </span></span><br><span class="line"><span class="string">#         in VS_OUT &#123;</span></span><br><span class="line"><span class="string">#           vec4 color;</span></span><br><span class="line"><span class="string">#         &#125; fs_in;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           color = fs_in.color;</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::FRAGMENT_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(fs, <span class="number">1</span>, &amp;fs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">program</span> = gl::<span class="title function_ invoke__">CreateProgram</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, fs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">LinkProgram</span>(program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">UseProgram</span>(program);</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">Enable</span>(gl::DEPTH_TEST);</span><br><span class="line">#       *<span class="keyword">self</span> = <span class="keyword">Self</span> &#123; vao, program, buf, proj_matrix: mat4!() &#125;;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">AppConfig</span> &#123; width, height, .. &#125; = AppConfig::<span class="title function_ invoke__">default</span>();</span><br><span class="line">#     <span class="keyword">self</span>.<span class="title function_ invoke__">on_resize</span>(width <span class="keyword">as</span> _, height <span class="keyword">as</span> _);</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">current_time</span> = current_time <span class="keyword">as</span> <span class="type">f32</span>;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">f</span> = current_time * <span class="number">0.3</span>;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">mv_matrix</span> = <span class="title function_ invoke__">translate</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, -<span class="number">4.0</span>) *</span><br><span class="line">#                       <span class="title function_ invoke__">translate</span>((<span class="number">2.1</span> * f).<span class="title function_ invoke__">sin</span>() * <span class="number">0.5</span>,</span><br><span class="line">#                                 (<span class="number">1.7</span> * f).<span class="title function_ invoke__">cos</span>() * <span class="number">0.5</span>,</span><br><span class="line">#                                 (<span class="number">1.3</span> * f).<span class="title function_ invoke__">sin</span>() * (<span class="number">1.5</span> * f).<span class="title function_ invoke__">cos</span>() * <span class="number">2.0</span>) *</span><br><span class="line">#                       <span class="title function_ invoke__">rotate_with_axis</span>(current_time * <span class="number">45.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>) *</span><br><span class="line">#                       <span class="title function_ invoke__">rotate_with_axis</span>(current_time * <span class="number">81.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">UniformMatrix4fv</span>(<span class="number">0</span>, <span class="number">1</span>, gl::FALSE, addr_of!(mv_matrix) <span class="keyword">as</span> _);</span><br><span class="line">#       </span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR,<span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::DEPTH, <span class="number">0</span>, &amp;<span class="number">1.0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">on_resize</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, w: <span class="type">i32</span>, h: <span class="type">i32</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">aspect</span> = w <span class="keyword">as</span> GLfloat / h <span class="keyword">as</span> GLfloat;</span><br><span class="line">#     <span class="keyword">self</span>.proj_matrix = sb7::vmath::<span class="title function_ invoke__">perspective</span>(<span class="number">50.0</span>, aspect, <span class="number">0.1</span>, <span class="number">1000.0</span>);</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">UniformMatrix4fv</span>(<span class="number">1</span>, <span class="number">1</span>, gl::FALSE, addr_of!(<span class="keyword">self</span>.proj_matrix) <span class="keyword">as</span> _);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">2</span>, &amp;<span class="keyword">self</span>.buf);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vao);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>设置变换矩阵：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># ...</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">current_time</span> = current_time <span class="keyword">as</span> <span class="type">f32</span>;</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">f</span> = current_time * <span class="number">0.3</span>;</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">mv_matrix</span> = <span class="title function_ invoke__">translate</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, -<span class="number">4.0</span>) *</span><br><span class="line">                      <span class="title function_ invoke__">translate</span>((<span class="number">2.1</span> * f).<span class="title function_ invoke__">sin</span>() * <span class="number">0.5</span>,</span><br><span class="line">                                (<span class="number">1.7</span> * f).<span class="title function_ invoke__">cos</span>() * <span class="number">0.5</span>,</span><br><span class="line">                                (<span class="number">1.3</span> * f).<span class="title function_ invoke__">sin</span>() * (<span class="number">1.5</span> * f).<span class="title function_ invoke__">cos</span>() * <span class="number">2.0</span>) *</span><br><span class="line">                      <span class="title function_ invoke__">rotate_with_axis</span>(current_time * <span class="number">45.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>) *</span><br><span class="line">                      <span class="title function_ invoke__">rotate_with_axis</span>(current_time * <span class="number">81.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">UniformMatrix4fv</span>(<span class="number">0</span>, <span class="number">1</span>, gl::FALSE, addr_of!(mv_matrix) <span class="keyword">as</span> _);</span><br><span class="line">#       </span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR,<span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::DEPTH, <span class="number">0</span>, &amp;<span class="number">1.0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># ...</span><br></pre></td></tr></table></figure>
<p>在窗口大小发生改变时，更新投影矩阵：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># ...</span><br><span class="line">  <span class="keyword">fn</span> <span class="title function_">on_resize</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, w: <span class="type">i32</span>, h: <span class="type">i32</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">aspect</span> = w <span class="keyword">as</span> GLfloat / h <span class="keyword">as</span> GLfloat;</span><br><span class="line">    <span class="keyword">self</span>.proj_matrix = sb7::vmath::<span class="title function_ invoke__">perspective</span>(<span class="number">50.0</span>, aspect, <span class="number">0.1</span>, <span class="number">1000.0</span>);</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">UniformMatrix4fv</span>(<span class="number">1</span>, <span class="number">1</span>, gl::FALSE, addr_of!(<span class="keyword">self</span>.proj_matrix) <span class="keyword">as</span> _);</span><br><span class="line">#     &#125;</span><br><span class="line">  &#125;</span><br><span class="line"># ...</span><br></pre></td></tr></table></figure>
<p>将变换矩阵和投影矩阵写入 uniform 变量：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#       <span class="comment">// ...</span></span><br><span class="line">#     <span class="keyword">self</span>.<span class="title function_ invoke__">on_resize</span>(width <span class="keyword">as</span> _, height <span class="keyword">as</span> _);</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">current_time</span> = current_time <span class="keyword">as</span> <span class="type">f32</span>;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">f</span> = current_time * <span class="number">0.3</span>;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">mv_matrix</span> = <span class="title function_ invoke__">translate</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, -<span class="number">4.0</span>) *</span><br><span class="line">#                       <span class="title function_ invoke__">translate</span>((<span class="number">2.1</span> * f).<span class="title function_ invoke__">sin</span>() * <span class="number">0.5</span>,</span><br><span class="line">#                                 (<span class="number">1.7</span> * f).<span class="title function_ invoke__">cos</span>() * <span class="number">0.5</span>,</span><br><span class="line">#                                 (<span class="number">1.3</span> * f).<span class="title function_ invoke__">sin</span>() * (<span class="number">1.5</span> * f).<span class="title function_ invoke__">cos</span>() * <span class="number">2.0</span>) *</span><br><span class="line">#                       <span class="title function_ invoke__">rotate_with_axis</span>(current_time * <span class="number">45.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>) *</span><br><span class="line">#                       <span class="title function_ invoke__">rotate_with_axis</span>(current_time * <span class="number">81.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">      gl::<span class="title function_ invoke__">UniformMatrix4fv</span>(<span class="number">0</span>, <span class="number">1</span>, gl::FALSE, addr_of!(mv_matrix) <span class="keyword">as</span> _);</span><br><span class="line">#       </span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR,<span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::DEPTH, <span class="number">0</span>, &amp;<span class="number">1.0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">on_resize</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, w: <span class="type">i32</span>, h: <span class="type">i32</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">aspect</span> = w <span class="keyword">as</span> GLfloat / h <span class="keyword">as</span> GLfloat;</span><br><span class="line">#     <span class="keyword">self</span>.proj_matrix = sb7::vmath::<span class="title function_ invoke__">perspective</span>(<span class="number">50.0</span>, aspect, <span class="number">0.1</span>, <span class="number">1000.0</span>);</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      gl::<span class="title function_ invoke__">UniformMatrix4fv</span>(<span class="number">1</span>, <span class="number">1</span>, gl::FALSE, addr_of!(<span class="keyword">self</span>.proj_matrix) <span class="keyword">as</span> _);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">#       <span class="comment">// ...</span></span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>顶点着色器：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 460 core</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">in</span> <span class="type">vec4</span> position;</span><br><span class="line"></span><br><span class="line"><span class="keyword">out</span> VS_OUT &#123;</span><br><span class="line">  <span class="type">vec4</span> color;</span><br><span class="line">&#125; vs_out;</span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">uniform</span> <span class="type">mat4</span> mv_matrix = <span class="type">mat4</span>(<span class="number">1.0</span>);</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">uniform</span> <span class="type">mat4</span> proj_matrix = <span class="type">mat4</span>(<span class="number">1.0</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">  <span class="built_in">gl_Position</span> =  proj_matrix * mv_matrix * position;</span><br><span class="line">  vs_out.color = position * <span class="number">2.0</span> + <span class="type">vec4</span>(<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>片段着色器：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 460 core</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec4</span> color;</span><br><span class="line"></span><br><span class="line"><span class="keyword">in</span> VS_OUT &#123;</span><br><span class="line">  <span class="type">vec4</span> color;</span><br><span class="line">&#125; fs_in;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">  color = fs_in.color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="demo_app" id="_ch5_2_spinningcube"></div>

<p>绘制多个物体：在 render 函数里多次调用 <code>glDrawArray</code> 就行：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::*;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::&#123;Application, AppConfig&#125;;</span><br><span class="line"># <span class="keyword">use</span> sb7::mat4;</span><br><span class="line"># <span class="keyword">use</span> sb7::vmath::&#123;Mat4, translate, rotate_with_axis&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::ffi::CString;</span><br><span class="line"># <span class="keyword">use</span> std::mem::size_of_val;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::&#123;null, addr_of&#125;;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   vao: GLuint,</span><br><span class="line">#   buf: GLuint,</span><br><span class="line">#   program: GLuint,</span><br><span class="line">#   proj_matrix: Mat4,</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="meta">#[rustfmt::skip]</span></span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vertex_position</span> : &amp;[<span class="type">f32</span>]= &amp;[</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span></span><br><span class="line">#     ];</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vao</span> = <span class="number">0</span>;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> vao);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindVertexArray</span>(vao);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindBuffer</span>(gl::ARRAY_BUFFER, buf);</span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferData</span>(buf,</span><br><span class="line">#                           <span class="title function_ invoke__">size_of_val</span>(vertex_position) <span class="keyword">as</span> _,</span><br><span class="line">#                           vertex_position.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _,</span><br><span class="line">#                           gl::STATIC_DRAW);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexAttribPointer</span>(<span class="number">0</span>, <span class="number">3</span>, gl::FLOAT, gl::FALSE, <span class="number">0</span>, <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">0</span>);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         in vec4 position;</span></span><br><span class="line"><span class="string">#         </span></span><br><span class="line"><span class="string">#         out VS_OUT &#123;</span></span><br><span class="line"><span class="string">#           vec4 color;</span></span><br><span class="line"><span class="string">#         &#125; vs_out;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         layout (location = 0) uniform mat4 mv_matrix = mat4(1.0);</span></span><br><span class="line"><span class="string">#         layout (location = 1) uniform mat4 proj_matrix = mat4(1.0);</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           gl_Position =  proj_matrix * mv_matrix * position;</span></span><br><span class="line"><span class="string">#           vs_out.color = position * 2.0 + vec4(0.5, 0.5, 0.5, 0.0);</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::VERTEX_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(vs, <span class="number">1</span>, &amp;vs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(vs);</span><br><span class="line">#         </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs_source</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">#         #version 460 core</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         out vec4 color;</span></span><br><span class="line"><span class="string">#         </span></span><br><span class="line"><span class="string">#         in VS_OUT &#123;</span></span><br><span class="line"><span class="string">#           vec4 color;</span></span><br><span class="line"><span class="string">#         &#125; fs_in;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#         void main() &#123;</span></span><br><span class="line"><span class="string">#           color = fs_in.color;</span></span><br><span class="line"><span class="string">#         &#125;</span></span><br><span class="line"><span class="string">#       &quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::FRAGMENT_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(fs, <span class="number">1</span>, &amp;fs_source.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">program</span> = gl::<span class="title function_ invoke__">CreateProgram</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(program, fs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">LinkProgram</span>(program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">      gl::<span class="title function_ invoke__">UseProgram</span>(program);</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">Enable</span>(gl::DEPTH_TEST);</span><br><span class="line">#       *<span class="keyword">self</span> = <span class="keyword">Self</span> &#123; vao, program, buf, proj_matrix: mat4!() &#125;;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">AppConfig</span> &#123; width, height, .. &#125; = AppConfig::<span class="title function_ invoke__">default</span>();</span><br><span class="line">#     <span class="keyword">self</span>.<span class="title function_ invoke__">on_resize</span>(width <span class="keyword">as</span> _, height <span class="keyword">as</span> _);</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR,<span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::DEPTH, <span class="number">0</span>, &amp;<span class="number">1.0</span>);</span><br><span class="line"># </span><br><span class="line">      <span class="keyword">let</span> <span class="variable">current_time</span> = current_time <span class="keyword">as</span> <span class="type">f32</span>;</span><br><span class="line"># </span><br><span class="line">      <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">24</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">f</span> = i <span class="keyword">as</span> <span class="type">f32</span> + current_time * <span class="number">0.3</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">mv_matrix</span> = <span class="title function_ invoke__">translate</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, -<span class="number">6.0</span>)</span><br><span class="line">             * <span class="title function_ invoke__">rotate_with_axis</span>(current_time * <span class="number">45.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>)</span><br><span class="line">             * <span class="title function_ invoke__">rotate_with_axis</span>(current_time * <span class="number">21.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>)</span><br><span class="line">             * <span class="title function_ invoke__">translate</span>((<span class="number">2.1</span> * f).<span class="title function_ invoke__">sin</span>() * <span class="number">2.0</span>,</span><br><span class="line">                         (<span class="number">1.7</span> * f).<span class="title function_ invoke__">cos</span>() * <span class="number">2.0</span>,</span><br><span class="line">                         (<span class="number">1.3</span> * f).<span class="title function_ invoke__">sin</span>() * (<span class="number">1.5</span> * f).<span class="title function_ invoke__">cos</span>() * <span class="number">2.0</span>);</span><br><span class="line">        gl::<span class="title function_ invoke__">UniformMatrix4fv</span>(<span class="number">0</span>, <span class="number">1</span>, gl::FALSE, addr_of!(mv_matrix) <span class="keyword">as</span> _);</span><br><span class="line"></span><br><span class="line">        gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line">      &#125;</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">on_resize</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, w: <span class="type">i32</span>, h: <span class="type">i32</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">aspect</span> = w <span class="keyword">as</span> GLfloat / h <span class="keyword">as</span> GLfloat;</span><br><span class="line">#     <span class="keyword">self</span>.proj_matrix = sb7::vmath::<span class="title function_ invoke__">perspective</span>(<span class="number">50.0</span>, aspect, <span class="number">0.1</span>, <span class="number">1000.0</span>);</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">UniformMatrix4fv</span>(<span class="number">1</span>, <span class="number">1</span>, gl::FALSE, addr_of!(<span class="keyword">self</span>.proj_matrix) <span class="keyword">as</span> _);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">2</span>, &amp;<span class="keyword">self</span>.buf);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vao);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>

<div class="demo_app" id="_ch5_3_spinningcubes"></div>

<h3 id="uniform-区块"><a class="markdownIt-Anchor" href="#uniform-区块"></a> Uniform 区块</h3>
<p>如果程序成千上万的 uniform 变量意味着将会有很多散落在各处的<code>glUniform*()</code>（难以维护）。将 uniform 变量塞到一个块结构(uniform 区块)里，uniform 区块的数据和缓冲区对象绑定，从而降低调用 <code>glUniform*()</code>的开销。</p>
<p>和 uniform 区块相绑定的缓冲区称为 ubo</p>
<p><strong>声明</strong></p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uniform</span> [块名] &#123;</span><br><span class="line">  <span class="comment">// ... 成员变量</span></span><br><span class="line">&#125; [实例名];</span><br></pre></td></tr></table></figure>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uniform</span> TransformBlock</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">float</span> scale;</span><br><span class="line">  <span class="type">vec3</span> transition;</span><br><span class="line">  <span class="type">float</span> rotate[<span class="number">3</span>];</span><br><span class="line">  <span class="type">mat4</span> proj_matrix;</span><br><span class="line">&#125; transform;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>和结构体类似，访问成员：<code>transform.scale</code></p>
<p>如果要定义多个 <code>TransformBlock</code> 块实例的话，这样子是不行的：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ERROR</span></span><br><span class="line"><span class="keyword">uniform</span> TransformBlock &#123;</span><br><span class="line">  <span class="type">float</span> scale;</span><br><span class="line">  <span class="type">vec3</span> translation;</span><br><span class="line">  <span class="type">float</span> rotate[<span class="number">3</span>];</span><br><span class="line">  <span class="type">mat4</span> projection_matrix;</span><br><span class="line">&#125; trans1, trans2;</span><br></pre></td></tr></table></figure>
<p>只能定义成一个数组：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 460 core</span></span><br><span class="line"><span class="keyword">uniform</span> TransformBlock &#123;</span><br><span class="line">  <span class="type">float</span> scale;</span><br><span class="line">  <span class="type">vec3</span> translation;</span><br><span class="line">  <span class="type">float</span> rotate[<span class="number">3</span>];</span><br><span class="line">  <span class="type">mat4</span> projection_matrix;</span><br><span class="line">&#125; transforms[<span class="number">2</span>];</span><br></pre></td></tr></table></figure>
<p>这样子就可以给 transforms[0] 和 transforms[1] 分配绑定不同的缓冲区对象了。</p>
<p>访问：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">gl_Position</span> =  transforms[<span class="number">0</span>].projection_matrix * <span class="type">vec4</span>(<span class="number">0.0</span>);</span><br></pre></td></tr></table></figure>
<p><strong>UBO的内存格式</strong></p>
<ul>
<li>标准布局：
<ul>
<li>数据类型的大小 N 字节，则数据的存储位置为 N 字节的整数倍：
<ul>
<li>int float bool：在 glsl 占用 4 字节，在缓冲区的存储地址为 4 的整数倍</li>
</ul>
</li>
<li>数据类型的大小 N 字节，则二维向量 与 2 * N 字节对齐
<ul>
<li>vec2 的存储位置与 2 * 4 = 8 字节对齐</li>
</ul>
</li>
<li>数据类型的大小 N 字节，三维、四维向量与 4 * N 字节对齐
<ul>
<li>vec3, vec4 的存储位置与 16字节对齐</li>
</ul>
</li>
<li>数组：每个元素和 4 * N 字节对齐</li>
<li>完整规则参考：<a target="_blank" rel="noopener" href="https://www.khronos.org/registry/OpenGL/specs/gl/glspec46.core.pdf">OpenGL 4.6规范</a> <code>7.6.2.2 Standard Uniform Block Layout</code></li>
<li>好处：可以预知 uniform 区块内的数据位置，因为这些在标准里已经定义好了，所有 OpenGL 实现都遵循这这个标准</li>
<li>坏处：数据对进行对齐，稍微浪费空间</li>
</ul>
</li>
<li>shared 布局：<br />
让 OpenGL 根据 uniform 区块的成员，自行决定其存储位置，会比标准布局高效，但是无法预知数据的存储位置，只能向 openGL 查询成员的位置后才能向 uniform 区块写入数据</li>
</ul>
<p>使用标准布局：在 uniform 关键字前加上 <code>layout(std140)</code></p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">layout</span>(<span class="keyword">std140</span>) <span class="keyword">uniform</span> TransformBlock &#123;</span><br><span class="line">  <span class="type">float</span> scale;</span><br><span class="line">  <span class="type">vec3</span> translation;</span><br><span class="line">  <span class="type">float</span> rotate[<span class="number">3</span>];</span><br><span class="line">  <span class="type">mat4</span> projection_matrix;</span><br><span class="line">&#125; transforms;</span><br></pre></td></tr></table></figure>
<p>内存布局如下：</p>
<ul>
<li>scale 的起始位置为 0 字节，占用 4 字节</li>
<li>translation：类型为 vec3，与 16 字节对齐，因此起始位置为 16 字节，占用 4 * 3 = 12 字节</li>
<li>rotate：每个元素与 16 字节对齐：
<ul>
<li>rotate[0]：起始位置为 32 字节</li>
<li>rotate[1]：起始位置为 48 字节</li>
<li>rotate[2]：起始位置为 64 字节</li>
</ul>
</li>
<li>mat4：可以看成 vec4 数组，每个元素与 16 字节对齐</li>
</ul>
<p>也可以直接指定 uniform 块内部成员的起始位置：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">layout</span>(<span class="keyword">std140</span>) <span class="keyword">uniform</span> ManuallyLaidOutBlock &#123;</span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">8</span>) <span class="type">vec2</span> bar;</span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">32</span>) <span class="type">vec3</span> foo;</span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">48</span>) <span class="type">vec3</span> baz;</span><br><span class="line">&#125; myBlock;</span><br></pre></td></tr></table></figure>
<p>指定成员的对齐位置时，成员的起始位置要满足上面的规则，如果不满足的话 shader 会编译失败：</p>
<figure class="highlight glsl"><figcaption><span>shader:</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># #version 460 core</span></span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">std140</span>) <span class="keyword">uniform</span> ManuallyLaidOutBlock &#123;</span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">7</span>) <span class="type">vec2</span> bar;</span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">15</span>) <span class="type">vec3</span> foo;</span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">48</span>) <span class="type">vec3</span> baz;</span><br><span class="line">&#125; myBlock;</span><br><span class="line"><span class="meta"># void main() &#123; &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight txt"><figcaption><span>错误输出</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">== 0:3(27): error: layout qualifier offset must be a multiple of the base alignment of vec2</span><br><span class="line">== 0:4(28): error: layout qualifier offset must be a multiple of the base alignment of vec3</span><br><span class="line">== 0:6(4): error: invalid qualifier xfb_offset=7 must be a multiple of the first component size of the first qualified variable or block member. Or double if an aggregate that contains a double (4).</span><br><span class="line">== 0:6(4): error: invalid qualifier xfb_offset=15 must be a multiple of the first component size of the first qualified variable or block member. Or double if an aggregate that contains a double (4).</span><br></pre></td></tr></table></figure>
<p>成员的顺序也很重要，前一个成员的内存位置必须小于后一个成员的位置：</p>
<figure class="highlight glsl"><figcaption><span>shader</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># #version 460 core</span></span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">std140</span>) <span class="keyword">uniform</span> ManuallyLaidOutBlock &#123;</span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">16</span>) <span class="type">vec3</span> foo;</span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">8</span>) <span class="type">vec2</span> bar;</span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">48</span>) <span class="type">vec3</span> baz;</span><br><span class="line">&#125; myBlock;</span><br><span class="line"><span class="meta"># void main() &#123; &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight txt"><figcaption><span>错误信息：</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">== 0:4(27): error: layout qualifier offset overlaps previous member</span><br></pre></td></tr></table></figure>
<p>设置最小对齐间隔：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">layout</span>(<span class="keyword">std140</span>, align = <span class="number">16</span>) <span class="keyword">uniform</span> ManuallyLaidOutBlock &#123;</span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">8</span>) <span class="type">vec2</span> bar;   <span class="comment">// At offset 16 bytes</span></span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">32</span>) <span class="type">vec3</span> foo;  <span class="comment">// At offset 32 bytes</span></span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">48</span>) <span class="type">vec3</span> baz;  <span class="comment">// At offset 48 bytes</span></span><br><span class="line">&#125; myBlock;</span><br></pre></td></tr></table></figure>
<p>shared 布局 OpenGL 使用的默认布局，定义的时候不用加任何修饰符：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uniform</span> TransformBlock &#123;</span><br><span class="line">  <span class="type">float</span> scale;</span><br><span class="line">  <span class="type">vec3</span> translation;</span><br><span class="line">  <span class="type">float</span> rotate[<span class="number">3</span>];</span><br><span class="line">  <span class="type">mat4</span> projection_matrix;</span><br><span class="line">&#125; transforms;</span><br></pre></td></tr></table></figure>
<p>在这个布局下，OpenGL会自己为 uniform 块的成员分配内存位置，这时候就不能自行指定成员起始位置：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># #version 460 core</span></span><br><span class="line"><span class="keyword">uniform</span> TransformBlock &#123;</span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">0</span>) <span class="type">float</span> scale;</span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">102</span>) <span class="type">vec3</span> translation;</span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">116</span>) <span class="type">float</span> rotate[<span class="number">3</span>];</span><br><span class="line">  <span class="keyword">layout</span> (<span class="keyword">offset</span> = <span class="number">135</span>) <span class="type">mat4</span> projection_matrix;</span><br><span class="line">&#125; transforms;</span><br><span class="line"><span class="meta"># </span></span><br><span class="line"><span class="meta"># void main() &#123;</span></span><br><span class="line"><span class="meta">#   gl_Position =  transforms.projection_matrix * vec4(0.0);</span></span><br><span class="line"><span class="meta"># &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight txt"><figcaption><span>编译错误：</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">== 0:3(28): error: offset can only be used with std430 and std140 layouts</span><br><span class="line">== 0:4(29): error: offset can only be used with std430 and std140 layouts</span><br><span class="line">== 0:5(30): error: offset can only be used with std430 and std140 layouts</span><br><span class="line">== 0:6(29): error: offset can only be used with std430 and std140 layouts</span><br></pre></td></tr></table></figure>
<p><strong>查询 uniform 区块成员的存储位置</strong></p>
<p>在 shared 布局下需要自己向 OpenGL 查询数据的位置和大小，因为OpenGL会按照自己的方式对数据的存放方式进行优化，此时在 OpenGL 程序里无法预知数据的位置，只能向 OpenGL 查询数据到底存在哪。查询过程：</p>
<p>查询某一成员在 uniform 区块里的位置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glGetUniformIndices</span><span class="params">(GLuint program,</span></span><br><span class="line"><span class="params">                         GLsizei uniformCount,</span></span><br><span class="line"><span class="params">                         <span class="type">const</span> GLchar **uniformNames,</span></span><br><span class="line"><span class="params">                         GLuint *uniformIndices)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>program</code>：uniform 区块所在的着色器程序</li>
<li><code>count</code>：要查询的成员个数，一般传 <code>uniformNames</code> 数组的元素个数</li>
<li><code>uniformNames</code>：要查询的成员，字符串数组</li>
<li><code>uniformIndices</code>：保存返回的成员位置</li>
</ul>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uniform</span> TransformBlock &#123;</span><br><span class="line">  <span class="type">float</span> scale;</span><br><span class="line">  <span class="type">vec3</span> translation;</span><br><span class="line">  <span class="type">float</span> rotate[<span class="number">3</span>];</span><br><span class="line">  <span class="type">mat4</span> projection_matrix;</span><br><span class="line">&#125; transforms;</span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::*;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   program: GLuint,</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs</span> = <span class="string">&quot;#version 460 core</span></span><br><span class="line"><span class="string">#     uniform TransformBlock &#123;</span></span><br><span class="line"><span class="string">#       float scale;</span></span><br><span class="line"><span class="string">#       vec3 translation;</span></span><br><span class="line"><span class="string">#       float rotate[3];</span></span><br><span class="line"><span class="string">#       mat4 projection_matrix;</span></span><br><span class="line"><span class="string">#     &#125; transforms;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       gl_Position =  transforms.projection_matrix * vec4(0.0);</span></span><br><span class="line"><span class="string">#     &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs</span> = <span class="string">&quot;#version 460 core</span></span><br><span class="line"><span class="string">#     out vec4 color;</span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       color = vec4(1.0);</span></span><br><span class="line"><span class="string">#     &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">program</span> = sb7::program::<span class="title function_ invoke__">link_from_shaders</span>(&amp;[</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(vs, gl::VERTEX_SHADER, <span class="literal">true</span>),</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(fs,gl::FRAGMENT_SHADER, <span class="literal">true</span>)</span><br><span class="line">#     ], <span class="literal">true</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">use</span> std::ffi::CString;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">uniform_names</span> = [CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.rotate&quot;</span>),</span><br><span class="line">                         CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.scale&quot;</span>),</span><br><span class="line">                         CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.translation&quot;</span>),</span><br><span class="line">                         CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.projection_matrix&quot;</span>)];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 指向字符串的指针数组</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">uniform_names</span> = uniform_names.<span class="title function_ invoke__">iter</span>()</span><br><span class="line">                                     .<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">as_ref</span>().<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">as_ptr</span>())</span><br><span class="line">                                     .collect::&lt;<span class="type">Box</span>&lt;[_]&gt;&gt;();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">uniform_indices</span> = [<span class="number">0u32</span>; <span class="number">4</span>];</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      gl::<span class="title function_ invoke__">GetUniformIndices</span>(program, <span class="number">4</span>,</span><br><span class="line">                            uniform_names.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">                            uniform_indices.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">    &#125;</span><br><span class="line">#     <span class="comment">// [2, 0, 1, 3]</span></span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, uniform_indices);</span><br><span class="line">#   &#125;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>通过返回的 <code>uniformIndices</code> 数组和 <code>glGetActiveUniformsiv()</code> 查询成员在缓冲区的位置、占用大小等信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glGetActiveUniformsiv</span><span class="params">(GLuint program,</span></span><br><span class="line"><span class="params">                           GLsizei uniformCount,</span></span><br><span class="line"><span class="params">                           <span class="type">const</span> GLuint *uniformIndices,</span></span><br><span class="line"><span class="params">                           GLenum pname,</span></span><br><span class="line"><span class="params">                           GLint *params)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><code>uniformIndices</code>、<code>uniformCount</code>：之前 <code>glGetUniformIndices()</code> 返回的数组</p>
</li>
<li>
<p><code>pname</code>：要查询的信息：</p>
<table>
<thead>
<tr>
<th style="text-align:left">pname 的取值</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GL_UNIFORM_TYPE</td>
<td style="text-align:left">成员数据类型</td>
</tr>
<tr>
<td style="text-align:left">GL_UNIFORM_SIZE</td>
<td style="text-align:left">成员是数组的话返回数组元素个数，不是数组返回 1</td>
</tr>
<tr>
<td style="text-align:left">GL_UNIFORM_NAME_LENGTH</td>
<td style="text-align:left">成员名称字符串长度</td>
</tr>
<tr>
<td style="text-align:left">GL_UNIFORM_BLOCK_INDEX</td>
<td style="text-align:left">成员所属区块的索引</td>
</tr>
<tr>
<td style="text-align:left">GL_UNIFORM_OFFSET</td>
<td style="text-align:left"><strong>成员在区块内的存储位置</strong></td>
</tr>
<tr>
<td style="text-align:left">GL_UNIFORM_ARRAY_STRIDE</td>
<td style="text-align:left">如果成员是数组，<strong>返回数组每个元素的大小</strong>，如果不是数组返回 0</td>
</tr>
<tr>
<td style="text-align:left">GL_UNIFORM_MATRIX_STRIDE</td>
<td style="text-align:left">如果成员是矩阵，<strong>返回矩阵每列（每行）的大小</strong>，如果不是矩阵返回 0</td>
</tr>
<tr>
<td style="text-align:left">GL_UNIFORM_IS_ROW_MAJOR</td>
<td style="text-align:left">如果成员是行优先矩阵返回 1，否则返回 0</td>
</tr>
</tbody>
</table>
</li>
<li>
<p><code>params</code>：查询返回结果</p>
</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::*;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> sb7::utils::*;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   program: GLuint,</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs</span> = <span class="string">&quot;#version 460 core</span></span><br><span class="line"><span class="string">#     uniform TransformBlock &#123;</span></span><br><span class="line"><span class="string">#       float scale;</span></span><br><span class="line"><span class="string">#       vec3 translation;</span></span><br><span class="line"><span class="string">#       float rotate[3];</span></span><br><span class="line"><span class="string">#       mat4 projection_matrix;</span></span><br><span class="line"><span class="string">#     &#125; transforms;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       gl_Position =  transforms.projection_matrix * vec4(0.0);</span></span><br><span class="line"><span class="string">#     &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs</span> = <span class="string">&quot;#version 460 core</span></span><br><span class="line"><span class="string">#     out vec4 color;</span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       color = vec4(1.0);</span></span><br><span class="line"><span class="string">#     &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">program</span> = <span class="title function_ invoke__">program</span>(&amp;[<span class="title function_ invoke__">shader</span>(gl::VERTEX_SHADER, vs),</span><br><span class="line">#                             <span class="title function_ invoke__">shader</span>(gl::FRAGMENT_SHADER, fs)]);</span><br><span class="line">#     <span class="comment">// 查询 uniform 成员的下标</span></span><br><span class="line">#     <span class="keyword">use</span> std::ffi::CString;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">uniform_names</span> = [CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.rotate&quot;</span>),</span><br><span class="line">                         CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.scale&quot;</span>),</span><br><span class="line">                         CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.translation&quot;</span>),</span><br><span class="line">                         CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.projection_matrix&quot;</span>)];</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">uniform_names</span> = uniform_names.<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">into_raw</span>());</span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">uniform_indices</span> = [<span class="number">0u32</span>; <span class="number">4</span>];</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetUniformIndices</span>(program, <span class="number">4</span>, uniform_names.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _,</span><br><span class="line">#                             uniform_indices.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">_</span> = uniform_names.<span class="title function_ invoke__">map</span>(|s| CString::<span class="title function_ invoke__">from_raw</span>(s)); <span class="comment">// 回收内存</span></span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 查询 uniform 成员的内存起始位置，每个元素的大小</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">uniform_offsets</span> = [<span class="number">0</span>; <span class="number">4</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr_strides</span> = [<span class="number">0</span>; <span class="number">4</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">mat_strides</span> = [<span class="number">0</span>; <span class="number">4</span>];</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(program, <span class="number">4</span>, uniform_indices.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">                              gl::UNIFORM_OFFSET,</span><br><span class="line">                              uniform_offsets.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">      gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(program, <span class="number">4</span>, uniform_indices.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">                              gl::UNIFORM_ARRAY_STRIDE,</span><br><span class="line">                              arr_strides.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">      gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(program, <span class="number">4</span>, uniform_indices.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">                              gl::UNIFORM_MATRIX_STRIDE,</span><br><span class="line">                              mat_strides.<span class="title function_ invoke__">as_mut_ptr</span>())</span><br><span class="line">    &#125;</span><br><span class="line">#   &#125;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>这样就得到各个成员在缓冲区的位置和占用大小了：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::*;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   program: GLuint,</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">vs</span> = <span class="string">&quot;#version 460 core</span></span><br><span class="line"><span class="string">    uniform TransformBlock &#123;</span></span><br><span class="line"><span class="string">      float scale;</span></span><br><span class="line"><span class="string">      vec3 translation;</span></span><br><span class="line"><span class="string">      float rotate[3];</span></span><br><span class="line"><span class="string">      mat4 projection_matrix;</span></span><br><span class="line"><span class="string">    &#125; transforms;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    void main() &#123;</span></span><br><span class="line"><span class="string">      gl_Position =  transforms.projection_matrix * vec4(0.0);</span></span><br><span class="line"><span class="string">    &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs</span> = <span class="string">&quot;#version 460 core</span></span><br><span class="line"><span class="string">#     out vec4 color;</span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       color = vec4(1.0);</span></span><br><span class="line"><span class="string">#     &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">program</span> = sb7::program::<span class="title function_ invoke__">link_from_shaders</span>(&amp;[</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(vs, gl::VERTEX_SHADER, <span class="literal">true</span>),</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(fs,gl::FRAGMENT_SHADER, <span class="literal">true</span>)</span><br><span class="line">#     ], <span class="literal">true</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">use</span> std::ffi::CString;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">uniform_names</span> = [CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.rotate&quot;</span>),</span><br><span class="line">                         CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.scale&quot;</span>),</span><br><span class="line">                         CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.translation&quot;</span>),</span><br><span class="line">                         CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.projection_matrix&quot;</span>)];</span><br><span class="line">#     </span><br><span class="line">#     <span class="comment">// 指向字符串的指针数组</span></span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">uniform_names</span> = uniform_names.<span class="title function_ invoke__">iter</span>()</span><br><span class="line">#                                      .<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">as_ref</span>().<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">as_ptr</span>())</span><br><span class="line">#                                      .collect::&lt;<span class="type">Box</span>&lt;[_]&gt;&gt;();</span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">uniform_indices</span> = [<span class="number">0u32</span>; <span class="number">4</span>];</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetUniformIndices</span>(program, <span class="number">4</span>,</span><br><span class="line">#                             uniform_names.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                             uniform_indices.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#     &#125;</span><br><span class="line">#     <span class="comment">// [2, 0, 1, 3]</span></span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, uniform_indices);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">offsets</span>     = [<span class="number">0i32</span>; <span class="number">4</span>];</span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr_strides</span> = [<span class="number">0i32</span>; <span class="number">4</span>];</span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">mat_strides</span> = [<span class="number">0i32</span>; <span class="number">4</span>];</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(program, <span class="number">4</span>, uniform_indices.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                               gl::UNIFORM_OFFSET,</span><br><span class="line">#                               offsets.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(program, <span class="number">4</span>, uniform_indices.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                               gl::UNIFORM_ARRAY_STRIDE,</span><br><span class="line">#                               arr_strides.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(program, <span class="number">4</span>, uniform_indices.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                               gl::UNIFORM_MATRIX_STRIDE,</span><br><span class="line">#                               mat_strides.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;rotate: offset = &#123;&#125;, stride = &#123;&#125;&quot;</span>,</span><br><span class="line">              offsets[<span class="number">0</span>], arr_strides[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;scale: offset = &#123;&#125;&quot;</span>, offsets[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;translation: offset = &#123;&#125;&quot;</span>, offsets[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;projection_matrix: offset = &#123;&#125;, stride = &#123;&#125;&quot;</span>,</span><br><span class="line">              offsets[<span class="number">3</span>], mat_strides[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">#   &#125;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight txt"><figcaption><span>输出：</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rotate: offset = 28, stride = 4</span><br><span class="line">scale: offset = 0</span><br><span class="line">translation: offset = 16</span><br><span class="line">projection_matrix: offset = 48, stride = 16</span><br></pre></td></tr></table></figure>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uniform</span> TransformBlock &#123;</span><br><span class="line">  <span class="type">float</span> scale;</span><br><span class="line">  <span class="type">vec3</span> translation;</span><br><span class="line">  <span class="type">float</span> rotate[<span class="number">3</span>];</span><br><span class="line">  <span class="type">mat4</span> projection_matrix;</span><br><span class="line">&#125; transforms;</span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">uniform_names</span> = [CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.rotate&quot;</span>),</span><br><span class="line">                     CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.scale&quot;</span>),</span><br><span class="line">                     CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.translation&quot;</span>),</span><br><span class="line">                     CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.projection_matrix&quot;</span>)];</span><br></pre></td></tr></table></figure>
<p>在查询 uniform 区块的内存布局之后，分配内存，写入数据。最简单的情况，写入 float 变量：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">data</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>([<span class="number">0u8</span>; <span class="number">4096</span>]);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">ptr</span> =  data.<span class="title function_ invoke__">as_ptr</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">offset</span> = offsets[<span class="number">1</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">  *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>) = <span class="number">3.0f32</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写入 vec3 变量：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsafe</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">offset</span> = offsets[<span class="number">2</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">  *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>).<span class="title function_ invoke__">add</span>(<span class="number">0</span>) = <span class="number">1.0f32</span>;</span><br><span class="line">  *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>).<span class="title function_ invoke__">add</span>(<span class="number">1</span>) = <span class="number">2.0f32</span>;</span><br><span class="line">  *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>).<span class="title function_ invoke__">add</span>(<span class="number">2</span>) = <span class="number">3.0f32</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写入数组：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">rotates</span>: [<span class="type">f32</span>; <span class="number">3</span>] = [<span class="number">30.0</span>, <span class="number">40.0</span>, <span class="number">50.0</span>];</span><br><span class="line"><span class="keyword">unsafe</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">offset</span> = offsets[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">  <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">3</span> &#123;</span><br><span class="line">    *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>) = rotates[i];</span><br><span class="line">    offset += arr_strides[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写入 mat4 变量：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 以列为主的矩阵</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">mat</span> : [<span class="type">f32</span>; <span class="number">16</span>]=  [ <span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>,</span><br><span class="line">                        <span class="number">9.0</span>, <span class="number">8.0</span>, <span class="number">7.0</span>, <span class="number">6.0</span>,</span><br><span class="line">                        <span class="number">2.0</span>, <span class="number">4.0</span>, <span class="number">6.0</span>, <span class="number">8.0</span>,</span><br><span class="line">                        <span class="number">1.0</span>, <span class="number">3.0</span>, <span class="number">5.0</span>, <span class="number">7.0</span> ];</span><br><span class="line"><span class="keyword">for</span> <span class="variable">col</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">4</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">offset</span> = offsets[<span class="number">3</span>] <span class="keyword">as</span> <span class="type">usize</span></span><br><span class="line">                 + mat_strides[<span class="number">3</span>] <span class="keyword">as</span> <span class="type">usize</span> * col;</span><br><span class="line">  <span class="keyword">for</span> <span class="variable">row</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">4</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>) = mat[col * <span class="number">4</span> + row] &#125;;</span><br><span class="line">    offset += std::mem::size_of::&lt;<span class="type">f32</span>&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>绑定 uniform 区块和缓冲区对象</strong></p>
<p>创建缓冲对象，将上面准备好的内存写入缓冲：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::*;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   program: GLuint,</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs</span> = <span class="string">&quot;#version 460 core</span></span><br><span class="line"><span class="string">#     uniform TransformBlock &#123;</span></span><br><span class="line"><span class="string">#       float scale;</span></span><br><span class="line"><span class="string">#       vec3 translation;</span></span><br><span class="line"><span class="string">#       float rotate[3];</span></span><br><span class="line"><span class="string">#       mat4 projection_matrix;</span></span><br><span class="line"><span class="string">#     &#125; transforms;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       gl_Position =  transforms.projection_matrix * vec4(0.0);</span></span><br><span class="line"><span class="string">#     &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs</span> = <span class="string">&quot;#version 460 core</span></span><br><span class="line"><span class="string">#     out vec4 color;</span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       color = vec4(1.0);</span></span><br><span class="line"><span class="string">#     &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">program</span> = sb7::program::<span class="title function_ invoke__">link_from_shaders</span>(&amp;[</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(vs, gl::VERTEX_SHADER, <span class="literal">true</span>),</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(fs,gl::FRAGMENT_SHADER, <span class="literal">true</span>)</span><br><span class="line">#     ], <span class="literal">true</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">use</span> std::ffi::CString;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">uniform_names</span> = [CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.rotate&quot;</span>),</span><br><span class="line">#                          CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.scale&quot;</span>),</span><br><span class="line">#                          CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.translation&quot;</span>),</span><br><span class="line">#                          CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.projection_matrix&quot;</span>)];</span><br><span class="line">#     </span><br><span class="line">#     <span class="comment">// 指向字符串的指针数组</span></span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">uniform_names</span> = uniform_names.<span class="title function_ invoke__">iter</span>()</span><br><span class="line">#                                      .<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">as_ref</span>().<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">as_ptr</span>())</span><br><span class="line">#                                      .collect::&lt;<span class="type">Box</span>&lt;[_]&gt;&gt;();</span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">uniform_indices</span> = [<span class="number">0u32</span>; <span class="number">4</span>];</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetUniformIndices</span>(program, <span class="number">4</span>,</span><br><span class="line">#                             uniform_names.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                             uniform_indices.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#     &#125;</span><br><span class="line">#     <span class="comment">// [2, 0, 1, 3]</span></span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, uniform_indices);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">offsets</span>     = [<span class="number">0i32</span>; <span class="number">4</span>];</span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr_strides</span> = [<span class="number">0i32</span>; <span class="number">4</span>];</span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">mat_strides</span> = [<span class="number">0i32</span>; <span class="number">4</span>];</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(program, <span class="number">4</span>, uniform_indices.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                               gl::UNIFORM_OFFSET,</span><br><span class="line">#                               offsets.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(program, <span class="number">4</span>, uniform_indices.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                               gl::UNIFORM_ARRAY_STRIDE,</span><br><span class="line">#                               arr_strides.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(program, <span class="number">4</span>, uniform_indices.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                               gl::UNIFORM_MATRIX_STRIDE,</span><br><span class="line">#                               mat_strides.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;rotate: offset = &#123;&#125;, stride = &#123;&#125;&quot;</span>,</span><br><span class="line">#               offsets[<span class="number">0</span>], arr_strides[<span class="number">0</span>]);</span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;scale: offset = &#123;&#125;&quot;</span>, offsets[<span class="number">1</span>]);</span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;translation: offset = &#123;&#125;&quot;</span>, offsets[<span class="number">2</span>]);</span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;projection_matrix: offset = &#123;&#125;, stride = &#123;&#125;&quot;</span>,</span><br><span class="line">#               offsets[<span class="number">3</span>], mat_strides[<span class="number">3</span>]);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">data</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>([<span class="number">0u8</span>; <span class="number">4096</span>]);</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">ptr</span> =  data.<span class="title function_ invoke__">as_ptr</span>();</span><br><span class="line">#     </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">offset</span> = offsets[<span class="number">1</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">#       *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>) = <span class="number">3.0f32</span>;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">offset</span> = offsets[<span class="number">2</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">#       *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>).<span class="title function_ invoke__">add</span>(<span class="number">0</span>) = <span class="number">1.0f32</span>;</span><br><span class="line">#       *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>).<span class="title function_ invoke__">add</span>(<span class="number">1</span>) = <span class="number">2.0f32</span>;</span><br><span class="line">#       *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>).<span class="title function_ invoke__">add</span>(<span class="number">2</span>) = <span class="number">3.0f32</span>;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">rotates</span>: [<span class="type">f32</span>; <span class="number">3</span>] = [<span class="number">30.0</span>, <span class="number">40.0</span>, <span class="number">50.0</span>];</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">offset</span> = offsets[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">#       <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">3</span> &#123;</span><br><span class="line">#         *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>) = rotates[i];</span><br><span class="line">#         offset += arr_strides[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">#       &#125;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">mat</span> : [<span class="type">f32</span>; <span class="number">16</span>]=  [ <span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>,</span><br><span class="line">#                             <span class="number">9.0</span>, <span class="number">8.0</span>, <span class="number">7.0</span>, <span class="number">6.0</span>,</span><br><span class="line">#                             <span class="number">2.0</span>, <span class="number">4.0</span>, <span class="number">6.0</span>, <span class="number">8.0</span>,</span><br><span class="line">#                             <span class="number">1.0</span>, <span class="number">3.0</span>, <span class="number">5.0</span>, <span class="number">7.0</span> ];</span><br><span class="line">#     <span class="keyword">for</span> <span class="variable">col</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">4</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">offset</span> = offsets[<span class="number">3</span>] <span class="keyword">as</span> <span class="type">usize</span></span><br><span class="line">#                     + mat_strides[<span class="number">3</span>] <span class="keyword">as</span> <span class="type">usize</span> * col;</span><br><span class="line">#       <span class="keyword">for</span> <span class="variable">row</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">4</span> &#123;</span><br><span class="line">#         <span class="keyword">unsafe</span> &#123; *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>) = mat[col * <span class="number">4</span> + row] &#125;;</span><br><span class="line">#         offset += std::mem::size_of::&lt;<span class="type">f32</span>&gt;();</span><br><span class="line">#       &#125;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">uniform_buf</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> uniform_buf);</span><br><span class="line">      gl::<span class="title function_ invoke__">NamedBufferStorage</span>(uniform_buf, data.<span class="title function_ invoke__">len</span>() <span class="keyword">as</span> _,</span><br><span class="line">                             data.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _, gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">BindBufferBase</span>(gl::UNIFORM_BUFFER, <span class="number">0</span>, uniform_buf);</span><br><span class="line">#       </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">name</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">uniform_blk_index</span> = gl::<span class="title function_ invoke__">GetUniformBlockIndex</span>(program, name.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">UniformBlockBinding</span>(program, uniform_blk_index, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">#   &#125;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>用 <code>glBindBufferBase()</code> 将缓冲区绑定到 <code>GL_UNIFORM_BUFFER</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glBindBufferBase</span><span class="params">(GLenum target,</span></span><br><span class="line"><span class="params">                      GLuint index,</span></span><br><span class="line"><span class="params">                      GLuint buffer)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>index</code>：自己给缓冲区指定的绑定下标，后面调 <code>glUniformBlockBinding()</code> 的时候要用</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::*;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   program: GLuint,</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs</span> = <span class="string">&quot;#version 460 core</span></span><br><span class="line"><span class="string">#     uniform TransformBlock &#123;</span></span><br><span class="line"><span class="string">#       float scale;</span></span><br><span class="line"><span class="string">#       vec3 translation;</span></span><br><span class="line"><span class="string">#       float rotate[3];</span></span><br><span class="line"><span class="string">#       mat4 projection_matrix;</span></span><br><span class="line"><span class="string">#     &#125; transforms;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       gl_Position =  transforms.projection_matrix * vec4(0.0);</span></span><br><span class="line"><span class="string">#     &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs</span> = <span class="string">&quot;#version 460 core</span></span><br><span class="line"><span class="string">#     out vec4 color;</span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       color = vec4(1.0);</span></span><br><span class="line"><span class="string">#     &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">program</span> = sb7::program::<span class="title function_ invoke__">link_from_shaders</span>(&amp;[</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(vs, gl::VERTEX_SHADER, <span class="literal">true</span>),</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(fs,gl::FRAGMENT_SHADER, <span class="literal">true</span>)</span><br><span class="line">#     ], <span class="literal">true</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">use</span> std::ffi::CString;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">uniform_names</span> = [CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.rotate&quot;</span>),</span><br><span class="line">#                          CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.scale&quot;</span>),</span><br><span class="line">#                          CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.translation&quot;</span>),</span><br><span class="line">#                          CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.projection_matrix&quot;</span>)];</span><br><span class="line">#     </span><br><span class="line">#     <span class="comment">// 指向字符串的指针数组</span></span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">uniform_names</span> = uniform_names.<span class="title function_ invoke__">iter</span>()</span><br><span class="line">#                                      .<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">as_ref</span>().<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">as_ptr</span>())</span><br><span class="line">#                                      .collect::&lt;<span class="type">Box</span>&lt;[_]&gt;&gt;();</span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">uniform_indices</span> = [<span class="number">0u32</span>; <span class="number">4</span>];</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetUniformIndices</span>(program, <span class="number">4</span>,</span><br><span class="line">#                             uniform_names.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                             uniform_indices.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#     &#125;</span><br><span class="line">#     <span class="comment">// [2, 0, 1, 3]</span></span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, uniform_indices);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">offsets</span>     = [<span class="number">0i32</span>; <span class="number">4</span>];</span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr_strides</span> = [<span class="number">0i32</span>; <span class="number">4</span>];</span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">mat_strides</span> = [<span class="number">0i32</span>; <span class="number">4</span>];</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(program, <span class="number">4</span>, uniform_indices.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                               gl::UNIFORM_OFFSET,</span><br><span class="line">#                               offsets.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(program, <span class="number">4</span>, uniform_indices.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                               gl::UNIFORM_ARRAY_STRIDE,</span><br><span class="line">#                               arr_strides.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(program, <span class="number">4</span>, uniform_indices.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                               gl::UNIFORM_MATRIX_STRIDE,</span><br><span class="line">#                               mat_strides.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;rotate: offset = &#123;&#125;, stride = &#123;&#125;&quot;</span>,</span><br><span class="line">#               offsets[<span class="number">0</span>], arr_strides[<span class="number">0</span>]);</span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;scale: offset = &#123;&#125;&quot;</span>, offsets[<span class="number">1</span>]);</span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;translation: offset = &#123;&#125;&quot;</span>, offsets[<span class="number">2</span>]);</span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;projection_matrix: offset = &#123;&#125;, stride = &#123;&#125;&quot;</span>,</span><br><span class="line">#               offsets[<span class="number">3</span>], mat_strides[<span class="number">3</span>]);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">data</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>([<span class="number">0u8</span>; <span class="number">4096</span>]);</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">ptr</span> =  data.<span class="title function_ invoke__">as_ptr</span>();</span><br><span class="line">#     </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">offset</span> = offsets[<span class="number">1</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">#       *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>) = <span class="number">3.0f32</span>;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">offset</span> = offsets[<span class="number">2</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">#       *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>).<span class="title function_ invoke__">add</span>(<span class="number">0</span>) = <span class="number">1.0f32</span>;</span><br><span class="line">#       *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>).<span class="title function_ invoke__">add</span>(<span class="number">1</span>) = <span class="number">2.0f32</span>;</span><br><span class="line">#       *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>).<span class="title function_ invoke__">add</span>(<span class="number">2</span>) = <span class="number">3.0f32</span>;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">rotates</span>: [<span class="type">f32</span>; <span class="number">3</span>] = [<span class="number">30.0</span>, <span class="number">40.0</span>, <span class="number">50.0</span>];</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">offset</span> = offsets[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">#       <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">3</span> &#123;</span><br><span class="line">#         *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>) = rotates[i];</span><br><span class="line">#         offset += arr_strides[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">#       &#125;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">mat</span> : [<span class="type">f32</span>; <span class="number">16</span>]=  [ <span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>,</span><br><span class="line">#                             <span class="number">9.0</span>, <span class="number">8.0</span>, <span class="number">7.0</span>, <span class="number">6.0</span>,</span><br><span class="line">#                             <span class="number">2.0</span>, <span class="number">4.0</span>, <span class="number">6.0</span>, <span class="number">8.0</span>,</span><br><span class="line">#                             <span class="number">1.0</span>, <span class="number">3.0</span>, <span class="number">5.0</span>, <span class="number">7.0</span> ];</span><br><span class="line">#     <span class="keyword">for</span> <span class="variable">col</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">4</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">offset</span> = offsets[<span class="number">3</span>] <span class="keyword">as</span> <span class="type">usize</span></span><br><span class="line">#                     + mat_strides[<span class="number">3</span>] <span class="keyword">as</span> <span class="type">usize</span> * col;</span><br><span class="line">#       <span class="keyword">for</span> <span class="variable">row</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">4</span> &#123;</span><br><span class="line">#         <span class="keyword">unsafe</span> &#123; *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>) = mat[col * <span class="number">4</span> + row] &#125;;</span><br><span class="line">#         offset += std::mem::size_of::&lt;<span class="type">f32</span>&gt;();</span><br><span class="line">#       &#125;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">uniform_buf</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> uniform_buf);</span><br><span class="line">      gl::<span class="title function_ invoke__">NamedBufferStorage</span>(uniform_buf, data.<span class="title function_ invoke__">len</span>() <span class="keyword">as</span> _,</span><br><span class="line">                             data.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _, gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line"></span><br><span class="line">      gl::<span class="title function_ invoke__">BindBufferBase</span>(gl::UNIFORM_BUFFER, <span class="number">0</span>, uniform_buf);</span><br><span class="line">#       </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">name</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">uniform_blk_index</span> = gl::<span class="title function_ invoke__">GetUniformBlockIndex</span>(program, name.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">UniformBlockBinding</span>(program, uniform_blk_index, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">#   &#125;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>用 <code>glGetUniformBlockIndex()</code> 查询 uniform 区块的位置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GLuint <span class="title function_">glGetUniformBlockIndex</span><span class="params">(GLuint program,</span></span><br><span class="line"><span class="params">                              <span class="type">const</span> GLchar *uniformBlockName)</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::*;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   program: GLuint,</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs</span> = <span class="string">&quot;#version 460 core</span></span><br><span class="line"><span class="string">#     uniform TransformBlock &#123;</span></span><br><span class="line"><span class="string">#       float scale;</span></span><br><span class="line"><span class="string">#       vec3 translation;</span></span><br><span class="line"><span class="string">#       float rotate[3];</span></span><br><span class="line"><span class="string">#       mat4 projection_matrix;</span></span><br><span class="line"><span class="string">#     &#125; transforms;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       gl_Position =  transforms.projection_matrix * vec4(0.0);</span></span><br><span class="line"><span class="string">#     &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs</span> = <span class="string">&quot;#version 460 core</span></span><br><span class="line"><span class="string">#     out vec4 color;</span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       color = vec4(1.0);</span></span><br><span class="line"><span class="string">#     &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">program</span> = sb7::program::<span class="title function_ invoke__">link_from_shaders</span>(&amp;[</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(vs, gl::VERTEX_SHADER, <span class="literal">true</span>),</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(fs,gl::FRAGMENT_SHADER, <span class="literal">true</span>)</span><br><span class="line">#     ], <span class="literal">true</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">use</span> std::ffi::CString;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">uniform_names</span> = [CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.rotate&quot;</span>),</span><br><span class="line">#                          CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.scale&quot;</span>),</span><br><span class="line">#                          CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.translation&quot;</span>),</span><br><span class="line">#                          CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.projection_matrix&quot;</span>)];</span><br><span class="line">#     </span><br><span class="line">#     <span class="comment">// 指向字符串的指针数组</span></span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">uniform_names</span> = uniform_names.<span class="title function_ invoke__">iter</span>()</span><br><span class="line">#                                      .<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">as_ref</span>().<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">as_ptr</span>())</span><br><span class="line">#                                      .collect::&lt;<span class="type">Box</span>&lt;[_]&gt;&gt;();</span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">uniform_indices</span> = [<span class="number">0u32</span>; <span class="number">4</span>];</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetUniformIndices</span>(program, <span class="number">4</span>,</span><br><span class="line">#                             uniform_names.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                             uniform_indices.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#     &#125;</span><br><span class="line">#     <span class="comment">// [2, 0, 1, 3]</span></span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, uniform_indices);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">offsets</span>     = [<span class="number">0i32</span>; <span class="number">4</span>];</span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr_strides</span> = [<span class="number">0i32</span>; <span class="number">4</span>];</span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">mat_strides</span> = [<span class="number">0i32</span>; <span class="number">4</span>];</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(program, <span class="number">4</span>, uniform_indices.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                               gl::UNIFORM_OFFSET,</span><br><span class="line">#                               offsets.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(program, <span class="number">4</span>, uniform_indices.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                               gl::UNIFORM_ARRAY_STRIDE,</span><br><span class="line">#                               arr_strides.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(program, <span class="number">4</span>, uniform_indices.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">#                               gl::UNIFORM_MATRIX_STRIDE,</span><br><span class="line">#                               mat_strides.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;rotate: offset = &#123;&#125;, stride = &#123;&#125;&quot;</span>,</span><br><span class="line">#               offsets[<span class="number">0</span>], arr_strides[<span class="number">0</span>]);</span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;scale: offset = &#123;&#125;&quot;</span>, offsets[<span class="number">1</span>]);</span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;translation: offset = &#123;&#125;&quot;</span>, offsets[<span class="number">2</span>]);</span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;projection_matrix: offset = &#123;&#125;, stride = &#123;&#125;&quot;</span>,</span><br><span class="line">#               offsets[<span class="number">3</span>], mat_strides[<span class="number">3</span>]);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">data</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>([<span class="number">0u8</span>; <span class="number">4096</span>]);</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">ptr</span> =  data.<span class="title function_ invoke__">as_ptr</span>();</span><br><span class="line">#     </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">offset</span> = offsets[<span class="number">1</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">#       *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>) = <span class="number">3.0f32</span>;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">offset</span> = offsets[<span class="number">2</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">#       *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>).<span class="title function_ invoke__">add</span>(<span class="number">0</span>) = <span class="number">1.0f32</span>;</span><br><span class="line">#       *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>).<span class="title function_ invoke__">add</span>(<span class="number">1</span>) = <span class="number">2.0f32</span>;</span><br><span class="line">#       *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>).<span class="title function_ invoke__">add</span>(<span class="number">2</span>) = <span class="number">3.0f32</span>;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">rotates</span>: [<span class="type">f32</span>; <span class="number">3</span>] = [<span class="number">30.0</span>, <span class="number">40.0</span>, <span class="number">50.0</span>];</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">offset</span> = offsets[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">#       <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">3</span> &#123;</span><br><span class="line">#         *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>) = rotates[i];</span><br><span class="line">#         offset += arr_strides[<span class="number">0</span>] <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">#       &#125;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">mat</span> : [<span class="type">f32</span>; <span class="number">16</span>]=  [ <span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>,</span><br><span class="line">#                             <span class="number">9.0</span>, <span class="number">8.0</span>, <span class="number">7.0</span>, <span class="number">6.0</span>,</span><br><span class="line">#                             <span class="number">2.0</span>, <span class="number">4.0</span>, <span class="number">6.0</span>, <span class="number">8.0</span>,</span><br><span class="line">#                             <span class="number">1.0</span>, <span class="number">3.0</span>, <span class="number">5.0</span>, <span class="number">7.0</span> ];</span><br><span class="line">#     <span class="keyword">for</span> <span class="variable">col</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">4</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">offset</span> = offsets[<span class="number">3</span>] <span class="keyword">as</span> <span class="type">usize</span></span><br><span class="line">#                     + mat_strides[<span class="number">3</span>] <span class="keyword">as</span> <span class="type">usize</span> * col;</span><br><span class="line">#       <span class="keyword">for</span> <span class="variable">row</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">4</span> &#123;</span><br><span class="line">#         <span class="keyword">unsafe</span> &#123; *(ptr.<span class="title function_ invoke__">add</span>(offset) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">f32</span>) = mat[col * <span class="number">4</span> + row] &#125;;</span><br><span class="line">#         offset += std::mem::size_of::&lt;<span class="type">f32</span>&gt;();</span><br><span class="line">#       &#125;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">uniform_buf</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> uniform_buf);</span><br><span class="line">      gl::<span class="title function_ invoke__">NamedBufferStorage</span>(uniform_buf, data.<span class="title function_ invoke__">len</span>() <span class="keyword">as</span> _,</span><br><span class="line">                             data.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _, gl::DYNAMIC_STORAGE_BIT);</span><br><span class="line"></span><br><span class="line">      gl::<span class="title function_ invoke__">BindBufferBase</span>(gl::UNIFORM_BUFFER, <span class="number">0</span>, uniform_buf);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">let</span> <span class="variable">name</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">uniform_blk_index</span> = gl::<span class="title function_ invoke__">GetUniformBlockIndex</span>(program,</span><br><span class="line">                                                       name.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">UniformBlockBinding</span>(program, uniform_blk_index, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">#   &#125;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.program);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>最后用 <code>glUniformBlockBinding()</code> 将缓冲区对象与 uniform 区块向绑定：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glUniformBlockBinding</span><span class="params">(GLuint program,</span></span><br><span class="line"><span class="params">                           GLuint uniformBlockIndex,</span></span><br><span class="line"><span class="params">                           GLuint uniformBlockBinding)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>uniformBlockIndex</code>：<code>glGetUniformBlockIndex()</code> 返回的 uniform 区块下标</li>
<li><code>uniformBlockBinding</code>：缓冲区对象调用 <code>glBindBufferBase()</code> 时设置的 <code>index</code></li>
</ul>
<p>这样就完成了缓冲区对象和 uniform 区块之间的绑定</p>
<p>缓冲区对象和 uniform 区块之间的关系：</p>
<p><img src="./uniform_blk_buffers.png" alt="uniform block and buffers match" /></p>
<p>上图对应的处理代码如下：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [harry_index, bob_index, susan_index] = [<span class="string">&quot;Harry&quot;</span>, <span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;Susan&quot;</span>]</span><br><span class="line">  .<span class="title function_ invoke__">map</span>(|s| CString::<span class="title function_ invoke__">new</span>(s).<span class="title function_ invoke__">unwrap</span>())</span><br><span class="line">  .<span class="title function_ invoke__">map</span>(|s| gl::<span class="title function_ invoke__">GetUniformBlockIndex</span>(program, s.<span class="title function_ invoke__">as_ptr</span>()));</span><br><span class="line"></span><br><span class="line">gl::<span class="title function_ invoke__">UniformBlockBinding</span>(program, harry_index, <span class="number">1</span>);</span><br><span class="line">gl::<span class="title function_ invoke__">BindBufferBase</span>(gl::UNIFORM_BUFFER, <span class="number">1</span>, buf_c);</span><br><span class="line"></span><br><span class="line">gl::<span class="title function_ invoke__">UniformBlockBinding</span>(program, bob_index, <span class="number">3</span>);</span><br><span class="line">gl::<span class="title function_ invoke__">BindBufferBase</span>(gl::UNIFORM_BUFFER, <span class="number">3</span>, buf_a);</span><br><span class="line"></span><br><span class="line">gl::<span class="title function_ invoke__">UniformBlockBinding</span>(program, susan_index, <span class="number">0</span>);</span><br><span class="line">gl::<span class="title function_ invoke__">BindBufferBase</span>(gl::UNIFORM_BUFFER, buf_b, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>uniform  区块的绑定的缓冲区对象下标也可以在着色器里指定：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">1</span>) <span class="keyword">uniform</span> Harry &#123;</span><br><span class="line"><span class="meta">#   float a;</span></span><br><span class="line"><span class="meta">#   mat4 b;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> (<span class="keyword">binding</span> = <span class="number">3</span>) Bob &#123;</span><br><span class="line"><span class="meta">#   int c;</span></span><br><span class="line"><span class="meta">#   ivec4 d;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> (<span class="keyword">binding</span> = <span class="number">0</span>) Susan &#123;</span><br><span class="line"><span class="meta">#   mat4 e[10];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这样子就可以删除 <code>UniformBlockBinding()</code> 函数了：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gl::<span class="title function_ invoke__">BindBufferBase</span>(gl::UNIFORM_BUFFER, <span class="number">1</span>, buf_c);</span><br><span class="line">gl::<span class="title function_ invoke__">BindBufferBase</span>(gl::UNIFORM_BUFFER, <span class="number">3</span>, buf_a);</span><br><span class="line">gl::<span class="title function_ invoke__">BindBufferBase</span>(gl::UNIFORM_BUFFER, <span class="number">0</span>, buf_b);</span><br></pre></td></tr></table></figure>
<p>回到之前使用标准布局的 uniform 区块，根据规范可以推断出各个成员的位置：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">layout</span>(<span class="keyword">std140</span>) <span class="keyword">uniform</span> TransformBlock &#123;</span><br><span class="line">  <span class="type">float</span> scale;            <span class="comment">// offset: 0</span></span><br><span class="line">  <span class="type">vec3</span> translation;       <span class="comment">// offset: 16</span></span><br><span class="line">  <span class="type">float</span> rotate[<span class="number">3</span>];        <span class="comment">// offset: 32, stride: 16</span></span><br><span class="line">  <span class="type">mat4</span> projection_matrix; <span class="comment">// offset: 80, stride: 16</span></span><br><span class="line">&#125; transforms;</span><br></pre></td></tr></table></figure>
<p>现在可以用 <code>glGetActiveUniformsiv()</code> 来验证了：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> std::ffi::CString;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span>;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#     #version 460 core</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     layout(std140) uniform TransformBlock &#123;</span></span><br><span class="line"><span class="string">#       float scale;</span></span><br><span class="line"><span class="string">#       vec3 translation;</span></span><br><span class="line"><span class="string">#       float rotate[3];</span></span><br><span class="line"><span class="string">#       mat4 projection_matrix;</span></span><br><span class="line"><span class="string">#     &#125; trans;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       gl_Position = trans.scale * vec4(1.0);</span></span><br><span class="line"><span class="string">#     &#125;</span></span><br><span class="line"><span class="string">#     &quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#     #version 460 core</span></span><br><span class="line"><span class="string">#     out vec4 color;</span></span><br><span class="line"><span class="string">#     void main() &#123; color = vec4(1.0); &#125;</span></span><br><span class="line"><span class="string">#     &quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">prog</span> = sb7::program::<span class="title function_ invoke__">link_from_shaders</span>(&amp;[</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(vs, gl::VERTEX_SHADER, <span class="literal">true</span>),</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(fs, gl::FRAGMENT_SHADER, <span class="literal">true</span>),</span><br><span class="line">#     ], <span class="literal">true</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">names</span> = [</span><br><span class="line">        CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.scale&quot;</span>),</span><br><span class="line">        CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.translation&quot;</span>),</span><br><span class="line">        CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.rotate&quot;</span>),</span><br><span class="line">        CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;TransformBlock.projection_matrix&quot;</span>),</span><br><span class="line">      ];</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">names</span> = names.<span class="title function_ invoke__">iter</span>()</span><br><span class="line">       .<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">as_ref</span>().<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">as_ptr</span>())</span><br><span class="line">       .collect::&lt;<span class="type">Box</span>&lt;[*<span class="keyword">const</span> <span class="type">i8</span>]&gt;&gt;();</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">indices</span> = [<span class="number">0i32</span>; <span class="number">4</span>];</span><br><span class="line">      gl::<span class="title function_ invoke__">GetUniformIndices</span>(prog, <span class="number">4</span>, names.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">                            indices.<span class="title function_ invoke__">as_mut_ptr</span>() <span class="keyword">as</span> _);</span><br><span class="line">      <span class="built_in">assert_ne!</span>(indices, [-<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>], <span class="string">&quot;glGetUniformIndices() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">offsets</span> = [<span class="number">0</span>; <span class="number">4</span>];</span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr_strides</span> = [<span class="number">0</span>; <span class="number">4</span>];</span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">mat_strides</span> = [<span class="number">0</span>; <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">      gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(prog, <span class="number">4</span>, indices.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _,</span><br><span class="line">                              gl::UNIFORM_OFFSET,</span><br><span class="line">                              offsets.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">      gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(prog, <span class="number">4</span>, indices.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _,</span><br><span class="line">                              gl::UNIFORM_ARRAY_STRIDE,</span><br><span class="line">                              arr_strides.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">      gl::<span class="title function_ invoke__">GetActiveUniformsiv</span>(prog, <span class="number">4</span>, indices.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _,</span><br><span class="line">                              gl::UNIFORM_MATRIX_STRIDE,</span><br><span class="line">                              mat_strides.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line">    </span><br><span class="line">      <span class="built_in">assert_eq!</span>(offsets[<span class="number">0</span>], <span class="number">0</span>);  <span class="comment">// scale</span></span><br><span class="line">      <span class="built_in">assert_eq!</span>(offsets[<span class="number">1</span>], <span class="number">16</span>); <span class="comment">// translation</span></span><br><span class="line">      <span class="built_in">assert_eq!</span>(offsets[<span class="number">2</span>], <span class="number">32</span>); <span class="comment">// rotate</span></span><br><span class="line">      <span class="built_in">assert_eq!</span>(arr_strides[<span class="number">2</span>], <span class="number">16</span>);</span><br><span class="line">      <span class="built_in">assert_eq!</span>(offsets[<span class="number">3</span>], <span class="number">80</span>); <span class="comment">// projection_matrix</span></span><br><span class="line">      <span class="built_in">assert_eq!</span>(mat_strides[<span class="number">3</span>], <span class="number">16</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App.<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<h2 id="着色器存储区块"><a class="markdownIt-Anchor" href="#着色器存储区块"></a> 着色器存储区块</h2>
<p>和 uniform 区块类似，着色器存储区块也需要绑定一块缓冲区对象以存储数据。除了用来向着色器传递数据以外，着色器也可以向着色器存储区块写入数据。</p>
<ul>
<li>和 uniform 区块的相似之处：
<ul>
<li>声明：和 uniform 区块类似，只是将 uniform 关键字替换成 buffer</li>
<li>绑定缓冲区：也是用 <code>glBindBufferBase()</code>，只是将 <code>GL_UNIFORM_BUFFER</code> 换成 <code>GL_SHADER_STORAGE_BUFFER</code></li>
<li>可以指定内存布局：std140 std430</li>
<li>OpenGL 应用程序都可以通过缓冲区映射读取区块内的数据。</li>
</ul>
</li>
<li>不同之处：
<ul>
<li><strong>着色器可以向着色器存储区块写入数据</strong></li>
<li>支持原子操作(读取-编辑-写入 --&gt; 不可分割)</li>
</ul>
</li>
</ul>
<p><strong>声明</strong></p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 460 core</span></span><br><span class="line"></span><br><span class="line">struct vertex &#123;</span><br><span class="line">  <span class="type">vec4</span> position;</span><br><span class="line">  <span class="type">vec3</span> color;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>, <span class="keyword">std430</span>) <span class="keyword">buffer</span> my_vertices &#123;</span><br><span class="line">  vertex <span class="keyword">vertices</span>[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> transform_matrix;</span><br><span class="line"></span><br><span class="line"><span class="keyword">out</span> VS_OUT &#123;</span><br><span class="line">  <span class="type">vec3</span> color;</span><br><span class="line">&#125; vs_out;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main(<span class="type">void</span>) &#123;</span><br><span class="line">  <span class="built_in">gl_Position</span> = transform_matrix * <span class="keyword">vertices</span>[<span class="built_in">gl_VertexID</span>].position;</span><br><span class="line">  vs_out.color = <span class="keyword">vertices</span>[<span class="built_in">gl_VertexID</span>].color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="原子操作"><a class="markdownIt-Anchor" href="#原子操作"></a> 原子操作</h3>
<p>只有 32 位整型（int 和 uint）才支持原子操作，可以避免数据竞争：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Syntax</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">uint atomicAdd(inout uint mem, uint data)<br>int atomicAdd(inout int mem, int data)</td>
<td style="text-align:left">从 mem 读数据，将其和 data 相加，结果存入 mem。返回值：mem 之前的值 <br> mem &lt;- mem + data</td>
</tr>
<tr>
<td style="text-align:left">uint atomicMin(inout uint mem, uint data)<br>int atomicMin(inout int mem, int data)</td>
<td style="text-align:left">从 mem 读数据，将其和 data 取最小值，结果存入 mem。返回值：mem 之前的值 <br> mem &lt;- mem.min(data)</td>
</tr>
<tr>
<td style="text-align:left">uint atomicMax(inout uint mem, uint data)<br>int atomicMax(inout int mem, int data)</td>
<td style="text-align:left">从 mem 读数据，将其和 data 取最大值，结果存入 mem。返回值：mem 之前的值 <br> mem &lt;- mem.max(data)</td>
</tr>
<tr>
<td style="text-align:left">uint atomicAnd(inout uint mem, uint data)<br>int atomicAnd(inout int mem, int data)</td>
<td style="text-align:left">从 mem 读数据，将其和 data 按位求逻辑与，结果存入 mem。返回值：mem 之前的值 <br> mem &lt;- mem &amp; data</td>
</tr>
<tr>
<td style="text-align:left">uint atomicOr(inout uint mem, uint data) <br>int atomicOr(inout int mem, int data)</td>
<td style="text-align:left">从 mem 读数据，将其和 data 按位求逻辑或，结果存入 mem。返回值：mem 之前的值 <br> mem &lt;- mem | data</td>
</tr>
<tr>
<td style="text-align:left">uint atomicXor(inout uint mem, uint data)<br>int atomicXor(inout int mem, int data)</td>
<td style="text-align:left">从 mem 读数据，将其和 data 按位异或，结果存入 mem。返回值：mem 之前的值 <br> mem &lt;- mem xor data</td>
</tr>
<tr>
<td style="text-align:left">uint atomicExchange(inout uint mem, uint data)<br>int atomicExchange(inout int mem, int data)</td>
<td style="text-align:left">从 mem 读数据，将 data 写入 mem。返回值：mem 之前的值 <br> mem &lt;- data</td>
</tr>
<tr>
<td style="text-align:left">uint atomicCompSwap(inout uint mem, uint compare, uint data)<br>int atomicCompSwap(inout int mem, int compare, int data)</td>
<td style="text-align:left">从 mem 读数据，如果读到的数据和 comp 相等，将 data 写入 mem。返回值：mem 之前的值<br> if mem == comp {<br>   mem &lt;- data<br>}</td>
</tr>
</tbody>
</table>
<h3 id="同步访问内存"><a class="markdownIt-Anchor" href="#同步访问内存"></a> 同步访问内存</h3>
<p>当着色器开始将数据写入缓冲区时（向着色器存储区块里的成员赋值，或者通过原子操作函数写入着色器存储区块），可能会引发内存风险</p>
<p>内存风险大概分为三类：</p>
<ul>
<li>先读后写(RAW)风险：当程序在写入一块内存后尝试读取时，根据系统架构，读写操作可能被重新排序，使得读在写之前完成，导致旧数据返回应用程序</li>
<li>先写后写（WRW)风险：当程序连续两次写入同一块内存时，在某些架构下，无法保证第二个数据会覆盖第一个数据，导致最终进入内存的是第一个数据</li>
<li>先写后读风险（WAR）风险：只在并行处理系统里（如GPU）出现，当一个执行线程在另一线程认为自己已经读取内存后尝试将数据写入内存时会发生此风险。如果这些操作被重新排序，执行读操作的线程会读取到第二个线程写入的数据。</li>
</ul>
<p>运行 OpenGL 的系统具有较强的管线和并行特点，包含了大量缓解和控制内存风险的机制。如果没有这些功能，OpenGL实现需要更加保守地重排和并行运行这些着色器。处理内存风险的主要工具为<em>内存屏障（memory barrier）</em>。</p>
<p>内存屏障基本上是一个助记符，指示 OpenGL “如果准备重新排序，需要先完成之前发送的命令，不要执行之后的命令” ，可以在 OpenGL 应用程序和着色器里插入屏障。</p>
<h3 id="在-opengl-应用程序内使用屏障"><a class="markdownIt-Anchor" href="#在-opengl-应用程序内使用屏障"></a> 在 OpenGL 应用程序内使用屏障</h3>
<p>在 OpenGL 应用程序的代码里插入 <code>glMemoryBarrier()</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glMemoryBarrier</span><span class="params">(GLbitfield barriers)</span>;</span><br></pre></td></tr></table></figure>
<p><code>barriers</code> 用来说明哪些内存会受内存屏障的影响，哪些可以忽略内存屏障继续运行：</p>
<ul>
<li><code>GL_ALL_BARRIER_BITS</code>：对所有的内存子系统进行同步</li>
<li><code>GL_SHADER_STORAGE_BARRIER_BIT</code>：只有在屏障之前的着色器完成数据的访问之后，才允许屏障之后的着色器运行</li>
<li><code>GL_UNIFORM_BARRIER_BIT</code>：只有在写入缓冲的着色器结束后，才允许屏障后以该缓冲作为 uniform 区块的着色器运行</li>
<li><code>GL_VERTEX_ATTRIB_ARRAY_BARRIER_BIT</code>：等待向缓冲写入数据的着色器完成后，才允许将该缓存作为顶点属性输入的着色器运行</li>
</ul>
<h3 id="在着色器内使用屏障"><a class="markdownIt-Anchor" href="#在着色器内使用屏障"></a> 在着色器内使用屏障</h3>
<p>在着色器里插入 <code>memoryBarrier()</code>：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="built_in">memoryBarrier</span>();</span><br></pre></td></tr></table></figure>
<p>也可以使用更为具体的函数：<code>memoryBarrierBuffer()</code></p>
<h2 id="原子计数器"><a class="markdownIt-Anchor" href="#原子计数器"></a> 原子计数器</h2>
<p>一种特殊类型的变量，表示跨多个着色器调用共享的存储。</p>
<ul>
<li>原子计数器的值存储在缓冲区对象里，GLSL中提供了递增和递减原子计数器的函数。</li>
<li>如果两个着色器调用同时递增同一个原子计数器，OpenGL会让它们轮流执行。不能保证这些操f作将发生的顺序，但能保证结果正确。</li>
</ul>
<p>在着色器内声明原子计数器：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>) <span class="keyword">uniform</span> <span class="type">atomic_uint</span> my_variable</span><br></pre></td></tr></table></figure>
<p>binding 代表原子计数器和缓冲区对象之间的绑定点。</p>
<p>每个原子计数器存储在缓冲区对象中的特定偏移量处。这个偏移量可以通过 offset 限定符指定：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">3</span>, <span class="keyword">offset</span> = <span class="number">8</span>) <span class="keyword">uniform</span> <span class="type">atomic_uint</span> my_variable;</span><br></pre></td></tr></table></figure>
<p>存储原子计数器的缓冲区对象需要绑定到 <code>GL_ATOMIC_COUNTER_BUFFER</code> 上：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::*;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::mem::size_of;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::null;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span>;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line"></span><br><span class="line">      gl::<span class="title function_ invoke__">NamedBufferData</span>(buf,</span><br><span class="line">                          <span class="number">16</span> * size_of::&lt;GLuint&gt;() <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">                          <span class="title function_ invoke__">null</span>(),</span><br><span class="line">                          gl::DYNAMIC_COPY);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 设置绑定下标，和 shader 内的原子计数器对应</span></span><br><span class="line">      gl::<span class="title function_ invoke__">BindBufferBase</span>(gl::ATOMIC_COUNTER_BUFFER, <span class="number">3</span>, buf);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App.<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>初始化存储原子计数器的缓冲区对象：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> gl::types::*;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::Application;</span><br><span class="line"># <span class="keyword">use</span> std::mem::size_of;</span><br><span class="line"># <span class="keyword">use</span> std::ptr::null;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span>;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferData</span>(buf,</span><br><span class="line">#                           <span class="number">16</span> * size_of::&lt;GLuint&gt;() <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">#                           <span class="title function_ invoke__">null</span>(),</span><br><span class="line">#                           gl::DYNAMIC_COPY);</span><br><span class="line"># </span><br><span class="line">#       <span class="comment">// 设置绑定下标，和 shader 内的原子计数器对应</span></span><br><span class="line">#       gl::<span class="title function_ invoke__">BindBufferBase</span>(gl::ATOMIC_COUNTER_BUFFER, <span class="number">3</span>, buf);</span><br><span class="line"># </span><br><span class="line">      <span class="keyword">let</span> <span class="variable">zero</span>: GLuint = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 方法1 - 使用 gl(Named)BufferSubData 命令</span></span><br><span class="line">      gl::<span class="title function_ invoke__">NamedBufferSubData</span>(buf,</span><br><span class="line">                            <span class="number">2</span> * size_of::&lt;GLuint&gt;() <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">                            size_of::&lt;GLuint&gt;() <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">                            &amp;zero <span class="keyword">as</span> *<span class="keyword">const</span> _ <span class="keyword">as</span> _);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 方法2 - 使用 glMap(Named)BufferRange 命令将 buffer 映射到</span></span><br><span class="line">      <span class="comment">//        OpenGL 应用程序的内存空间上，然后直接写入</span></span><br><span class="line">      <span class="keyword">let</span> <span class="variable">data</span>: *<span class="keyword">mut</span> GLuint =</span><br><span class="line">        gl::<span class="title function_ invoke__">MapNamedBufferRange</span>(buf,</span><br><span class="line">                                <span class="number">0</span>, <span class="number">16</span> * size_of::&lt;GLuint&gt;() <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">                                gl::MAP_WRITE_BIT |</span><br><span class="line">                                gl::MAP_INVALIDATE_RANGE_BIT) <span class="keyword">as</span> _;</span><br><span class="line">      *data.<span class="title function_ invoke__">add</span>(<span class="number">2</span>) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 方法3 - 使用 glClear(Named)BufferSubData 命令</span></span><br><span class="line">      gl::<span class="title function_ invoke__">ClearNamedBufferSubData</span>(buf,</span><br><span class="line">                                  gl::R32UI,</span><br><span class="line">                                  <span class="number">2</span> * size_of::&lt;GLuint&gt;() <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">                                  <span class="number">2</span> * size_of::&lt;GLuint&gt;() <span class="keyword">as</span> <span class="type">isize</span>,</span><br><span class="line">                                  gl::RED_INTEGER,</span><br><span class="line">                                  gl::UNSIGNED_INT,</span><br><span class="line">                                  &amp;zero <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u32</span> <span class="keyword">as</span> _);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App.<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>在初始化 buffer，并将和原子计数器绑定后，就可以在 shader 内使用原子计数器计数了。</p>
<p>递增计数器：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint</span> <span class="built_in">atomicCounterIncrement</span>(<span class="type">atomic_uint</span> c);</span><br></pre></td></tr></table></figure>
<p>这个函数从原子计数器读取值，将其加一，<strong>返回原来读到的值</strong>。</p>
<p>递减计数器：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint</span> <span class="built_in">atomicCounterDecrement</span>(<span class="type">atomic_uint</span> c);</span><br></pre></td></tr></table></figure>
<p><strong>这个函数返回减一后的值。</strong></p>
<p>查询原子计数器的值：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint</span> <span class="built_in">atomicCounter</span>(<span class="type">atomic_uint</span> c);</span><br></pre></td></tr></table></figure>
<p>通过原子计数器来计算渲染对象在屏幕上的面积：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450 core</span></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>, <span class="keyword">offset</span> = <span class="number">0</span>) <span class="keyword">uniform</span> <span class="type">atomic_uint</span> area;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main(<span class="type">void</span>) &#123;</span><br><span class="line">  <span class="built_in">atomicCounterIncrement</span>(area);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个片段着色器并没有输出（out 变量），不会向帧缓冲写入任何数据。在运行这个着色器时，可以关闭向帧缓冲的写入：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gl::<span class="title function_ invoke__">ColorMask</span>(GL::FALSE, GL::FALSE, GL::FALSE, GL::FALSE);</span><br></pre></td></tr></table></figure>
<p>等到需要渲染的时候再重新启用对缓冲区的写入：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gl::<span class="title function_ invoke__">ColorMask</span>(GL_TRUE, GL_TRUE, GL_TRUE, GL_TRUE);</span><br></pre></td></tr></table></figure>
<p>在使用原子计数器后，存储原子计数器的缓冲区可以绑定到其他目标上，如 <code>GL_UNIFORM_BUFFER</code>，之后就可以通过 uniform 区块来使用原子计数器的值了：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450 core</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>) <span class="keyword">uniform</span> area_block &#123;</span><br><span class="line">  <span class="type">uint</span> counter_value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec4</span> color;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">float</span> max_area;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main(<span class="type">void</span>) &#123;</span><br><span class="line">  <span class="type">float</span> brightness = <span class="built_in">clamp</span>(<span class="type">float</span>(counter_value) / max_area,</span><br><span class="line">                           <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">  color = <span class="type">vec4</span>(<span class="type">vec3</span>(brightness), <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>startup()</code> 里可以同时将缓冲区对象绑定到 <code>GL_ATOMIC_COUNTER_BUFFER</code> 和 <code>GL_UNIFORM_BUFFER</code>，这样子这块缓冲就可以同时用作原子计数器和 uniform区块了：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> sb7::&#123;application::*, vmath::*&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::&#123;</span><br><span class="line">#   ffi::CString,</span><br><span class="line">#   mem::&#123;size_of, size_of_val&#125;,</span><br><span class="line">#   ptr::&#123;addr_of, null&#125;,</span><br><span class="line"># &#125;;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   prog_counter: <span class="type">u32</span>,</span><br><span class="line">#   prog_render: <span class="type">u32</span>,</span><br><span class="line">#   vao: <span class="type">u32</span>,</span><br><span class="line">#   vbo: <span class="type">u32</span>,</span><br><span class="line">#   atombuf: <span class="type">u32</span>,</span><br><span class="line">#   proj_mat: Mat4,</span><br><span class="line">#   max_area: <span class="type">f32</span>,</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#       #version 460 core</span></span><br><span class="line"><span class="string">#       </span></span><br><span class="line"><span class="string">#       in vec3 position;</span></span><br><span class="line"><span class="string">#       uniform mat4 trans;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#       void main(void) &#123;</span></span><br><span class="line"><span class="string">#         gl_Position = trans * vec4(position, 1.0);</span></span><br><span class="line"><span class="string">#       &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs_src</span> = CString::<span class="title function_ invoke__">new</span>(vs_src).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs_counter_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#       #version 460 core</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#       layout (binding = 0, offset = 0) uniform atomic_uint area;</span></span><br><span class="line"><span class="string">#       out vec4 color;</span></span><br><span class="line"><span class="string">#       </span></span><br><span class="line"><span class="string">#       void main(void) &#123;</span></span><br><span class="line"><span class="string">#         atomicCounterIncrement(area);</span></span><br><span class="line"><span class="string">#         color = vec4(1.0);</span></span><br><span class="line"><span class="string">#       &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs_counter_src</span> = CString::<span class="title function_ invoke__">new</span>(fs_counter_src).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs_render_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#       #version 460 core</span></span><br><span class="line"><span class="string">#       </span></span><br><span class="line"><span class="string">#       layout (binding = 0) uniform area_block &#123;</span></span><br><span class="line"><span class="string">#       uint counter_value;</span></span><br><span class="line"><span class="string">#       &#125;;</span></span><br><span class="line"><span class="string">#       </span></span><br><span class="line"><span class="string">#       out vec4 color;</span></span><br><span class="line"><span class="string">#       </span></span><br><span class="line"><span class="string">#       uniform float max_area;</span></span><br><span class="line"><span class="string">#       </span></span><br><span class="line"><span class="string">#       void main(void) &#123;</span></span><br><span class="line"><span class="string">#         float brightness = clamp(float(counter_value) / max_area,</span></span><br><span class="line"><span class="string">#                                   0.0, 1.0);</span></span><br><span class="line"><span class="string">#         color = vec4(vec3(brightness), 1.0);</span></span><br><span class="line"><span class="string">#       &#125;&quot;</span>;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs_render_src</span> = CString::<span class="title function_ invoke__">new</span>(fs_render_src).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 设置 shader</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::VERTEX_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(vs, <span class="number">1</span>, &amp;vs_src.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(vs);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs_counter</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::FRAGMENT_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(fs_counter, <span class="number">1</span>, &amp;fs_counter_src.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(fs_counter);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs_render</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::FRAGMENT_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(fs_render, <span class="number">1</span>, &amp;fs_render_src.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(fs_render);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">self</span>.prog_counter = gl::<span class="title function_ invoke__">CreateProgram</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(<span class="keyword">self</span>.prog_counter, vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(<span class="keyword">self</span>.prog_counter, fs_counter);</span><br><span class="line">#       gl::<span class="title function_ invoke__">LinkProgram</span>(<span class="keyword">self</span>.prog_counter);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">self</span>.prog_render = gl::<span class="title function_ invoke__">CreateProgram</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(<span class="keyword">self</span>.prog_render, vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(<span class="keyword">self</span>.prog_render, fs_render);</span><br><span class="line">#       gl::<span class="title function_ invoke__">LinkProgram</span>(<span class="keyword">self</span>.prog_render);</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(fs_counter);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(fs_render);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 设置 vao</span></span><br><span class="line">#     <span class="meta">#[rustfmt::skip]</span></span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vertex_position</span> : &amp;[<span class="type">f32</span>]= &amp;[</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span></span><br><span class="line">#     ];</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vao</span> = <span class="number">0</span>;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> vao);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vbo</span> = <span class="number">0</span>;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferData</span>(vbo,</span><br><span class="line">#                       <span class="title function_ invoke__">size_of_val</span>(vertex_position) <span class="keyword">as</span> _,</span><br><span class="line">#                       vertex_position.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _,</span><br><span class="line">#                       gl::STATIC_DRAW);</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayVertexBuffer</span>(vao, <span class="number">0</span>, vbo, <span class="number">0</span>, <span class="number">3</span> * size_of::&lt;<span class="type">f32</span>&gt;() <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribFormat</span>(vao, <span class="number">0</span>, <span class="number">3</span>, gl::FLOAT, gl::FALSE, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribBinding</span>(vao, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">0</span>);</span><br><span class="line">#       <span class="keyword">self</span>.vao = vao;</span><br><span class="line">#       <span class="keyword">self</span>.vbo = vbo;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 设置存储 原子计数器 的 buffer</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line">      gl::<span class="title function_ invoke__">NamedBufferData</span>(buf, size_of::&lt;<span class="type">u32</span>&gt;() <span class="keyword">as</span> _,</span><br><span class="line">                      &amp;<span class="number">0u32</span> <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u32</span> <span class="keyword">as</span> _, gl::DYNAMIC_COPY);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">self</span>.atombuf = buf;</span><br><span class="line"></span><br><span class="line">      gl::<span class="title function_ invoke__">BindBuffer</span>(gl::UNIFORM_BUFFER, buf);</span><br><span class="line">      gl::<span class="title function_ invoke__">BindBufferBase</span>(gl::UNIFORM_BUFFER, <span class="number">0</span>, buf);</span><br><span class="line">      gl::<span class="title function_ invoke__">BindBuffer</span>(gl::ATOMIC_COUNTER_BUFFER, buf);</span><br><span class="line">      gl::<span class="title function_ invoke__">BindBufferBase</span>(gl::ATOMIC_COUNTER_BUFFER, <span class="number">0</span>, buf);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 初始化投影矩阵</span></span><br><span class="line">#     <span class="keyword">self</span>.<span class="title function_ invoke__">on_resize</span>(<span class="number">800</span>, <span class="number">600</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 启用深度测试</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">Enable</span>(gl::DEPTH_TEST);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">Self</span> &#123; vao,</span><br><span class="line">#                proj_mat,</span><br><span class="line">#                prog_render,</span><br><span class="line">#                prog_counter,</span><br><span class="line">#                atombuf,</span><br><span class="line">#                max_area,</span><br><span class="line">#                .. &#125; = <span class="keyword">self</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR, <span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0f32</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::DEPTH, <span class="number">0</span>, &amp;<span class="number">1.0</span>);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindVertexArray</span>(*vao);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">current_time</span> = current_time <span class="keyword">as</span> <span class="type">f32</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">24</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">f</span> = i <span class="keyword">as</span> <span class="type">f32</span> + current_time * <span class="number">0.3</span>;</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">trans_mat</span> = <span class="title function_ invoke__">translate</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, -<span class="number">6.0</span>)</span><br><span class="line">#                       * <span class="title function_ invoke__">rotate_with_axis</span>(current_time * <span class="number">45.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>)</span><br><span class="line">#                       * <span class="title function_ invoke__">rotate_with_axis</span>(current_time * <span class="number">21.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>)</span><br><span class="line">#                       * <span class="title function_ invoke__">translate</span>((<span class="number">2.1</span> * f).<span class="title function_ invoke__">sin</span>() * <span class="number">2.0</span>,</span><br><span class="line">#                                   (<span class="number">1.7</span> * f).<span class="title function_ invoke__">cos</span>() * <span class="number">2.0</span>,</span><br><span class="line">#                                   (<span class="number">1.3</span> * f).<span class="title function_ invoke__">sin</span>() * (<span class="number">1.5</span> * f).<span class="title function_ invoke__">cos</span>() * <span class="number">2.0</span>);</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">trans_mat</span> = *proj_mat * trans_mat;</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#         gl::<span class="title function_ invoke__">ColorMask</span>(gl::FALSE, gl::FALSE, gl::FALSE, gl::FALSE);</span><br><span class="line">#         gl::<span class="title function_ invoke__">DepthMask</span>(gl::FALSE);</span><br><span class="line"># </span><br><span class="line">#         <span class="comment">// 使用 prog_counter 计算面积</span></span><br><span class="line">#         gl::<span class="title function_ invoke__">UseProgram</span>(*prog_counter);</span><br><span class="line"># </span><br><span class="line">#         <span class="keyword">let</span> <span class="variable">cptr</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;trans&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#         <span class="keyword">let</span> <span class="variable">location</span> = gl::<span class="title function_ invoke__">GetUniformLocation</span>(*prog_counter, cptr.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#         gl::<span class="title function_ invoke__">UniformMatrix4fv</span>(location, <span class="number">1</span>, gl::FALSE, addr_of!(trans_mat) <span class="keyword">as</span> _);</span><br><span class="line"># </span><br><span class="line">#         <span class="comment">// 重置原子计数</span></span><br><span class="line">#         gl::<span class="title function_ invoke__">NamedBufferData</span>(*atombuf,</span><br><span class="line">#                         size_of::&lt;<span class="type">u32</span>&gt;() <span class="keyword">as</span> _,</span><br><span class="line">#                         &amp;<span class="number">0u32</span> <span class="keyword">as</span> *<span class="keyword">const</span> _ <span class="keyword">as</span> _,</span><br><span class="line">#                         gl::DYNAMIC_COPY);</span><br><span class="line"># </span><br><span class="line">#         gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line"># </span><br><span class="line">#         <span class="comment">// 等待所有 shader 执行完毕</span></span><br><span class="line">#         gl::<span class="title function_ invoke__">MemoryBarrier</span>(gl::UNIFORM_BARRIER_BIT);</span><br><span class="line"># </span><br><span class="line">#         gl::<span class="title function_ invoke__">ColorMask</span>(gl::TRUE, gl::TRUE, gl::TRUE, gl::TRUE);</span><br><span class="line">#         gl::<span class="title function_ invoke__">DepthMask</span>(gl::TRUE);</span><br><span class="line"># </span><br><span class="line">#         <span class="comment">// 使用 prog_render 渲染</span></span><br><span class="line">#         gl::<span class="title function_ invoke__">UseProgram</span>(*prog_render);</span><br><span class="line"># </span><br><span class="line">#         <span class="keyword">let</span> <span class="variable">cstr</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;trans&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#         <span class="keyword">let</span> <span class="variable">location</span> = gl::<span class="title function_ invoke__">GetUniformLocation</span>(*prog_render, cstr.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#         gl::<span class="title function_ invoke__">UniformMatrix4fv</span>(location, <span class="number">1</span>, gl::FALSE, addr_of!(trans_mat) <span class="keyword">as</span> _);</span><br><span class="line"># </span><br><span class="line">#         <span class="keyword">let</span> <span class="variable">cstr</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;max_area&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#         <span class="keyword">let</span> <span class="variable">location</span> = gl::<span class="title function_ invoke__">GetUniformLocation</span>(*prog_render, cstr.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#         gl::<span class="title function_ invoke__">Uniform1f</span>(location, *max_area);</span><br><span class="line"># </span><br><span class="line">#         gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line">#       &#125;</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">on_resize</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, w: <span class="type">i32</span>, h: <span class="type">i32</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">aspect</span> = w <span class="keyword">as</span> <span class="type">f32</span> / h <span class="keyword">as</span> <span class="type">f32</span>;</span><br><span class="line">#     <span class="keyword">self</span>.proj_mat = sb7::vmath::<span class="title function_ invoke__">perspective</span>(<span class="number">45.0</span>, aspect, <span class="number">0.1</span>, <span class="number">1000.0</span>);</span><br><span class="line">#     <span class="keyword">self</span>.max_area = (w * h) <span class="keyword">as</span> <span class="type">f32</span> * <span class="number">0.03</span>;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.prog_counter);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.prog_render);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vao);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.atombuf);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>在 render 函数里，先使用原子计数器进行计数，再读取一致区块内的原子计数器的值，来渲染物体：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> sb7::&#123;application::*, vmath::*&#125;;</span><br><span class="line"># <span class="keyword">use</span> std::&#123;</span><br><span class="line">#   ffi::CString,</span><br><span class="line">#   mem::&#123;size_of, size_of_val&#125;,</span><br><span class="line">#   ptr::&#123;addr_of, null&#125;,</span><br><span class="line"># &#125;;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   prog_counter: <span class="type">u32</span>,</span><br><span class="line">#   prog_render: <span class="type">u32</span>,</span><br><span class="line">#   vao: <span class="type">u32</span>,</span><br><span class="line">#   vbo: <span class="type">u32</span>,</span><br><span class="line">#   atombuf: <span class="type">u32</span>,</span><br><span class="line">#   proj_mat: Mat4,</span><br><span class="line">#   max_area: <span class="type">f32</span>,</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#       #version 460 core</span></span><br><span class="line"><span class="string">#       </span></span><br><span class="line"><span class="string">#       in vec3 position;</span></span><br><span class="line"><span class="string">#       uniform mat4 trans;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#       void main(void) &#123;</span></span><br><span class="line"><span class="string">#         gl_Position = trans * vec4(position, 1.0);</span></span><br><span class="line"><span class="string">#       &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs_src</span> = CString::<span class="title function_ invoke__">new</span>(vs_src).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs_counter_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#       #version 460 core</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#       layout (binding = 0, offset = 0) uniform atomic_uint area;</span></span><br><span class="line"><span class="string">#       out vec4 color;</span></span><br><span class="line"><span class="string">#       </span></span><br><span class="line"><span class="string">#       void main(void) &#123;</span></span><br><span class="line"><span class="string">#         atomicCounterIncrement(area);</span></span><br><span class="line"><span class="string">#         color = vec4(1.0);</span></span><br><span class="line"><span class="string">#       &#125;&quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs_counter_src</span> = CString::<span class="title function_ invoke__">new</span>(fs_counter_src).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs_render_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#       #version 460 core</span></span><br><span class="line"><span class="string">#       </span></span><br><span class="line"><span class="string">#       layout (binding = 0) uniform area_block &#123;</span></span><br><span class="line"><span class="string">#       uint counter_value;</span></span><br><span class="line"><span class="string">#       &#125;;</span></span><br><span class="line"><span class="string">#       </span></span><br><span class="line"><span class="string">#       out vec4 color;</span></span><br><span class="line"><span class="string">#       </span></span><br><span class="line"><span class="string">#       uniform float max_area;</span></span><br><span class="line"><span class="string">#       </span></span><br><span class="line"><span class="string">#       void main(void) &#123;</span></span><br><span class="line"><span class="string">#         float brightness = clamp(float(counter_value) / max_area,</span></span><br><span class="line"><span class="string">#                                   0.0, 1.0);</span></span><br><span class="line"><span class="string">#         color = vec4(vec3(brightness), 1.0);</span></span><br><span class="line"><span class="string">#       &#125;&quot;</span>;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs_render_src</span> = CString::<span class="title function_ invoke__">new</span>(fs_render_src).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 设置 shader</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::VERTEX_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(vs, <span class="number">1</span>, &amp;vs_src.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(vs);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs_counter</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::FRAGMENT_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(fs_counter, <span class="number">1</span>, &amp;fs_counter_src.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(fs_counter);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs_render</span> = gl::<span class="title function_ invoke__">CreateShader</span>(gl::FRAGMENT_SHADER);</span><br><span class="line">#       gl::<span class="title function_ invoke__">ShaderSource</span>(fs_render, <span class="number">1</span>, &amp;fs_render_src.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">CompileShader</span>(fs_render);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">self</span>.prog_counter = gl::<span class="title function_ invoke__">CreateProgram</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(<span class="keyword">self</span>.prog_counter, vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(<span class="keyword">self</span>.prog_counter, fs_counter);</span><br><span class="line">#       gl::<span class="title function_ invoke__">LinkProgram</span>(<span class="keyword">self</span>.prog_counter);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">self</span>.prog_render = gl::<span class="title function_ invoke__">CreateProgram</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(<span class="keyword">self</span>.prog_render, vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">AttachShader</span>(<span class="keyword">self</span>.prog_render, fs_render);</span><br><span class="line">#       gl::<span class="title function_ invoke__">LinkProgram</span>(<span class="keyword">self</span>.prog_render);</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(vs);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(fs_counter);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteShader</span>(fs_render);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 设置 vao</span></span><br><span class="line">#     <span class="meta">#[rustfmt::skip]</span></span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vertex_position</span> : &amp;[<span class="type">f32</span>]= &amp;[</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>, -<span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span>,</span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>,  <span class="number">0.25</span>,</span><br><span class="line">#       -<span class="number">0.25</span>,  <span class="number">0.25</span>, -<span class="number">0.25</span></span><br><span class="line">#     ];</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vao</span> = <span class="number">0</span>;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> vao);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vbo</span> = <span class="number">0</span>;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferData</span>(vbo,</span><br><span class="line">#                       <span class="title function_ invoke__">size_of_val</span>(vertex_position) <span class="keyword">as</span> _,</span><br><span class="line">#                       vertex_position.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _,</span><br><span class="line">#                       gl::STATIC_DRAW);</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayVertexBuffer</span>(vao, <span class="number">0</span>, vbo, <span class="number">0</span>, <span class="number">3</span> * size_of::&lt;<span class="type">f32</span>&gt;() <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribFormat</span>(vao, <span class="number">0</span>, <span class="number">3</span>, gl::FLOAT, gl::FALSE, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexArrayAttribBinding</span>(vao, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(vao, <span class="number">0</span>);</span><br><span class="line">#       <span class="keyword">self</span>.vao = vao;</span><br><span class="line">#       <span class="keyword">self</span>.vbo = vbo;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 设置存储 原子计数器 的 buffer</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="number">0</span>;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> buf);</span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferData</span>(buf, size_of::&lt;<span class="type">u32</span>&gt;() <span class="keyword">as</span> _,</span><br><span class="line">#                       &amp;<span class="number">0u32</span> <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u32</span> <span class="keyword">as</span> _, gl::DYNAMIC_COPY);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">self</span>.atombuf = buf;</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">BindBuffer</span>(gl::UNIFORM_BUFFER, buf);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindBufferBase</span>(gl::UNIFORM_BUFFER, <span class="number">0</span>, buf);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindBuffer</span>(gl::ATOMIC_COUNTER_BUFFER, buf);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindBufferBase</span>(gl::ATOMIC_COUNTER_BUFFER, <span class="number">0</span>, buf);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 初始化投影矩阵</span></span><br><span class="line">#     <span class="keyword">self</span>.<span class="title function_ invoke__">on_resize</span>(<span class="number">800</span>, <span class="number">600</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="comment">// 启用深度测试</span></span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">Enable</span>(gl::DEPTH_TEST);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">Self</span> &#123; vao,</span><br><span class="line">#                proj_mat,</span><br><span class="line">#                prog_render,</span><br><span class="line">#                prog_counter,</span><br><span class="line">#                atombuf,</span><br><span class="line">#                max_area,</span><br><span class="line">#                .. &#125; = <span class="keyword">self</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR, <span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0f32</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::DEPTH, <span class="number">0</span>, &amp;<span class="number">1.0</span>);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindVertexArray</span>(*vao);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">current_time</span> = current_time <span class="keyword">as</span> <span class="type">f32</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">24</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">f</span> = i <span class="keyword">as</span> <span class="type">f32</span> + current_time * <span class="number">0.3</span>;</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">trans_mat</span> = <span class="title function_ invoke__">translate</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, -<span class="number">6.0</span>)</span><br><span class="line">#                       * <span class="title function_ invoke__">rotate_with_axis</span>(current_time * <span class="number">45.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>)</span><br><span class="line">#                       * <span class="title function_ invoke__">rotate_with_axis</span>(current_time * <span class="number">21.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>)</span><br><span class="line">#                       * <span class="title function_ invoke__">translate</span>((<span class="number">2.1</span> * f).<span class="title function_ invoke__">sin</span>() * <span class="number">2.0</span>,</span><br><span class="line">#                                   (<span class="number">1.7</span> * f).<span class="title function_ invoke__">cos</span>() * <span class="number">2.0</span>,</span><br><span class="line">#                                   (<span class="number">1.3</span> * f).<span class="title function_ invoke__">sin</span>() * (<span class="number">1.5</span> * f).<span class="title function_ invoke__">cos</span>() * <span class="number">2.0</span>);</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">trans_mat</span> = *proj_mat * trans_mat;</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        gl::<span class="title function_ invoke__">ColorMask</span>(gl::FALSE, gl::FALSE, gl::FALSE, gl::FALSE);</span><br><span class="line">        gl::<span class="title function_ invoke__">DepthMask</span>(gl::FALSE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 prog_counter 计算面积</span></span><br><span class="line">        gl::<span class="title function_ invoke__">UseProgram</span>(*prog_counter);</span><br><span class="line"># </span><br><span class="line">#         <span class="keyword">let</span> <span class="variable">cptr</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;trans&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#         <span class="keyword">let</span> <span class="variable">location</span> = gl::<span class="title function_ invoke__">GetUniformLocation</span>(*prog_counter, cptr.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#         gl::<span class="title function_ invoke__">UniformMatrix4fv</span>(location, <span class="number">1</span>, gl::FALSE, addr_of!(trans_mat) <span class="keyword">as</span> _);</span><br><span class="line"># </span><br><span class="line">        <span class="comment">// 重置原子计数</span></span><br><span class="line">        gl::<span class="title function_ invoke__">NamedBufferData</span>(*atombuf,</span><br><span class="line">                        size_of::&lt;<span class="type">u32</span>&gt;() <span class="keyword">as</span> _,</span><br><span class="line">                        &amp;<span class="number">0u32</span> <span class="keyword">as</span> *<span class="keyword">const</span> _ <span class="keyword">as</span> _,</span><br><span class="line">                        gl::DYNAMIC_COPY);</span><br><span class="line"># </span><br><span class="line">        gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待所有 shader 执行完毕</span></span><br><span class="line">        gl::<span class="title function_ invoke__">MemoryBarrier</span>(gl::UNIFORM_BARRIER_BIT);</span><br><span class="line"></span><br><span class="line">        gl::<span class="title function_ invoke__">ColorMask</span>(gl::TRUE, gl::TRUE, gl::TRUE, gl::TRUE);</span><br><span class="line">        gl::<span class="title function_ invoke__">DepthMask</span>(gl::TRUE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 prog_render 渲染</span></span><br><span class="line">        gl::<span class="title function_ invoke__">UseProgram</span>(*prog_render);</span><br><span class="line"># </span><br><span class="line">#         <span class="keyword">let</span> <span class="variable">cstr</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;trans&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#         <span class="keyword">let</span> <span class="variable">location</span> = gl::<span class="title function_ invoke__">GetUniformLocation</span>(*prog_render, cstr.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#         gl::<span class="title function_ invoke__">UniformMatrix4fv</span>(location, <span class="number">1</span>, gl::FALSE, addr_of!(trans_mat) <span class="keyword">as</span> _);</span><br><span class="line"># </span><br><span class="line">#         <span class="keyword">let</span> <span class="variable">cstr</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;max_area&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#         <span class="keyword">let</span> <span class="variable">location</span> = gl::<span class="title function_ invoke__">GetUniformLocation</span>(*prog_render, cstr.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#         gl::<span class="title function_ invoke__">Uniform1f</span>(location, *max_area);</span><br><span class="line"># </span><br><span class="line">        gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line">#       &#125;</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">on_resize</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, w: <span class="type">i32</span>, h: <span class="type">i32</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">aspect</span> = w <span class="keyword">as</span> <span class="type">f32</span> / h <span class="keyword">as</span> <span class="type">f32</span>;</span><br><span class="line">#     <span class="keyword">self</span>.proj_mat = sb7::vmath::<span class="title function_ invoke__">perspective</span>(<span class="number">45.0</span>, aspect, <span class="number">0.1</span>, <span class="number">1000.0</span>);</span><br><span class="line">#     <span class="keyword">self</span>.max_area = (w * h) <span class="keyword">as</span> <span class="type">f32</span> * <span class="number">0.03</span>;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.prog_counter);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.prog_render);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vao);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.atombuf);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>()</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>WebGL 里并没有原子计数器，这里只是使用 gl_FragCoord.z 值模拟上面代码的结果，毕竟跑起来的效果差不多。物体里摄像机越近，在屏幕空间上占据的像素点就越多，亮度越亮：</p>

<div class="demo_app" id="_ch5_1_1_atom_counter"></div>

<h3 id="原子计数器的同步访问"><a class="markdownIt-Anchor" href="#原子计数器的同步访问"></a> 原子计数器的同步访问</h3>
<ul>
<li>原子计数器其实是缓冲区对象中的一个位置，当着色器执行时，他们的值可能驻留在GPU的特殊内存中，当着色器执行完毕时，原子计数器的值将被写回内存。</li>
<li>原子计数器的递增和递减被认为是内存操作的一种形式，可能会受到之前描述的内存风险影响。</li>
</ul>
<p><code>glMemoryBarrier</code> 可以将对原子计数器的访问与 OpenGL 管道的其他部分进行同步：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">glMemoryBarrier(GL_ATOMIC_COUNTER_BARRIER_BIT);</span><br></pre></td></tr></table></figure>
<ul>
<li>这个函数调用确保了OpenGL 应用程序对缓冲区对象内的原子计数器进行修改，那么着色器会使用更新后的值。
<ul>
<li>在将数据写入缓冲区时，应该调用这个函数，同步着色器访问到的值。</li>
</ul>
</li>
</ul>
<p>glsl 内部类似的函数：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memoryBarrierAtomicCounter</span>();</span><br></pre></td></tr></table></figure>
<p>这个函数会等待，直到对原子计数器的操作结束后才退出。</p>
<h2 id="纹理"><a class="markdownIt-Anchor" href="#纹理"></a> 纹理</h2>
<ul>
<li>一种结构化的存储形式，着色器可以对其进行读写操作</li>
<li>常用于存储图像数据</li>
<li>最常见的纹理布局是二维的，但是纹理也可以在一维或三维布局、数组形式（多个纹理堆叠在一起形成一个逻辑对象）、立方体中创建</li>
</ul>
<h3 id="创建-初始化纹理"><a class="markdownIt-Anchor" href="#创建-初始化纹理"></a> 创建、初始化纹理</h3>
<ol>
<li>创建纹理，设置纹理类型（<code>glCreateTextures()</code>）</li>
<li>设置纹理大小，分配空间（<code>glTexStorage2D()</code>）</li>
</ol>
<p>用 <code>glCreateTextures()</code> 创建纹理对象，然后使用 <code>glTexStorage2D()</code> 函数为纹理分配存储空间，使用<code>glBindTexture()</code> 将其绑定到GL_TEXTURE_2D目标：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> gl::*;</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">texture</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建纹理</span></span><br><span class="line"><span class="title function_ invoke__">CreateTextures</span>(TEXTURE_2D, <span class="number">1</span>, &amp;<span class="keyword">mut</span> texture);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为纹理分配空间</span></span><br><span class="line"><span class="title function_ invoke__">TextureStorage2D</span>(texture,   <span class="comment">// 要分配空间的纹理对象</span></span><br><span class="line">                 <span class="number">1</span>,         <span class="comment">// 分级细化等级</span></span><br><span class="line">                 RGBA32F,   <span class="comment">// 纹理的数据格式</span></span><br><span class="line">                 <span class="number">256</span>, <span class="number">256</span>); <span class="comment">// 纹理宽、高</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定纹理目标</span></span><br><span class="line"><span class="title function_ invoke__">BindTexture</span>(TEXTURE_2D, texture);</span><br></pre></td></tr></table></figure>
<p>使用 glTexSubImage2D() 向纹理对象写入数据：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> std::&#123;ffi::CString, ptr::&#123;null, null_mut&#125;&#125;;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">use</span> sb7::application::*;</span><br><span class="line"><span class="keyword">use</span> gl::*;</span><br><span class="line"># <span class="keyword">use</span> sb7::gl;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   texture: <span class="type">u32</span>,</span><br><span class="line">#   prog: <span class="type">u32</span>,</span><br><span class="line">#   vao: <span class="type">u32</span>,</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">generate_texture</span>(&amp;<span class="keyword">self</span>, data: &amp;<span class="keyword">mut</span> [<span class="type">f32</span>], width: <span class="type">usize</span>, height: <span class="type">usize</span>) &#123;</span><br><span class="line">#     <span class="built_in">assert_eq!</span>(data.<span class="title function_ invoke__">len</span>(), width * height * <span class="number">4</span>);</span><br><span class="line">#     <span class="keyword">for</span> <span class="variable">y</span> <span class="keyword">in</span> <span class="number">0</span>..height &#123;</span><br><span class="line">#       <span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> <span class="number">0</span>..width &#123;</span><br><span class="line">#         data[(y * width + x) * <span class="number">4</span> + <span class="number">0</span>] = ((x &amp; y) &amp; <span class="number">0xFF</span>) <span class="keyword">as</span> <span class="type">f32</span> / <span class="number">255.0</span>;</span><br><span class="line">#         data[(y * width + x) * <span class="number">4</span> + <span class="number">1</span>] = ((x | y) &amp; <span class="number">0xFF</span>) <span class="keyword">as</span> <span class="type">f32</span> / <span class="number">255.0</span>;</span><br><span class="line">#         data[(y * width + x) * <span class="number">4</span> + <span class="number">2</span>] = ((x ^ y) &amp; <span class="number">0xFF</span>) <span class="keyword">as</span> <span class="type">f32</span> / <span class="number">255.0</span>;</span><br><span class="line">#         data[(y * width + x) * <span class="number">4</span> + <span class="number">3</span>] = <span class="number">1.0</span>;</span><br><span class="line">#       &#125;</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">log_info</span>(&amp;<span class="keyword">self</span>, obj: <span class="type">u32</span>, log_type: <span class="type">u32</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = [<span class="number">0u8</span>; <span class="number">2048</span>];</span><br><span class="line"># </span><br><span class="line">#     gl! &#123;</span><br><span class="line">#       <span class="keyword">match</span> log_type &#123;</span><br><span class="line">#         COMPILE_STATUS =&gt; <span class="title function_ invoke__">GetShaderInfoLog</span>(obj, <span class="number">2048</span>, <span class="title function_ invoke__">null_mut</span>(), buf.<span class="title function_ invoke__">as_mut_ptr</span>() <span class="keyword">as</span> _),</span><br><span class="line">#         LINK_STATUS =&gt; <span class="title function_ invoke__">GetProgramInfoLog</span>(obj, <span class="number">2048</span>, <span class="title function_ invoke__">null_mut</span>(), buf.<span class="title function_ invoke__">as_mut_ptr</span>() <span class="keyword">as</span> _),</span><br><span class="line">#         _ =&gt; (),</span><br><span class="line">#       &#125;;  </span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">str</span> = std::<span class="type">str</span>::<span class="title function_ invoke__">from_utf8</span>(&amp;buf).<span class="title function_ invoke__">unwrap_or</span>(<span class="string">&quot;invaild utf-8 str&quot;</span>);</span><br><span class="line">#     <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="type">str</span>);</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     gl! &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">texture</span> = <span class="number">0</span>;</span><br><span class="line"># </span><br><span class="line">#       <span class="comment">// 创建纹理</span></span><br><span class="line">#       <span class="title function_ invoke__">CreateTextures</span>(TEXTURE_2D, <span class="number">1</span>, &amp;<span class="keyword">mut</span> texture);</span><br><span class="line"># </span><br><span class="line">#       <span class="comment">// 分配空间</span></span><br><span class="line">#       <span class="title function_ invoke__">TextureStorage2D</span>(texture,   <span class="comment">// 要分配空间的纹理对象</span></span><br><span class="line">#                        <span class="number">1</span>,         <span class="comment">// 分级细化等级</span></span><br><span class="line">#                        RGBA32F,   <span class="comment">// 数据格式</span></span><br><span class="line">#                        <span class="number">256</span>, <span class="number">256</span>); <span class="comment">// 纹理宽、高</span></span><br><span class="line"># </span><br><span class="line">#       <span class="comment">// 绑定纹理目标</span></span><br><span class="line">#       <span class="title function_ invoke__">BindTexture</span>(TEXTURE_2D, texture);</span><br><span class="line"># </span><br><span class="line">      <span class="comment">// 在堆上分配空间，这段内存会在离开作用域时自动释放</span></span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">data</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>([<span class="number">0f32</span>; <span class="number">256</span> * <span class="number">256</span> * <span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// generate_texture 函数用来向 data 填充数据</span></span><br><span class="line">      <span class="keyword">self</span>.<span class="title function_ invoke__">generate_texture</span>(&amp;<span class="keyword">mut</span> data[..], <span class="number">256</span>, <span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 将生成的数据写入到纹理对象</span></span><br><span class="line">      <span class="title function_ invoke__">TextureSubImage2D</span>(texture,</span><br><span class="line">                        <span class="number">0</span>,        <span class="comment">// 细节等级，等级0代表基本图形级别</span></span><br><span class="line">                        <span class="number">0</span>, <span class="number">0</span>,     <span class="comment">// 偏移量 0, 0</span></span><br><span class="line">                        <span class="number">256</span>, <span class="number">256</span>, <span class="comment">// 宽 x 高</span></span><br><span class="line">                        RGBA,     <span class="comment">// 四通道数据</span></span><br><span class="line">                        FLOAT,    <span class="comment">// 数据类型为浮点数</span></span><br><span class="line">                        data.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">self</span>.texture = texture;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#       #version 460 core</span></span><br><span class="line"><span class="string">#       void main(void) &#123;</span></span><br><span class="line"><span class="string">#         const vec4 vertices[] = vec4[](vec4( 0.75, -0.75, 0.5, 1.0),</span></span><br><span class="line"><span class="string">#                                        vec4(-0.75, -0.75, 0.5, 1.0),</span></span><br><span class="line"><span class="string">#                                        vec4( 0.75,  0.75, 0.5, 1.0));</span></span><br><span class="line"><span class="string">#         gl_Position = vertices[gl_VertexID];</span></span><br><span class="line"><span class="string">#       &#125;</span></span><br><span class="line"><span class="string">#     &quot;</span>;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs_src</span> = CString::<span class="title function_ invoke__">new</span>(vs_src).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#       #version 460 core</span></span><br><span class="line"><span class="string">#       uniform sampler2D s;</span></span><br><span class="line"><span class="string">#       out vec4 color;</span></span><br><span class="line"><span class="string">#       void main(void) &#123;</span></span><br><span class="line"><span class="string">#         color = texture(s, gl_FragCoord.xy / textureSize(s, 0));</span></span><br><span class="line"><span class="string">#       &#125;</span></span><br><span class="line"><span class="string">#     &quot;</span>;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs_src</span> = CString::<span class="title function_ invoke__">new</span>(fs_src).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#     </span><br><span class="line">#     gl! &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">vs</span> = <span class="title function_ invoke__">CreateShader</span>(VERTEX_SHADER);</span><br><span class="line">#       <span class="title function_ invoke__">ShaderSource</span>(vs, <span class="number">1</span>, &amp;vs_src.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       <span class="title function_ invoke__">CompileShader</span>(vs);</span><br><span class="line">#       <span class="keyword">self</span>.<span class="title function_ invoke__">log_info</span>(vs, COMPILE_STATUS);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">fs</span> = <span class="title function_ invoke__">CreateShader</span>(FRAGMENT_SHADER);</span><br><span class="line">#       <span class="title function_ invoke__">ShaderSource</span>(fs, <span class="number">1</span>, &amp;fs_src.<span class="title function_ invoke__">as_ptr</span>(), <span class="title function_ invoke__">null</span>());</span><br><span class="line">#       <span class="title function_ invoke__">CompileShader</span>(fs);</span><br><span class="line">#       <span class="keyword">self</span>.<span class="title function_ invoke__">log_info</span>(fs, COMPILE_STATUS);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">prog</span> = <span class="title function_ invoke__">CreateProgram</span>();</span><br><span class="line">#       <span class="title function_ invoke__">AttachShader</span>(prog, vs);</span><br><span class="line">#       <span class="title function_ invoke__">AttachShader</span>(prog, fs);</span><br><span class="line">#       <span class="title function_ invoke__">LinkProgram</span>(prog);</span><br><span class="line">#       <span class="keyword">self</span>.<span class="title function_ invoke__">log_info</span>(prog, LINK_STATUS);</span><br><span class="line"># </span><br><span class="line">#       <span class="title function_ invoke__">DeleteShader</span>(vs);</span><br><span class="line">#       <span class="title function_ invoke__">DeleteShader</span>(fs);</span><br><span class="line"># </span><br><span class="line">#       <span class="title function_ invoke__">UseProgram</span>(prog);</span><br><span class="line">#       <span class="keyword">self</span>.prog = prog;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     gl! &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vao</span> = <span class="number">0</span>;</span><br><span class="line">#       <span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> vao);</span><br><span class="line">#       <span class="title function_ invoke__">BindVertexArray</span>(vao);</span><br><span class="line">#       <span class="keyword">self</span>.vao = vao;</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, _current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     gl! &#123;</span><br><span class="line">#       <span class="title function_ invoke__">ClearBufferfv</span>(COLOR, <span class="number">0</span>, [<span class="number">0.0f32</span>, <span class="number">0.25</span>, <span class="number">0.0</span>, <span class="number">1.0</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       <span class="title function_ invoke__">DrawArrays</span>(TRIANGLES, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     gl! &#123;</span><br><span class="line">#       <span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.prog);</span><br><span class="line">#       <span class="title function_ invoke__">DeleteTextures</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.texture);  </span><br><span class="line">#       <span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vao);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>();</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<h3 id="纹理目标和类型"><a class="markdownIt-Anchor" href="#纹理目标和类型"></a> 纹理目标和类型</h3>
<table>
<thead>
<tr>
<th style="text-align:left">纹理目标（GL_TEXTURE_*）</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1D</td>
<td style="text-align:left">一维纹理</td>
</tr>
<tr>
<td style="text-align:left">2D</td>
<td style="text-align:left">二维纹理</td>
</tr>
<tr>
<td style="text-align:left">3D</td>
<td style="text-align:left">三维纹理</td>
</tr>
<tr>
<td style="text-align:left">RECTANGLE</td>
<td style="text-align:left">矩形纹理</td>
</tr>
<tr>
<td style="text-align:left">1D_ARRAY</td>
<td style="text-align:left">一维数组纹理</td>
</tr>
<tr>
<td style="text-align:left">2D_ARRAY</td>
<td style="text-align:left">二维数组纹理</td>
</tr>
<tr>
<td style="text-align:left">CUBE_MAP</td>
<td style="text-align:left">立方体贴图纹理</td>
</tr>
<tr>
<td style="text-align:left">CUBE_MAP_ARRAY</td>
<td style="text-align:left">立方体贴图数组纹理</td>
</tr>
<tr>
<td style="text-align:left">BUFFER</td>
<td style="text-align:left">缓冲区纹理</td>
</tr>
<tr>
<td style="text-align:left">2D_MULTISAMPLE</td>
<td style="text-align:left">二维多重采样纹理</td>
</tr>
<tr>
<td style="text-align:left">2D_MULTISAMPLE_ARRAY</td>
<td style="text-align:left">二维数组多重采样纹理</td>
</tr>
</tbody>
</table>
<ul>
<li>GL_TEXTURE_2D：最常使用的纹理，标准二维图像，代表一张图片</li>
<li>GL_TEXTURE_1D、GL_TEXTURE_3D：一维和三维纹理
<ul>
<li>GL_TEXTURE_1D 可以看成高度为 1 的二维纹理</li>
<li>GL_TEXTURE_3D 可以用来表示<strong>体积</strong>，内部使用三维纹理坐标</li>
</ul>
</li>
<li>GL_TEXTURE_RECTANGLE：是二维纹理的特例，它们在着色器中的读取方式和它们支持的参数方面有细微的差异。</li>
<li>GL_TEXTURE_1D_ARRAY、GL_TEXTURE_2D_ARRAY：表示聚集到单个对象中的纹理图像数组</li>
<li>GL_TEXTURE_CUBE_MAP：立方体贴图纹理，形成一个立方体的六个正方形图像的集合，可以用来模拟光照环境</li>
<li>GL_TEXTURE_CUBE_MAP_ARRAY：和 GL_TEXTURE_1D_ARRAY、GL_TEXTURE_2D_ARRAY 类似，表示一个立方体贴图数组的纹理</li>
<li>GL_TEXTURE_BUFFER：缓冲区纹理、一种特殊类型的纹理，类似于一维纹理，只不过其存储是由缓冲区对象表示的。最大尺寸可以比一维纹理大得多。</li>
<li>GL_TEXTURE_2D_MULTISAMPLE、GL_TEXTURE_2D_MULTISAMPLE_ARRAY：用于多重采样抗锯齿（MSAA），提高图像质量</li>
</ul>
<h3 id="在着色器里读取纹理数据"><a class="markdownIt-Anchor" href="#在着色器里读取纹理数据"></a> 在着色器里读取纹理数据</h3>
<ul>
<li>在创建并向纹理写入数据后，可以在着色器读取纹理数据来为片段着色</li>
<li>着色器中代表纹理的数据类型为采样器，不同的纹理类型对应不同的采样器类型
<ul>
<li>二维纹理的采样器类型：Sampler2D</li>
</ul>
</li>
</ul>
<p>在声明采样器变量后，通过 texture() 函数读取纹理坐标下的数据：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 460 core</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2D</span> s;</span><br><span class="line"><span class="keyword">out</span> <span class="type">vec4</span> color;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main(<span class="type">void</span>) &#123;</span><br><span class="line">  color = <span class="built_in">texture</span>(s, <span class="built_in">gl_FragCoord</span>.xy / <span class="built_in">textureSize</span>(s, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="demo_app" id="_ch5_4_simpletexture"></div>

<h4 id="采样器类型"><a class="markdownIt-Anchor" href="#采样器类型"></a> 采样器类型</h4>
<p>每种纹理对应的采样器：</p>
<table>
<thead>
<tr>
<th style="text-align:left">纹理目标</th>
<th style="text-align:left">采样器类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GL_TEXTURE_1D</td>
<td style="text-align:left">sampler1D</td>
</tr>
<tr>
<td style="text-align:left">GL_TEXTURE_2D</td>
<td style="text-align:left">sampler2D</td>
</tr>
<tr>
<td style="text-align:left">GL_TEXTURE_3D</td>
<td style="text-align:left">sampler3D</td>
</tr>
<tr>
<td style="text-align:left">GL_TEXTURE_RECTANGLE</td>
<td style="text-align:left">sampler2DRect</td>
</tr>
<tr>
<td style="text-align:left">GL_TEXTURE_1D_ARRAY</td>
<td style="text-align:left">sampler1DArray</td>
</tr>
<tr>
<td style="text-align:left">GL_TEXTURE_2D_ARRAY</td>
<td style="text-align:left">sampler2DArray</td>
</tr>
<tr>
<td style="text-align:left">GL_TEXTURE_CUBE_MAP</td>
<td style="text-align:left">samplerCube</td>
</tr>
<tr>
<td style="text-align:left">GL_TEXTURE_CUBE_MAP_ARRAY</td>
<td style="text-align:left">samplerCubeArray</td>
</tr>
<tr>
<td style="text-align:left">GL_TEXTURE_BUFFER</td>
<td style="text-align:left">samplerBuffer</td>
</tr>
<tr>
<td style="text-align:left">GL_TEXTURE_2D_MULTISAMPLE</td>
<td style="text-align:left">sampler2DMS</td>
</tr>
<tr>
<td style="text-align:left">GL_TEXTURE_2D_MULTISAMPLE_ARRAY</td>
<td style="text-align:left">sampler2DMSArray</td>
</tr>
</tbody>
</table>
<p>纹理存储的数据类型与采样器的关系：</p>
<ul>
<li>存储浮点数据的纹理：sampler1D,…</li>
<li>存储有符号整数的纹理：添加前缀i，isampler1D, …</li>
<li>存储无符号整数的纹理：添加前缀u，usampler1D, …</li>
</ul>
<p>内置函数 texelFetch() 读取着色器中的纹理：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">vec4</span> <span class="built_in">texelFetch</span>(<span class="type">sampler1D</span> s, <span class="type">int</span> P, <span class="type">int</span> lod);</span><br><span class="line"><span class="type">vec4</span> <span class="built_in">texelFetch</span>(<span class="type">sampler2D</span> s, <span class="type">ivec2</span> P, <span class="type">int</span> lod);</span><br><span class="line"><span class="type">ivec4</span> <span class="built_in">texelFetch</span>(<span class="type">isampler2D</span> s, <span class="type">ivec2</span> P, <span class="type">int</span> lod);</span><br><span class="line"><span class="type">uvec4</span> <span class="built_in">texelFetch</span>(<span class="type">usampler3D</span> s, <span class="type">ivec3</span> P, <span class="type">int</span> lod);</span><br></pre></td></tr></table></figure>
<ul>
<li>s：纹理的采样器变量</li>
<li>P：纹理坐标</li>
<li>lod：分级细化等级</li>
</ul>
<p>虽然纹理对象的数据格式不同，这些函数都返回四维向量。如果纹理通道小于 4 (RGBA)，则绿色通道和蓝色通道的默认值为0，而alpha通道的默认值为1</p>
<p>内置函数 textureSize() 用来查询纹理尺寸：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="built_in">textureSize</span>(<span class="type">sampler1D</span> sampler, <span class="type">int</span> lod);</span><br><span class="line"><span class="type">ivec2</span> <span class="built_in">textureSize</span>(<span class="type">sampler2D</span> sampler, <span class="type">int</span> lod);</span><br><span class="line"><span class="type">ivec3</span> <span class="built_in">textureSize</span>(gsampler3D sampler, <span class="type">int</span> lod);</span><br></pre></td></tr></table></figure>
<p>查询多重采样纹理的采样数：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> textureSamples(<span class="type">sampler2DMS</span> sampler);</span><br></pre></td></tr></table></figure>
<h3 id="从文件载入纹理"><a class="markdownIt-Anchor" href="#从文件载入纹理"></a> 从文件载入纹理</h3>
<ul>
<li>ktx（Khronos纹理格式）：专门为存储 OpenGL 纹理的东西而设计的。</li>
<li>.ktx文件包含了大多数需要传递给 OpenGL 的参数，以便直接从文件加载纹理。</li>
</ul>
<p>用《OpenGL 超级宝典》里自带的函数载入：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">tex</span> = sb7::ktx::file::<span class="title function_ invoke__">load</span>(<span class="string">&quot;media/textures/tree.ktx&quot;</span>).<span class="title function_ invoke__">unwrap</span>().<span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>也可以使用第三方库（如 stb_image）自己载入图片，只需要在 Cargo.toml 里添加依赖：</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">stb_image</span> = <span class="string">&quot;^0.2.3&quot;</span></span><br></pre></td></tr></table></figure>
<p>比如要载入这样一张图片：</p>
<p><img src="./Opengl-logo.png" alt="opegl-logo" /></p>
<p>读取图片像素过程：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> sb7::application::*;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   vao: <span class="type">u32</span>,</span><br><span class="line">#   vbo: <span class="type">u32</span>,</span><br><span class="line">#   prog: <span class="type">u32</span>,</span><br><span class="line">#   uniform_trans: <span class="type">i32</span>,</span><br><span class="line">#   tex: <span class="type">u32</span></span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#     #version 460 core</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     layout (location = 0) in vec3 position;</span></span><br><span class="line"><span class="string">#     layout (location = 1) in vec2 tc;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     out vec2 tex_tc;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     uniform mat4 trans = mat4(1.0);</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       gl_Position = trans * vec4(position, 1.0);</span></span><br><span class="line"><span class="string">#       tex_tc = vec2(1.0 - tc.x, tc.y);</span></span><br><span class="line"><span class="string">#     &#125;</span></span><br><span class="line"><span class="string">#     &quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#     #version 460 core</span></span><br><span class="line"><span class="string">#     </span></span><br><span class="line"><span class="string">#     in vec2 tex_tc;</span></span><br><span class="line"><span class="string">#     out vec4 color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     uniform sampler2D s;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       vec4 tex_color = texture(s, tex_tc);</span></span><br><span class="line"><span class="string">#       color = mix(vec4(1.0), tex_color, tex_color.a);</span></span><br><span class="line"><span class="string">#       // color = vec4(1.0);</span></span><br><span class="line"><span class="string">#     &#125;</span></span><br><span class="line"><span class="string">#     &quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">self</span>.prog = sb7::program::<span class="title function_ invoke__">link_from_shaders</span>(&amp;[</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(vs_src, gl::VERTEX_SHADER, <span class="literal">true</span>),</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(fs_src, gl::FRAGMENT_SHADER, <span class="literal">true</span>),</span><br><span class="line">#     ], <span class="literal">true</span>);</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">query_name</span> = |name: &amp;<span class="type">str</span>| <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">name</span> = std::ffi::CString::<span class="title function_ invoke__">new</span>(name).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetUniformLocation</span>(<span class="keyword">self</span>.prog, name.<span class="title function_ invoke__">as_ptr</span>())</span><br><span class="line">#     &#125;;</span><br><span class="line">#     <span class="keyword">self</span>.uniform_trans = <span class="title function_ invoke__">query_name</span>(<span class="string">&quot;trans&quot;</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vertex_position</span> : &amp;[<span class="type">f32</span>]= &amp;[</span><br><span class="line">#       <span class="comment">// position        // tc</span></span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span></span><br><span class="line">#     ];</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">use</span> std::mem::&#123; size_of, size_of_val &#125;;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.vao);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindVertexArray</span>(<span class="keyword">self</span>.vao);</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindBuffer</span>(gl::ARRAY_BUFFER, <span class="keyword">self</span>.vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferData</span>(<span class="keyword">self</span>.vbo,</span><br><span class="line">#                           <span class="title function_ invoke__">size_of_val</span>(vertex_position) <span class="keyword">as</span> _,</span><br><span class="line">#                           vertex_position.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _,</span><br><span class="line">#                           gl::STATIC_DRAW);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexAttribPointer</span>(<span class="number">0</span>, <span class="number">3</span>, gl::FLOAT, gl::FALSE,</span><br><span class="line">#                               (<span class="number">5</span> * size_of::&lt;<span class="type">f32</span>&gt;()) <span class="keyword">as</span> _,</span><br><span class="line">#                               <span class="number">0</span> <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexAttribPointer</span>(<span class="number">1</span>, <span class="number">2</span>, gl::FLOAT, gl::FALSE,</span><br><span class="line">#                               (<span class="number">5</span> * size_of::&lt;<span class="type">f32</span>&gt;()) <span class="keyword">as</span> _,</span><br><span class="line">#                               (<span class="number">3</span> * size_of::&lt;<span class="type">f32</span>&gt;()) <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(<span class="keyword">self</span>.vao, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(<span class="keyword">self</span>.vao, <span class="number">1</span>);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">    <span class="keyword">let</span> (width, height, img_data, img_depth) = &#123;</span><br><span class="line">      <span class="keyword">use</span> stb_image::image::*;</span><br><span class="line">      <span class="keyword">match</span> <span class="title function_ invoke__">load</span>(<span class="string">&quot;Opengl-logo.png&quot;</span>) &#123;</span><br><span class="line">        LoadResult::<span class="title function_ invoke__">ImageU8</span>(img) =&gt; (</span><br><span class="line">          img.width, img.height, img.data, img.depth</span><br><span class="line">        ),</span><br><span class="line">        _ =&gt; <span class="built_in">unimplemented!</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">#     <span class="built_in">assert_eq!</span>(img_depth, <span class="number">4</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateTextures</span>(gl::TEXTURE_2D, <span class="number">1</span>, &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.tex);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindTexture</span>(gl::TEXTURE_2D, <span class="keyword">self</span>.tex);</span><br><span class="line">#       gl::<span class="title function_ invoke__">TexStorage2D</span>(gl::TEXTURE_2D, <span class="number">1</span>,</span><br><span class="line">#                        gl::RGBA8, width <span class="keyword">as</span> _, height <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">TexSubImage2D</span>(gl::TEXTURE_2D, <span class="number">0</span>,</span><br><span class="line">#                         <span class="number">0</span>, <span class="number">0</span>, width <span class="keyword">as</span> _, height <span class="keyword">as</span> _,</span><br><span class="line">#                         gl::RGBA, gl::UNSIGNED_BYTE, img_data.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">TexParameteri</span>(gl::TEXTURE_2D, gl::TEXTURE_WRAP_S,</span><br><span class="line">#                         gl::CLAMP_TO_EDGE <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">TexParameteri</span>(gl::TEXTURE_2D, gl::TEXTURE_WRAP_T,</span><br><span class="line">#                         gl::CLAMP_TO_EDGE <span class="keyword">as</span> _);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">Enable</span>(gl::DEPTH_TEST);</span><br><span class="line">#       gl::<span class="title function_ invoke__">UseProgram</span>(<span class="keyword">self</span>.prog);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">t</span> = current_time <span class="keyword">as</span> <span class="type">f32</span> * <span class="number">40.0</span>;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">AppConfig</span> &#123; width, height, .. &#125; = <span class="keyword">self</span>.<span class="title function_ invoke__">info</span>();</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">trans</span> = sb7::vmath::<span class="title function_ invoke__">perspective</span>(<span class="number">45.0</span>,</span><br><span class="line">#                                         width <span class="keyword">as</span> <span class="type">f32</span> / height <span class="keyword">as</span> <span class="type">f32</span>,</span><br><span class="line">#                                         <span class="number">0.1</span>, <span class="number">1000.0</span>)</span><br><span class="line">#       * sb7::vmath::<span class="title function_ invoke__">translate</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, -<span class="number">3.5</span>)</span><br><span class="line">#       * sb7::vmath::<span class="title function_ invoke__">rotate</span>(t, t, t);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR, <span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::DEPTH, <span class="number">0</span>, [<span class="number">1.0</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">ProgramUniformMatrix4fv</span>(<span class="keyword">self</span>.prog,</span><br><span class="line">#                                   <span class="keyword">self</span>.uniform_trans, <span class="number">1</span>,</span><br><span class="line">#                                   gl::FALSE,</span><br><span class="line">#                                   std::ptr::addr_of!(trans) <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vao);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.prog);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteTextures</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.tex);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>();</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>通过载入的图片数据创建纹理对象：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> sb7::application::*;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   vao: <span class="type">u32</span>,</span><br><span class="line">#   vbo: <span class="type">u32</span>,</span><br><span class="line">#   prog: <span class="type">u32</span>,</span><br><span class="line">#   uniform_trans: <span class="type">i32</span>,</span><br><span class="line">#   tex: <span class="type">u32</span></span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#     #version 460 core</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     layout (location = 0) in vec3 position;</span></span><br><span class="line"><span class="string">#     layout (location = 1) in vec2 tc;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     out vec2 tex_tc;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     uniform mat4 trans = mat4(1.0);</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       gl_Position = trans * vec4(position, 1.0);</span></span><br><span class="line"><span class="string">#       tex_tc = vec2(1.0 - tc.x, tc.y);</span></span><br><span class="line"><span class="string">#     &#125;</span></span><br><span class="line"><span class="string">#     &quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#     #version 460 core</span></span><br><span class="line"><span class="string">#     </span></span><br><span class="line"><span class="string">#     in vec2 tex_tc;</span></span><br><span class="line"><span class="string">#     out vec4 color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     uniform sampler2D s;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       vec4 tex_color = texture(s, tex_tc);</span></span><br><span class="line"><span class="string">#       color = mix(vec4(1.0), tex_color, tex_color.a);</span></span><br><span class="line"><span class="string">#       // color = vec4(1.0);</span></span><br><span class="line"><span class="string">#     &#125;</span></span><br><span class="line"><span class="string">#     &quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">self</span>.prog = sb7::program::<span class="title function_ invoke__">link_from_shaders</span>(&amp;[</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(vs_src, gl::VERTEX_SHADER, <span class="literal">true</span>),</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(fs_src, gl::FRAGMENT_SHADER, <span class="literal">true</span>),</span><br><span class="line">#     ], <span class="literal">true</span>);</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">query_name</span> = |name: &amp;<span class="type">str</span>| <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">name</span> = std::ffi::CString::<span class="title function_ invoke__">new</span>(name).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetUniformLocation</span>(<span class="keyword">self</span>.prog, name.<span class="title function_ invoke__">as_ptr</span>())</span><br><span class="line">#     &#125;;</span><br><span class="line">#     <span class="keyword">self</span>.uniform_trans = <span class="title function_ invoke__">query_name</span>(<span class="string">&quot;trans&quot;</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vertex_position</span> : &amp;[<span class="type">f32</span>]= &amp;[</span><br><span class="line">#       <span class="comment">// position        // tc</span></span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span></span><br><span class="line">#     ];</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">use</span> std::mem::&#123; size_of, size_of_val &#125;;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.vao);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindVertexArray</span>(<span class="keyword">self</span>.vao);</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindBuffer</span>(gl::ARRAY_BUFFER, <span class="keyword">self</span>.vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferData</span>(<span class="keyword">self</span>.vbo,</span><br><span class="line">#                           <span class="title function_ invoke__">size_of_val</span>(vertex_position) <span class="keyword">as</span> _,</span><br><span class="line">#                           vertex_position.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _,</span><br><span class="line">#                           gl::STATIC_DRAW);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexAttribPointer</span>(<span class="number">0</span>, <span class="number">3</span>, gl::FLOAT, gl::FALSE,</span><br><span class="line">#                               (<span class="number">5</span> * size_of::&lt;<span class="type">f32</span>&gt;()) <span class="keyword">as</span> _,</span><br><span class="line">#                               <span class="number">0</span> <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexAttribPointer</span>(<span class="number">1</span>, <span class="number">2</span>, gl::FLOAT, gl::FALSE,</span><br><span class="line">#                               (<span class="number">5</span> * size_of::&lt;<span class="type">f32</span>&gt;()) <span class="keyword">as</span> _,</span><br><span class="line">#                               (<span class="number">3</span> * size_of::&lt;<span class="type">f32</span>&gt;()) <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(<span class="keyword">self</span>.vao, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(<span class="keyword">self</span>.vao, <span class="number">1</span>);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> (width, height, img_data, img_depth) = &#123;</span><br><span class="line">#       <span class="keyword">use</span> stb_image::image::*;</span><br><span class="line">#       <span class="keyword">match</span> <span class="title function_ invoke__">load</span>(<span class="string">&quot;Opengl-logo.png&quot;</span>) &#123;</span><br><span class="line">#         LoadResult::<span class="title function_ invoke__">ImageU8</span>(img) =&gt; (</span><br><span class="line">#           img.width, img.height, img.data, img.depth</span><br><span class="line">#         ),</span><br><span class="line">#         _ =&gt; <span class="built_in">unimplemented!</span>()</span><br><span class="line">#       &#125;</span><br><span class="line">#     &#125;;</span><br><span class="line">#     <span class="built_in">assert_eq!</span>(img_depth, <span class="number">4</span>);</span><br><span class="line"># </span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateTextures</span>(gl::TEXTURE_2D, <span class="number">1</span>, &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.tex);</span><br><span class="line">      gl::<span class="title function_ invoke__">BindTexture</span>(gl::TEXTURE_2D, <span class="keyword">self</span>.tex);</span><br><span class="line">      gl::<span class="title function_ invoke__">TexStorage2D</span>(gl::TEXTURE_2D, <span class="number">1</span>,</span><br><span class="line">                       gl::RGBA8, width <span class="keyword">as</span> _, height <span class="keyword">as</span> _);</span><br><span class="line">      gl::<span class="title function_ invoke__">TexSubImage2D</span>(gl::TEXTURE_2D, <span class="number">0</span>,</span><br><span class="line">                        <span class="number">0</span>, <span class="number">0</span>, width <span class="keyword">as</span> _, height <span class="keyword">as</span> _,</span><br><span class="line">                        gl::RGBA, gl::UNSIGNED_BYTE, img_data.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">TexParameteri</span>(gl::TEXTURE_2D, gl::TEXTURE_WRAP_S,</span><br><span class="line">#                         gl::CLAMP_TO_EDGE <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">TexParameteri</span>(gl::TEXTURE_2D, gl::TEXTURE_WRAP_T,</span><br><span class="line">#                         gl::CLAMP_TO_EDGE <span class="keyword">as</span> _);</span><br><span class="line">    &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">Enable</span>(gl::DEPTH_TEST);</span><br><span class="line">#       gl::<span class="title function_ invoke__">UseProgram</span>(<span class="keyword">self</span>.prog);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">t</span> = current_time <span class="keyword">as</span> <span class="type">f32</span> * <span class="number">40.0</span>;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">AppConfig</span> &#123; width, height, .. &#125; = <span class="keyword">self</span>.<span class="title function_ invoke__">info</span>();</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">trans</span> = sb7::vmath::<span class="title function_ invoke__">perspective</span>(<span class="number">45.0</span>,</span><br><span class="line">#                                         width <span class="keyword">as</span> <span class="type">f32</span> / height <span class="keyword">as</span> <span class="type">f32</span>,</span><br><span class="line">#                                         <span class="number">0.1</span>, <span class="number">1000.0</span>)</span><br><span class="line">#       * sb7::vmath::<span class="title function_ invoke__">translate</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, -<span class="number">3.5</span>)</span><br><span class="line">#       * sb7::vmath::<span class="title function_ invoke__">rotate</span>(t, t, t);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR, <span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::DEPTH, <span class="number">0</span>, [<span class="number">1.0</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">ProgramUniformMatrix4fv</span>(<span class="keyword">self</span>.prog,</span><br><span class="line">#                                   <span class="keyword">self</span>.uniform_trans, <span class="number">1</span>,</span><br><span class="line">#                                   gl::FALSE,</span><br><span class="line">#                                   std::ptr::addr_of!(trans) <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vao);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.prog);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteTextures</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.tex);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>();</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>效果大概是这样子：</p>

<div id="_ch5_4_0_load_png" class="demo_app"></div>

<h4 id="纹理坐标"><a class="markdownIt-Anchor" href="#纹理坐标"></a> 纹理坐标</h4>
<p>在着色器里一般会用 texture() 来读取纹理数据，一张纹理对应的坐标范围为 0.0 ~ 1.0：</p>
<p><img src="tex_coords.png" alt="tex_coord" /></p>
<ul>
<li>但其实可以将纹理坐标设置为任意值，超出 0.0 ~ 1.0 的部分，OpenGL 会将纹理按照一定的方式进行平铺处理</li>
<li>纹理坐标一般会作为顶点属性传入顶点着色器，然后输出到片段着色器，中间的像素的纹理坐标由 GPU 生成</li>
</ul>
<p>顶点数据：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">vertex_position</span> : &amp;[<span class="type">f32</span>]= &amp;[</span><br><span class="line">  <span class="comment">// position        // tc</span></span><br><span class="line">  -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">   <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">   <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">   ...</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>对应的顶点着色器：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450 core</span></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> mv_matrix;</span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> proj_matrix;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">in</span> <span class="type">vec4</span> position;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">4</span>) <span class="keyword">in</span> <span class="type">vec2</span> tc;</span><br><span class="line"><span class="keyword">out</span> VS_OUT</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">vec2</span> tc;</span><br><span class="line">&#125; vs_out;</span><br><span class="line"><span class="type">void</span> main(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Calculate the position of each vertex</span></span><br><span class="line">  <span class="type">vec4</span> pos_vs = mv_matrix * position;</span><br><span class="line">  <span class="comment">// Pass the texture coordinate through unmodified</span></span><br><span class="line">  vs_out.tc = tc;</span><br><span class="line">  <span class="built_in">gl_Position</span> = proj_matrix * pos_vs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>片段着色器：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450 core</span></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>) <span class="keyword">uniform</span> <span class="type">sampler2D</span> tex_object;</span><br><span class="line"><span class="comment">// Input from vertex shader</span></span><br><span class="line"><span class="keyword">in</span> VS_OUT</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">vec2</span> tc;</span><br><span class="line">&#125; fs_in;</span><br><span class="line"><span class="comment">// Output to framebuffer</span></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec4</span> color;</span><br><span class="line"><span class="type">void</span> main(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Simply read from the texture at the (scaled) coordinates and</span></span><br><span class="line">  <span class="comment">// assign the result to the shader&#x27;s output.</span></span><br><span class="line">  color = <span class="built_in">texture</span>(tex_object, fs_in.tc * <span class="type">vec2</span>(<span class="number">3.0</span>, <span class="number">1.0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过向每个顶点传递纹理坐标，可以将纹理环绕在物体周围。</p>
<p>纹理坐标一般使用建模软件进行分配，并存储模型文件里。将棋盘格图案加载到纹理中，并将其应用到模型上，效果如下:</p>

<div class="demo_app" id="_ch5_5_simpletexcoords"></div>

<h3 id="控制纹理数据的读取方式"><a class="markdownIt-Anchor" href="#控制纹理数据的读取方式"></a> 控制纹理数据的读取方式</h3>
<p>OpenGL 在读取纹理数据的方式十分灵活，纹理坐标的范围一般是规范化的，在0.0 到 1.0之间，在 OpenGL 里，用来控制纹理读取方式的对象为采样器对象，其中包含了两种常用的属性：</p>
<ul>
<li>WRAP_MODE：环绕方式，当纹理坐标超出 0.0 ~ 1.0 时，控制 OpenGL 如何读取纹理像素</li>
<li>FILTER_MODE：过滤方式，当纹理在渲染时被缩放时，控制 OpenGL 对像素的采样方式</li>
</ul>
<p>创建采样器对象：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glCreateSamplers</span><span class="params">(GLsizei n, GLuint * samplers)</span>;</span><br></pre></td></tr></table></figure>
<p>设置采样器属性：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glSamplerParameteri</span><span class="params">(GLuint sampler,</span></span><br><span class="line"><span class="params">                         GLenum pname,</span></span><br><span class="line"><span class="params">                         GLint param)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">glSamplerParameterf</span><span class="params">(GLuint sampler,</span></span><br><span class="line"><span class="params">                         GLenum pname,</span></span><br><span class="line"><span class="params">                         GLfloat param)</span>;</span><br></pre></td></tr></table></figure>
<p>您将需要绑定一个采样器对象才能使用它，但在这种情况下，您将它绑定到一个纹理单元，就像您将纹理绑定到一个纹理单元一样。用于将采样器对象绑定到纹理单元之一的函数是glBindSampler()，其原型是:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glBindSampler</span><span class="params">(GLuint unit, GLuint sampler)</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> gl::*;</span><br><span class="line"># <span class="keyword">use</span> sb7::application::*;</span><br><span class="line"># <span class="keyword">use</span> imgui_glfw_rs::glfw;</span><br><span class="line"># <span class="keyword">use</span> std::&#123;ffi::CString, ptr::addr_of&#125;;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">Uniforms</span> &#123;</span><br><span class="line">#   mv_matrix:   <span class="type">i32</span>,</span><br><span class="line">#   proj_matrix: <span class="type">i32</span>,</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   tex_object:     [<span class="type">u32</span>; <span class="number">2</span>],</span><br><span class="line">#   tex_index:      <span class="type">usize</span>,</span><br><span class="line">#   render_prog:    <span class="type">u32</span>,</span><br><span class="line">#   uniforms:       Uniforms,</span><br><span class="line">#   object:         sb7::object::Object,</span><br><span class="line">  sampler_object: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">init</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> AppConfig &#123;</span><br><span class="line">#     AppConfig &#123; title: <span class="string">&quot;OpenGL SuperBible - Texture Coordinates&quot;</span>.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">#                 ..<span class="built_in">Default</span>::<span class="title function_ invoke__">default</span>() &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="built_in">macro_rules!</span> tex_data &#123;</span><br><span class="line">#       (@a W) =&gt; ([ <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFFu8</span> ]);</span><br><span class="line">#       (@a B) =&gt; ([ <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00u8</span> ]);</span><br><span class="line">#       ($($x: ident),+ $(,)?) =&gt; ([$(tex_data!(@a $x),)*].<span class="title function_ invoke__">concat</span>());</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">tex_data</span> = tex_data! &#123;</span><br><span class="line">#       B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,</span><br><span class="line">#       W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,</span><br><span class="line">#       B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,</span><br><span class="line">#       W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,</span><br><span class="line">#       B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,</span><br><span class="line">#       W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,</span><br><span class="line">#       B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,</span><br><span class="line">#       W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,</span><br><span class="line">#       B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,</span><br><span class="line">#       W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,</span><br><span class="line">#       B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,</span><br><span class="line">#       W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,</span><br><span class="line">#       B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,</span><br><span class="line">#       W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,</span><br><span class="line">#       B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,</span><br><span class="line">#       W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,</span><br><span class="line">#     &#125;;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="title function_ invoke__">GenTextures</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.tex_object[<span class="number">0</span>]);</span><br><span class="line">#       <span class="title function_ invoke__">BindTexture</span>(TEXTURE_2D, <span class="keyword">self</span>.tex_object[<span class="number">0</span>]);</span><br><span class="line">#       <span class="title function_ invoke__">TexStorage2D</span>(TEXTURE_2D, <span class="number">1</span>, RGB8, <span class="number">16</span>, <span class="number">16</span>);</span><br><span class="line">#       <span class="title function_ invoke__">TexSubImage2D</span>(TEXTURE_2D, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">16</span>,</span><br><span class="line">#                     RGBA, UNSIGNED_BYTE,</span><br><span class="line">#                     tex_data[..].<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _);</span><br><span class="line"># </span><br><span class="line">      <span class="title function_ invoke__">GenSamplers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.sampler_object);</span><br><span class="line">      <span class="title function_ invoke__">SamplerParameteri</span>(<span class="keyword">self</span>.sampler_object,TEXTURE_MIN_FILTER,</span><br><span class="line">                        NEAREST <span class="keyword">as</span> _);</span><br><span class="line">      <span class="title function_ invoke__">SamplerParameteri</span>(<span class="keyword">self</span>.sampler_object, TEXTURE_MAG_FILTER,</span><br><span class="line">                        NEAREST <span class="keyword">as</span> _);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">self</span>.tex_object[<span class="number">1</span>] = </span><br><span class="line">#       sb7::ktx::file::<span class="title function_ invoke__">load</span>(<span class="string">&quot;media/textures/pattern1.ktx&quot;</span>).<span class="title function_ invoke__">unwrap</span>().<span class="number">0</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">self</span>.object.<span class="title function_ invoke__">load</span>(<span class="string">&quot;media/objects/torus_nrms_tc.sbm&quot;</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">self</span>.<span class="title function_ invoke__">load_shaders</span>();</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="title function_ invoke__">Enable</span>(DEPTH_TEST);</span><br><span class="line">#       <span class="title function_ invoke__">DepthFunc</span>(LEQUAL);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">AppConfig</span> &#123; width, height, .. &#125; = AppConfig::<span class="title function_ invoke__">default</span>();</span><br><span class="line">#     <span class="keyword">self</span>.<span class="title function_ invoke__">on_resize</span>(width <span class="keyword">as</span> _, height <span class="keyword">as</span> _);</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">grey</span> = [<span class="number">0.2</span>, <span class="number">0.2</span>, <span class="number">0.2</span>, <span class="number">1.0f32</span>].<span class="title function_ invoke__">as_ptr</span>();</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">ones</span> = [<span class="number">1.0f32</span>].<span class="title function_ invoke__">as_ptr</span>();</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="title function_ invoke__">ClearBufferfv</span>(COLOR, <span class="number">0</span>, grey);</span><br><span class="line">#       <span class="title function_ invoke__">ClearBufferfv</span>(DEPTH, <span class="number">0</span>, ones);</span><br><span class="line"># </span><br><span class="line">#       <span class="title function_ invoke__">BindTexture</span>(TEXTURE_2D, <span class="keyword">self</span>.tex_object[<span class="keyword">self</span>.tex_index]);</span><br><span class="line">      <span class="title function_ invoke__">BindSampler</span>(<span class="number">0</span>, <span class="keyword">self</span>.sampler_object);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">mv_proj</span> =</span><br><span class="line">#         sb7::vmath::<span class="title function_ invoke__">translate</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, -<span class="number">3.0</span>)</span><br><span class="line">#         * sb7::vmath::<span class="title function_ invoke__">rotate_with_axis</span>(current_time <span class="keyword">as</span> <span class="type">f32</span> * <span class="number">19.3</span>,</span><br><span class="line">#                                        <span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>)</span><br><span class="line">#         * sb7::vmath::<span class="title function_ invoke__">rotate_with_axis</span>(current_time <span class="keyword">as</span> <span class="type">f32</span> * <span class="number">21.1</span>,</span><br><span class="line">#                                        <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line"># </span><br><span class="line">#       <span class="title function_ invoke__">UniformMatrix4fv</span>(<span class="keyword">self</span>.uniforms.mv_matrix, <span class="number">1</span>, FALSE,</span><br><span class="line">#                        addr_of!(mv_proj) <span class="keyword">as</span> _);</span><br><span class="line"># </span><br><span class="line">#       <span class="keyword">self</span>.object.<span class="title function_ invoke__">render</span>();</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">on_resize</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, w: <span class="type">i32</span>, h: <span class="type">i32</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">proj_matrix</span> = sb7::vmath::<span class="title function_ invoke__">perspective</span>(<span class="number">60.0</span>,</span><br><span class="line">#                                               w <span class="keyword">as</span> <span class="type">f32</span> / h <span class="keyword">as</span> <span class="type">f32</span>,</span><br><span class="line">#                                               <span class="number">0.1</span>, <span class="number">1000.0</span>);</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="title function_ invoke__">UniformMatrix4fv</span>(<span class="keyword">self</span>.uniforms.proj_matrix,</span><br><span class="line">#                        <span class="number">1</span>, FALSE, addr_of!(proj_matrix) <span class="keyword">as</span> _);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="title function_ invoke__">DeleteTextures</span>(<span class="number">2</span>, <span class="keyword">self</span>.tex_object.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       <span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.render_prog);</span><br><span class="line">#       <span class="title function_ invoke__">DeleteSamplers</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.sampler_object);</span><br><span class="line">#       <span class="keyword">self</span>.object.<span class="title function_ invoke__">free</span>();</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">on_key</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: glfw::Key, press: glfw::Action) &#123;</span><br><span class="line">#     <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">glfw</span>::Action::Press = press &#123;</span><br><span class="line">#       <span class="keyword">match</span> key &#123;</span><br><span class="line">#         glfw::Key::R =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">load_shaders</span>(),</span><br><span class="line">#         glfw::Key::T =&gt; &#123;</span><br><span class="line">#           <span class="keyword">self</span>.tex_index += <span class="number">1</span>;</span><br><span class="line">#           <span class="keyword">if</span> <span class="keyword">self</span>.tex_index &gt; <span class="number">1</span> &#123;</span><br><span class="line">#             <span class="keyword">self</span>.tex_index = <span class="number">0</span>;</span><br><span class="line">#           &#125;</span><br><span class="line">#         &#125;</span><br><span class="line">#         _ =&gt; &#123;&#125;</span><br><span class="line">#       &#125;</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>();</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">load_shaders</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">if</span> <span class="keyword">self</span>.render_prog != <span class="number">0</span> &#123;</span><br><span class="line">#       <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.render_prog) &#125;;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">self</span>.render_prog = sb7::program::<span class="title function_ invoke__">link_from_shaders</span>(&amp;[</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">load</span>(<span class="string">&quot;media/shaders/simpletexcoords/render.vs.glsl&quot;</span>, </span><br><span class="line">#                         VERTEX_SHADER, <span class="literal">true</span>),</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">load</span>(<span class="string">&quot;media/shaders/simpletexcoords/render.fs.glsl&quot;</span>, </span><br><span class="line">#                         FRAGMENT_SHADER, <span class="literal">true</span>)</span><br><span class="line">#     ], <span class="literal">true</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">location</span> = |name: &amp;<span class="type">str</span>| <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">name</span> = CString::<span class="title function_ invoke__">new</span>(name).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       <span class="title function_ invoke__">GetUniformLocation</span>(<span class="keyword">self</span>.render_prog, name.<span class="title function_ invoke__">as_ptr</span>())</span><br><span class="line">#     &#125;;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">self</span>.uniforms.mv_matrix = <span class="title function_ invoke__">location</span>(<span class="string">&quot;mv_matrix&quot;</span>);</span><br><span class="line">#     <span class="keyword">self</span>.uniforms.proj_matrix = <span class="title function_ invoke__">location</span>(<span class="string">&quot;proj_matrix&quot;</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="title function_ invoke__">UseProgram</span>(<span class="keyword">self</span>.render_prog);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p><code>glBindSampler()</code> 的第一个参数 <code>unit</code> 指的是<strong>纹理单元</strong>，本质上纹理单元只是一个大于等于 0 的整数，可以看成纹理对象和采样器对象之间的桥梁。除了调用 <code>glBindSampler()</code> 以外，还需要用 <code>glBindTextureUnit()</code> 为纹理对象指定纹理单元：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glBindTextureUnit</span><span class="params">(GLuint unit,</span></span><br><span class="line"><span class="params">                       GLuint texture)</span>;</span><br></pre></td></tr></table></figure>
<p>纹理单元、纹理对象、采样器对象之间的关系如下，每个纹理单元只能和一个纹理对象绑定：</p>
<p><img src="sampler_texture.png" alt="test" /></p>
<p>其实类似的配置过程之前已经用过了，配置 vao 的时候，vbo 和顶点属性之间也隔着一个 binding index。这样的好处是提供了足够的灵活性：</p>
<ul>
<li>可以将多个纹理绑定到相同的采样器上，这样就不用为每个纹理对象单独配置</li>
<li>如果需要修改纹理的参数的话，直接更新绑定点就行</li>
<li>可以将多个采样器绑到同一个纹理单元上</li>
</ul>
<p>其实每个纹理对象已经内置了默认的采样器，用 <code>glTextureParameteri() / glTextureParameterf()</code> 也可以直接设置纹理对象的属性：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glTextureParameterf</span><span class="params">(GLuint texture,</span></span><br><span class="line"><span class="params">                         GLenum pname,</span></span><br><span class="line"><span class="params">                         GLfloat param)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">glTextureParameteri</span><span class="params">(GLuint texture,</span></span><br><span class="line"><span class="params">                         GLenum pname,</span></span><br><span class="line"><span class="params">                         GLint param)</span>;</span><br></pre></td></tr></table></figure>
<p>如果需要在同一个着色器中使用多个纹理，需要将纹理绑定到不同的纹理单元：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GLuint textures[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create three 2D textures</span></span><br><span class="line">glCreateTextures(<span class="number">3</span>, GL_TEXTURE_2D, &amp;textures);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bind the three textures to the first three texture units</span></span><br><span class="line">glBindTextureUnit(<span class="number">0</span>, textures[<span class="number">0</span>]);</span><br><span class="line">glBindTextureUnit(<span class="number">1</span>, textures[<span class="number">1</span>]);</span><br><span class="line">glBindTextureUnit(<span class="number">2</span>, textures[<span class="number">2</span>]);</span><br></pre></td></tr></table></figure>
<p>然后在着色器里创建对应的 sampler 变量:</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>) <span class="keyword">uniform</span> <span class="type">sampler2D</span> foo;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">1</span>) <span class="keyword">uniform</span> <span class="type">sampler2D</span> bar;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">2</span>) <span class="keyword">uniform</span> <span class="type">sampler2D</span> baz;</span><br></pre></td></tr></table></figure>
<p>当然也可以创建 sampler 变量的数组，效果其实是一样的：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>) <span class="keyword">uniform</span> <span class="type">sampler2D</span> samplers[<span class="number">3</span>];</span><br></pre></td></tr></table></figure>
<p>下面看一个简单的例子，在着色器里定义 sampler2D 数组，在立方体的每个面渲染下面的图片，每张大小为 24x24：</p>

<div style="margin: auto">
<img src="assert_1.png" style="display: inline-block"/>
<img src="assert_2.png" style="display: inline-block"/>
<img src="assert_3.png" style="display: inline-block"/>
<img src="assert_4.png" style="display: inline-block"/>
<img src="assert_5.png" style="display: inline-block"/>
<img src="assert_6.png" style="display: inline-block"/>
</div>

<p>在片段着色器里定义 sampler2D 数组：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 460 core</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">in</span> <span class="type">vec2</span> tex_tc;</span><br><span class="line"><span class="keyword">in</span> <span class="keyword">flat</span> <span class="type">int</span> face_index;</span><br><span class="line"><span class="keyword">out</span> <span class="type">vec4</span> color;</span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>) <span class="keyword">uniform</span> <span class="type">sampler2D</span> s[<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">  color = <span class="built_in">texture</span>(s[face_index], tex_tc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>tex_tc</code> 代表纹理坐标，<code>face_index</code> 表示第几个面。对应的顶点着色器：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 460 core</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">in</span> <span class="type">vec3</span> position;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">in</span> <span class="type">vec2</span> tc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec2</span> tex_tc;</span><br><span class="line"><span class="keyword">out</span> <span class="keyword">flat</span> <span class="type">int</span> face_index;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> trans = <span class="type">mat4</span>(<span class="number">1.0</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">  <span class="built_in">gl_Position</span> = trans * <span class="type">vec4</span>(position, <span class="number">1.0</span>);</span><br><span class="line">  tex_tc = <span class="type">vec2</span>(tc.x, <span class="number">1.0</span> - tc.y);</span><br><span class="line">  face_index = <span class="built_in">gl_VertexID</span> / <span class="number">6</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>顶点数据（太长了自行展开，或者点击复制按钮）：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">vertex_position</span> : &amp;[<span class="type">f32</span>]= &amp;[</span><br><span class="line">  <span class="comment">// position        // tc</span></span><br><span class="line">  -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">   <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">#    <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#    <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#   -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#   -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#   -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#    <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#    <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#    <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#   -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#   -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#   -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#   -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#   -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#   -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#   -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#   -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#    <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#    <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#    <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#    <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#    <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#    <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#   -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#    <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#    <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#    <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#   -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#   -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line"># </span><br><span class="line">#   -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#    <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#    <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#    <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#   -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#   -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>读取纹理数据，分配纹理单元：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> sb7::application::*;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   prog: <span class="type">u32</span>,</span><br><span class="line">#   uniform_trans: <span class="type">i32</span>,</span><br><span class="line">#   vao: <span class="type">u32</span>,</span><br><span class="line">#   vbo: <span class="type">u32</span>,</span><br><span class="line">#   texs: [<span class="type">u32</span>; <span class="number">6</span>],</span><br><span class="line">#   samplers: [<span class="type">u32</span>; <span class="number">2</span>],</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vertex_position</span> : &amp;[<span class="type">f32</span>]= &amp;[</span><br><span class="line">#       <span class="comment">// position        // tc</span></span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span></span><br><span class="line">#     ];</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#     #version 460 core</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     layout (location = 0) in vec3 position;</span></span><br><span class="line"><span class="string">#     layout (location = 1) in vec2 tc;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     out vec2 tex_tc;</span></span><br><span class="line"><span class="string">#     out flat int face_index;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     uniform mat4 trans = mat4(1.0);</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       gl_Position = trans * vec4(position, 1.0);</span></span><br><span class="line"><span class="string">#       tex_tc = vec2(tc.x, 1.0 - tc.y);</span></span><br><span class="line"><span class="string">#       face_index = gl_VertexID / 6;</span></span><br><span class="line"><span class="string">#     &#125;</span></span><br><span class="line"><span class="string">#     &quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#     #version 460 core</span></span><br><span class="line"><span class="string">#     </span></span><br><span class="line"><span class="string">#     in vec2 tex_tc;</span></span><br><span class="line"><span class="string">#     in flat int face_index;</span></span><br><span class="line"><span class="string">#     out vec4 color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     layout (binding = 0) uniform sampler2D s[6];</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       color = texture(s[face_index], tex_tc);</span></span><br><span class="line"><span class="string">#     &#125;</span></span><br><span class="line"><span class="string">#     &quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">self</span>.prog = sb7::program::<span class="title function_ invoke__">link_from_shaders</span>(&amp;[</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(vs_src, gl::VERTEX_SHADER, <span class="literal">true</span>),</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(fs_src, gl::FRAGMENT_SHADER, <span class="literal">true</span>),</span><br><span class="line">#     ], <span class="literal">true</span>);</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">query_name</span> = |name: &amp;<span class="type">str</span>| <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">name</span> = std::ffi::CString::<span class="title function_ invoke__">new</span>(name).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetUniformLocation</span>(<span class="keyword">self</span>.prog, name.<span class="title function_ invoke__">as_ptr</span>())</span><br><span class="line">#     &#125;;</span><br><span class="line">#     <span class="keyword">self</span>.uniform_trans = <span class="title function_ invoke__">query_name</span>(<span class="string">&quot;trans&quot;</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">use</span> std::mem::&#123; size_of, size_of_val &#125;;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.vao);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindVertexArray</span>(<span class="keyword">self</span>.vao);</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindBuffer</span>(gl::ARRAY_BUFFER, <span class="keyword">self</span>.vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferData</span>(<span class="keyword">self</span>.vbo,</span><br><span class="line">#                           <span class="title function_ invoke__">size_of_val</span>(vertex_position) <span class="keyword">as</span> _,</span><br><span class="line">#                           vertex_position.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _,</span><br><span class="line">#                           gl::STATIC_DRAW);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexAttribPointer</span>(<span class="number">0</span>, <span class="number">3</span>, gl::FLOAT, gl::FALSE,</span><br><span class="line">#                               (<span class="number">5</span> * size_of::&lt;<span class="type">f32</span>&gt;()) <span class="keyword">as</span> _,</span><br><span class="line">#                               <span class="number">0</span> <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexAttribPointer</span>(<span class="number">1</span>, <span class="number">2</span>, gl::FLOAT, gl::FALSE,</span><br><span class="line">#                               (<span class="number">5</span> * size_of::&lt;<span class="type">f32</span>&gt;()) <span class="keyword">as</span> _,</span><br><span class="line">#                               (<span class="number">3</span> * size_of::&lt;<span class="type">f32</span>&gt;()) <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(<span class="keyword">self</span>.vao, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(<span class="keyword">self</span>.vao, <span class="number">1</span>);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      gl::<span class="title function_ invoke__">CreateTextures</span>(gl::TEXTURE_2D, <span class="number">6</span>, <span class="keyword">self</span>.texs.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line"># </span><br><span class="line">#       <span class="comment">// create samplers</span></span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateSamplers</span>(<span class="number">2</span>, <span class="keyword">self</span>.samplers.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line"># </span><br><span class="line">#       <span class="comment">// set filter mode</span></span><br><span class="line">#       gl::<span class="title function_ invoke__">SamplerParameteri</span>(<span class="keyword">self</span>.samplers[<span class="number">0</span>],</span><br><span class="line">#                             gl::TEXTURE_MAG_FILTER,</span><br><span class="line">#                             gl::LINEAR <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">SamplerParameteri</span>(<span class="keyword">self</span>.samplers[<span class="number">1</span>],</span><br><span class="line">#                             gl::TEXTURE_MAG_FILTER,</span><br><span class="line">#                             gl::NEAREST <span class="keyword">as</span> _);</span><br><span class="line"># </span><br><span class="line">      <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">6</span> &#123;</span><br><span class="line">        <span class="keyword">use</span> stb_image::image::&#123; load, LoadResult::*&#125;;</span><br><span class="line">        <span class="keyword">let</span> (w, h, data) = <span class="keyword">match</span> <span class="title function_ invoke__">load</span>(&amp;<span class="built_in">format!</span>(<span class="string">&quot;assert_&#123;&#125;.png&quot;</span>, i + <span class="number">1</span>)) &#123;</span><br><span class="line">          <span class="title function_ invoke__">ImageU8</span>(img) =&gt; (img.width, img.height, img.data),</span><br><span class="line">          _ =&gt; <span class="built_in">unimplemented!</span>()</span><br><span class="line">        &#125;;</span><br><span class="line">        gl::<span class="title function_ invoke__">BindTexture</span>(gl::TEXTURE_2D, <span class="keyword">self</span>.texs[i]);</span><br><span class="line">        gl::<span class="title function_ invoke__">TextureStorage2D</span>(<span class="keyword">self</span>.texs[i], <span class="number">1</span>, gl::RGBA8, w <span class="keyword">as</span> _, h <span class="keyword">as</span> _);</span><br><span class="line">        gl::<span class="title function_ invoke__">TexSubImage2D</span>(gl::TEXTURE_2D, <span class="number">0</span>,</span><br><span class="line">                          <span class="number">0</span>, <span class="number">0</span>, w <span class="keyword">as</span> _, h <span class="keyword">as</span> _,</span><br><span class="line">                          gl::RGBA, gl::UNSIGNED_BYTE, data.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// bind texture to texture unit</span></span><br><span class="line">        gl::<span class="title function_ invoke__">BindTextureUnit</span>(i <span class="keyword">as</span> _, <span class="keyword">self</span>.texs[i]);</span><br><span class="line"># </span><br><span class="line">#         <span class="comment">// bind texture unit to sampler object</span></span><br><span class="line">#         gl::<span class="title function_ invoke__">BindSampler</span>(i <span class="keyword">as</span> _, <span class="keyword">self</span>.samplers[i % <span class="number">2</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">Enable</span>(gl::DEPTH_TEST);</span><br><span class="line">#       gl::<span class="title function_ invoke__">UseProgram</span>(<span class="keyword">self</span>.prog);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">t</span> = current_time <span class="keyword">as</span> <span class="type">f32</span> * <span class="number">40.0</span>;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">AppConfig</span> &#123; width, height, .. &#125; = <span class="keyword">self</span>.<span class="title function_ invoke__">info</span>();</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">trans</span> = sb7::vmath::<span class="title function_ invoke__">perspective</span>(<span class="number">45.0</span>,</span><br><span class="line">#                                         width <span class="keyword">as</span> <span class="type">f32</span> / height <span class="keyword">as</span> <span class="type">f32</span>,</span><br><span class="line">#                                         <span class="number">0.1</span>, <span class="number">1000.0</span>)</span><br><span class="line">#       * sb7::vmath::<span class="title function_ invoke__">translate</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, -<span class="number">3.5</span>)</span><br><span class="line">#       * sb7::vmath::<span class="title function_ invoke__">rotate</span>(t, t, t);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR, <span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::DEPTH, <span class="number">0</span>, [<span class="number">1.0</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">ProgramUniformMatrix4fv</span>(<span class="keyword">self</span>.prog,</span><br><span class="line">#                                   <span class="keyword">self</span>.uniform_trans, <span class="number">1</span>,</span><br><span class="line">#                                   gl::FALSE,</span><br><span class="line">#                                   std::ptr::addr_of!(trans) <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindTexture</span>(gl::TEXTURE_2D, <span class="keyword">self</span>.texs[<span class="number">0</span>]);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.prog);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.prog);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteTextures</span>(<span class="number">6</span>, <span class="keyword">self</span>.texs.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteSamplers</span>(<span class="number">2</span>, <span class="keyword">self</span>.samplers.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>();</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>
<p>创建采样器对象，设置参数，将采样器对象绑定到纹理对象上：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">use</span> sb7::application::*;</span><br><span class="line"># </span><br><span class="line"># <span class="meta">#[derive(Default)]</span></span><br><span class="line"># <span class="keyword">struct</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   prog: <span class="type">u32</span>,</span><br><span class="line">#   uniform_trans: <span class="type">i32</span>,</span><br><span class="line">#   vao: <span class="type">u32</span>,</span><br><span class="line">#   vbo: <span class="type">u32</span>,</span><br><span class="line">#   texs: [<span class="type">u32</span>; <span class="number">6</span>],</span><br><span class="line">#   samplers: [<span class="type">u32</span>; <span class="number">2</span>],</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">impl</span> <span class="title class_">Application</span> <span class="keyword">for</span> <span class="title class_">App</span> &#123;</span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">startup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vertex_position</span> : &amp;[<span class="type">f32</span>]= &amp;[</span><br><span class="line">#       <span class="comment">// position        // tc</span></span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>, -<span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line"># </span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#        <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">0.0</span>,</span><br><span class="line">#       -<span class="number">0.5</span>,  <span class="number">0.5</span>, -<span class="number">0.5</span>,  <span class="number">0.0</span>, <span class="number">1.0</span></span><br><span class="line">#     ];</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">vs_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#     #version 460 core</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     layout (location = 0) in vec3 position;</span></span><br><span class="line"><span class="string">#     layout (location = 1) in vec2 tc;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     out vec2 tex_tc;</span></span><br><span class="line"><span class="string">#     out flat int face_index;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     uniform mat4 trans = mat4(1.0);</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       gl_Position = trans * vec4(position, 1.0);</span></span><br><span class="line"><span class="string">#       tex_tc = vec2(tc.x, 1.0 - tc.y);</span></span><br><span class="line"><span class="string">#       face_index = gl_VertexID / 6;</span></span><br><span class="line"><span class="string">#     &#125;</span></span><br><span class="line"><span class="string">#     &quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">fs_src</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">#     #version 460 core</span></span><br><span class="line"><span class="string">#     </span></span><br><span class="line"><span class="string">#     in vec2 tex_tc;</span></span><br><span class="line"><span class="string">#     in flat int face_index;</span></span><br><span class="line"><span class="string">#     out vec4 color;</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     layout (binding = 0) uniform sampler2D s[6];</span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string">#     void main() &#123;</span></span><br><span class="line"><span class="string">#       color = texture(s[face_index], tex_tc);</span></span><br><span class="line"><span class="string">#     &#125;</span></span><br><span class="line"><span class="string">#     &quot;</span>;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">self</span>.prog = sb7::program::<span class="title function_ invoke__">link_from_shaders</span>(&amp;[</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(vs_src, gl::VERTEX_SHADER, <span class="literal">true</span>),</span><br><span class="line">#       sb7::shader::<span class="title function_ invoke__">from_str</span>(fs_src, gl::FRAGMENT_SHADER, <span class="literal">true</span>),</span><br><span class="line">#     ], <span class="literal">true</span>);</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">query_name</span> = |name: &amp;<span class="type">str</span>| <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">let</span> <span class="variable">name</span> = std::ffi::CString::<span class="title function_ invoke__">new</span>(name).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">#       gl::<span class="title function_ invoke__">GetUniformLocation</span>(<span class="keyword">self</span>.prog, name.<span class="title function_ invoke__">as_ptr</span>())</span><br><span class="line">#     &#125;;</span><br><span class="line">#     <span class="keyword">self</span>.uniform_trans = <span class="title function_ invoke__">query_name</span>(<span class="string">&quot;trans&quot;</span>);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       <span class="keyword">use</span> std::mem::&#123; size_of, size_of_val &#125;;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.vao);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindVertexArray</span>(<span class="keyword">self</span>.vao);</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindBuffer</span>(gl::ARRAY_BUFFER, <span class="keyword">self</span>.vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">NamedBufferData</span>(<span class="keyword">self</span>.vbo,</span><br><span class="line">#                           <span class="title function_ invoke__">size_of_val</span>(vertex_position) <span class="keyword">as</span> _,</span><br><span class="line">#                           vertex_position.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _,</span><br><span class="line">#                           gl::STATIC_DRAW);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexAttribPointer</span>(<span class="number">0</span>, <span class="number">3</span>, gl::FLOAT, gl::FALSE,</span><br><span class="line">#                               (<span class="number">5</span> * size_of::&lt;<span class="type">f32</span>&gt;()) <span class="keyword">as</span> _,</span><br><span class="line">#                               <span class="number">0</span> <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">VertexAttribPointer</span>(<span class="number">1</span>, <span class="number">2</span>, gl::FLOAT, gl::FALSE,</span><br><span class="line">#                               (<span class="number">5</span> * size_of::&lt;<span class="type">f32</span>&gt;()) <span class="keyword">as</span> _,</span><br><span class="line">#                               (<span class="number">3</span> * size_of::&lt;<span class="type">f32</span>&gt;()) <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(<span class="keyword">self</span>.vao, <span class="number">0</span>);</span><br><span class="line">#       gl::<span class="title function_ invoke__">EnableVertexArrayAttrib</span>(<span class="keyword">self</span>.vao, <span class="number">1</span>);</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">CreateTextures</span>(gl::TEXTURE_2D, <span class="number">6</span>, <span class="keyword">self</span>.texs.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line"># </span><br><span class="line">#       <span class="comment">// create samplers</span></span><br><span class="line">      gl::<span class="title function_ invoke__">CreateSamplers</span>(<span class="number">2</span>, <span class="keyword">self</span>.samplers.<span class="title function_ invoke__">as_mut_ptr</span>());</span><br><span class="line"># </span><br><span class="line">#       <span class="comment">// set filter mode</span></span><br><span class="line">      gl::<span class="title function_ invoke__">SamplerParameteri</span>(<span class="keyword">self</span>.samplers[<span class="number">0</span>],</span><br><span class="line">                            gl::TEXTURE_MAG_FILTER,</span><br><span class="line">                            gl::LINEAR <span class="keyword">as</span> _);</span><br><span class="line">      gl::<span class="title function_ invoke__">SamplerParameteri</span>(<span class="keyword">self</span>.samplers[<span class="number">1</span>],</span><br><span class="line">                            gl::TEXTURE_MAG_FILTER,</span><br><span class="line">                            gl::NEAREST <span class="keyword">as</span> _);</span><br><span class="line"># </span><br><span class="line">      <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">6</span> &#123;</span><br><span class="line">#         <span class="keyword">use</span> stb_image::image::&#123; load, LoadResult::*&#125;;</span><br><span class="line">#         <span class="keyword">let</span> (w, h, data) = <span class="keyword">match</span> <span class="title function_ invoke__">load</span>(&amp;<span class="built_in">format!</span>(<span class="string">&quot;assert_&#123;&#125;.png&quot;</span>, i + <span class="number">1</span>)) &#123;</span><br><span class="line">#           <span class="title function_ invoke__">ImageU8</span>(img) =&gt; (img.width, img.height, img.data),</span><br><span class="line">#           _ =&gt; <span class="built_in">unimplemented!</span>()</span><br><span class="line">#         &#125;;</span><br><span class="line">#         gl::<span class="title function_ invoke__">BindTexture</span>(gl::TEXTURE_2D, <span class="keyword">self</span>.texs[i]);</span><br><span class="line">#         gl::<span class="title function_ invoke__">TextureStorage2D</span>(<span class="keyword">self</span>.texs[i], <span class="number">1</span>, gl::RGBA8, w <span class="keyword">as</span> _, h <span class="keyword">as</span> _);</span><br><span class="line">#         gl::<span class="title function_ invoke__">TexSubImage2D</span>(gl::TEXTURE_2D, <span class="number">0</span>,</span><br><span class="line">#                           <span class="number">0</span>, <span class="number">0</span>, w <span class="keyword">as</span> _, h <span class="keyword">as</span> _,</span><br><span class="line">#                           gl::RGBA, gl::UNSIGNED_BYTE, data.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _);</span><br><span class="line"># </span><br><span class="line">#         <span class="comment">// bind texture to texture unit</span></span><br><span class="line">#         gl::<span class="title function_ invoke__">BindTextureUnit</span>(i <span class="keyword">as</span> _, <span class="keyword">self</span>.texs[i]);</span><br><span class="line"># </span><br><span class="line">        <span class="comment">// bind texture unit to sampler object</span></span><br><span class="line">        gl::<span class="title function_ invoke__">BindSampler</span>(i <span class="keyword">as</span> _, <span class="keyword">self</span>.samplers[i % <span class="number">2</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">#     &#125;</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">Enable</span>(gl::DEPTH_TEST);</span><br><span class="line">#       gl::<span class="title function_ invoke__">UseProgram</span>(<span class="keyword">self</span>.prog);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, current_time: <span class="type">f64</span>) &#123;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">t</span> = current_time <span class="keyword">as</span> <span class="type">f32</span> * <span class="number">40.0</span>;</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">AppConfig</span> &#123; width, height, .. &#125; = <span class="keyword">self</span>.<span class="title function_ invoke__">info</span>();</span><br><span class="line">#     <span class="keyword">let</span> <span class="variable">trans</span> = sb7::vmath::<span class="title function_ invoke__">perspective</span>(<span class="number">45.0</span>,</span><br><span class="line">#                                         width <span class="keyword">as</span> <span class="type">f32</span> / height <span class="keyword">as</span> <span class="type">f32</span>,</span><br><span class="line">#                                         <span class="number">0.1</span>, <span class="number">1000.0</span>)</span><br><span class="line">#       * sb7::vmath::<span class="title function_ invoke__">translate</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, -<span class="number">3.5</span>)</span><br><span class="line">#       * sb7::vmath::<span class="title function_ invoke__">rotate</span>(t, t, t);</span><br><span class="line"># </span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::COLOR, <span class="number">0</span>, [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">ClearBufferfv</span>(gl::DEPTH, <span class="number">0</span>, [<span class="number">1.0</span>].<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line"># </span><br><span class="line">#       gl::<span class="title function_ invoke__">ProgramUniformMatrix4fv</span>(<span class="keyword">self</span>.prog,</span><br><span class="line">#                                   <span class="keyword">self</span>.uniform_trans, <span class="number">1</span>,</span><br><span class="line">#                                   gl::FALSE,</span><br><span class="line">#                                   std::ptr::addr_of!(trans) <span class="keyword">as</span> _);</span><br><span class="line">#       gl::<span class="title function_ invoke__">BindTexture</span>(gl::TEXTURE_2D, <span class="keyword">self</span>.texs[<span class="number">0</span>]);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DrawArrays</span>(gl::TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># </span><br><span class="line">#   <span class="keyword">fn</span> <span class="title function_">shutdown</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">#     <span class="keyword">unsafe</span> &#123;</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteProgram</span>(<span class="keyword">self</span>.prog);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteVertexArrays</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.prog);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteBuffers</span>(<span class="number">1</span>, &amp;<span class="keyword">self</span>.vbo);</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteTextures</span>(<span class="number">6</span>, <span class="keyword">self</span>.texs.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#       gl::<span class="title function_ invoke__">DeleteSamplers</span>(<span class="number">2</span>, <span class="keyword">self</span>.samplers.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">#     &#125;</span><br><span class="line">#   &#125;</span><br><span class="line"># &#125;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">#   App::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">run</span>();</span><br><span class="line"># &#125;</span><br></pre></td></tr></table></figure>

<div class="demo_app" id="_ch5_6_0_texture_unit"></div>

<h4 id="纹理过滤"><a class="markdownIt-Anchor" href="#纹理过滤"></a> 纹理过滤</h4>
<p>纹理的大小与实际上渲染在屏幕上的大小一般都不是一比一的关系，会进行缩放与拉伸。<code>GL_TEXTURE_MIN_FILTER / GL_TEXTURE_MAG_FILTER</code> 用来设置纹理的缩放方式，<code>MIN</code> 表示纹理被缩小时采用的缩放方式，<code>MAG</code> 代表纹理放大时采用的方式，可能的取值：</p>
<ul>
<li>GL_NEAREST：邻近采样，纹理缩放时会使用离纹理坐标最近的像素点</li>
<li>GL_LINEAR：线性采样，纹理缩放时会将纹理坐标附近的点求和取平均值</li>
</ul>
<p>用 <code>glTexParameter() / glSamplerParameter()</code> 来设置纹理的过滤方式：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gl::<span class="title function_ invoke__">TextureParameteri</span>(gl::TEXTURE_2D,</span><br><span class="line">                      gl::TEXTURE_MAG_FILTER, gl::NEAREST <span class="keyword">as</span> _);</span><br><span class="line">gl::<span class="title function_ invoke__">TextureParameteri</span>(gl::TEXTURE_2D,</span><br><span class="line">                      gl::TEXTURE_MIN_FILTER, gl::LINEAR <span class="keyword">as</span> _);</span><br></pre></td></tr></table></figure>
<p>效果如下，左边是 <code>GL_LINEAR</code> ，右边是 <code>GL_NEARST</code>，原图是一张很小的图片，在渲染时被放大了：</p>

<div class="demo_app" id="_ch5_6_texturefilter"></div>

<h4 id="多级渐远纹理mipmap"><a class="markdownIt-Anchor" href="#多级渐远纹理mipmap"></a> 多级渐远纹理（mipmap）</h4>
<p>在书里被翻译成 mip 贴图。是一种强大的纹理技术，在可以提高渲染性能同时提高场景质量，主要解决了渲染纹理时遇到的两个问题：</p>
<ul>
<li>闪烁：纹理在屏幕上的显示大小远远小于纹理的实际大小的时候发生，在移动场景的时候会更加明显：
  <div class="demo_app" id="_ch5_7_0_tunnel_scintillation"></div>
  
可以点击 <code>Enable mipmap filter</code> 查看启用多级渐远纹理之后的效果</li>
<li>性能问题：渲染远处纹理时，往往只读取纹理的一小部分数据（浪费）</li>
</ul>
<p>解决办法是在渲染远处纹理时，使用较小的纹理贴图，这其实也就是多级渐远纹理的功能。多级渐远纹理由一系列纹理图像组成，每一层在各轴上缩小二分之一：</p>
<p><img src="mipmaps.png" alt="mipmaps" /></p>
<p>分级细化纹理的总层数在分配空间时通过 <code>glTexStorage2D()</code> 的 <code>levels</code> 参数指定：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glTexStorage2D</span><span class="params">(GLenum target,</span></span><br><span class="line"><span class="params">                    GLsizei levels,</span></span><br><span class="line"><span class="params">                    GLenum internalformat,</span></span><br><span class="line"><span class="params">                    GLsizei width,</span></span><br><span class="line"><span class="params">                    GLsizei height)</span>;</span><br></pre></td></tr></table></figure>
<p>将 256x256 的 2D 纹理的多级渐远纹理设置为 5：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gl::<span class="title function_ invoke__">TexStorage2D</span>(gl::TEXTURE_2D,  <span class="comment">// 已经绑到 TEXTURE_2D 的纹理</span></span><br><span class="line">                 <span class="number">5</span>,               <span class="comment">// 多级渐远纹理的总层数</span></span><br><span class="line">                 gl::RGBA,        <span class="comment">// 纹理格式</span></span><br><span class="line">                 <span class="number">256</span>, <span class="number">256</span>);       <span class="comment">// 256x256</span></span><br></pre></td></tr></table></figure>
<p>这里将总层数设置成 5，第 0 层大小为 256x256，即原始数据，第 1 层大小为 128x128，第二层大小为 64x64，以此类推，第 4 层的大小为 16x16。因为总层数是 5，多级渐远纹理渲染最小图像大小为 16x16。</p>
<p>向多级渐远纹理设置图像数据，一般有两种方式：</p>
<ul>
<li>用 <code>glTexSubImage2D()</code> 写入第 0 层的数据（原始数据，之前一直用的这种方式设置纹理数据），然后用 <code>glGenerateMipmap()</code> 让 OpenGL 自己生成纹理的缩小版本，生成剩下的层数（方便）：</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gl::<span class="title function_ invoke__">TexSubImage2D</span>(gl::TEXTURE_2D, <span class="number">0</span>,</span><br><span class="line">                  <span class="number">0</span>, <span class="number">0</span>, <span class="number">256</span>, <span class="number">256</span>,</span><br><span class="line">                  gl::RGBA, gl::UNSIGNED_BYTE,</span><br><span class="line">                  img_data_256 <span class="keyword">as</span> _);</span><br><span class="line">gl::<span class="title function_ invoke__">GenerateMipmap</span>(gl::TEXTURE_2D);</span><br></pre></td></tr></table></figure>
<ul>
<li>用 <code>glTexSubImage2D()</code> 手动为每一层写入图像数据，书上用来<a target="_blank" rel="noopener" href="https://github.com/openglsuperbible/sb7code/blob/3f80b7a829442e2de9199a15e08ce7d09fd9260e/src/sb7/sb7ktx.cpp#L257">载入 ktx 文件的代码</a>里也有类似的逻辑：</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gl::<span class="title function_ invoke__">TexSubImage2D</span>(gl::TEXTURE_2D, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">256</span>, <span class="number">256</span>,</span><br><span class="line">                  gl::RGBA, gl::UNSIGNED_BYTE,</span><br><span class="line">                  img_data_256 <span class="keyword">as</span> _);</span><br><span class="line">gl::<span class="title function_ invoke__">TexSubImage2D</span>(gl::TEXTURE_2D, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">                  gl::RGBA, gl::UNSIGNED_BYTE,</span><br><span class="line">                  img_data_128 <span class="keyword">as</span> _);</span><br><span class="line">gl::<span class="title function_ invoke__">TexSubImage2D</span>(gl::TEXTURE_2D, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">64</span>, <span class="number">64</span>,</span><br><span class="line">                  gl::RGBA, gl::UNSIGNED_BYTE,</span><br><span class="line">                  img_data_64 <span class="keyword">as</span> _);</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>多级渐远纹理需要设置过滤方式后才会生效，<code>GL_TEXTURE_MIN_FILTER</code> 需要设置成以下选项之一：</p>
<table>
<thead>
<tr>
<th style="text-align:left">过滤方式</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GL_NEAREST_MIPMAP_NEAREST</td>
<td style="text-align:left">使用最邻近的多级渐远纹理来匹配像素大小，并使用邻近插值进行纹理采样</td>
</tr>
<tr>
<td style="text-align:left">GL_LINEAR_MIPMAP_NEAREST</td>
<td style="text-align:left">使用最邻近的多级渐远纹理来匹配像素大小，并使用线性插值进行纹理采样</td>
</tr>
<tr>
<td style="text-align:left">GL_NEAREST_MIPMAP_LINEAR</td>
<td style="text-align:left">在两个最匹配像素大小的多级渐远纹理之间进行线性插值，使用邻近插值进行采样</td>
</tr>
<tr>
<td style="text-align:left">GL_LINEAR_MIPMAP_LINEAR</td>
<td style="text-align:left">在两个最匹配像素大小的多级渐远纹理之间进行线性插值，使用线性插值进行采样</td>
</tr>
</tbody>
</table>
<p>格式类似于 <code>GL_&lt;selector&gt;_MIPMAP_&lt;filter&gt;</code>，<code>selector</code> 用来说明用哪一层，<code>filter</code> 用来说明选好哪层后，如何缩放纹理。</p>
<p><code>GL_TEXTURE_MIN_FILTER</code> 只需要设置成 <code>GL_NEARST</code> 或 <code>GL_LINEAR</code>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gl::<span class="title function_ invoke__">TexParameteri</span>(gl::GL_TEXTURE_2D,gl::GL_TEXTURE_MIN_FILTER,</span><br><span class="line">                  gl::GL_LINEAR_MIPMAP_LINEAR);</span><br><span class="line">gl::<span class="title function_ invoke__">TexParameteri</span>(gl::GL_TEXTURE_2D, gl::GL_TEXTURE_MAG_FILTER,</span><br><span class="line">                  gl::GL_LINEAR);</span><br></pre></td></tr></table></figure>
<p>启用 <code>GL_LINEAR_MIPMAP_LINEAR</code> 效果如下：</p>

<div class="demo_app" id="_ch5_7_tunnel"></div>

<h4 id="环绕方式"><a class="markdownIt-Anchor" href="#环绕方式"></a> 环绕方式</h4>
<p>环绕方式指定了当纹理坐标超出 0.0 ~ 1.0 的范围时，OpenGL 以何种方式平铺图像。</p>
<p>需要将 <code>GL_TEXTURE_WRAP_S / GL_TEXTURE_WRAP_T / GL_TEXTURE_WRAP_R</code> 作为 <code>glTexParameter() / glSamplerParameter()</code> 的 <code>pname</code> 参数传入。<code>GL_TEXTURE_WRAP_S</code>、<code>GL_TEXTURE_WRAP_T</code> 代表纹理坐标的方向，<code>str</code> 与 <code>xyz</code> 是等价的。对应的取值如下：</p>
<table>
<thead>
<tr>
<th style="text-align:left">环绕方式</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GL_REPEAT</td>
<td style="text-align:left">正常平铺</td>
</tr>
<tr>
<td style="text-align:left">GL_MIRRORED_REPEAT</td>
<td style="text-align:left">镜像平铺</td>
</tr>
<tr>
<td style="text-align:left">GL_CLAMP_TO_EDGE</td>
<td style="text-align:left">拉伸边缘像素</td>
</tr>
<tr>
<td style="text-align:left">GL_CLAMP_TO_BORDER</td>
<td style="text-align:left">在 0~1 内绘制纹理，超出的部分用纯色填充</td>
</tr>
</tbody>
</table>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gl::<span class="title function_ invoke__">TexParameteri</span>(gl::TEXTURE_2D, gl::TEXTURE_WRAP_S, gl::REPEAT <span class="keyword">as</span> _);</span><br><span class="line">gl::<span class="title function_ invoke__">TexParameteri</span>(gl::TEXTURE_2D, gl::TEXTURE_WRAP_T, gl::REPEAT <span class="keyword">as</span> _);</span><br></pre></td></tr></table></figure>
<p>如果要使用 <code>GL_CLAMP_TO_BORDER</code>，需要先将 <code>GL_TEXTURE_BORDER_COLOR</code> 传入 <code>glSamplerParameterfv() / glTexParameterfv()</code> 来设置要填充的纯色：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">color</span> = [<span class="number">0.0</span>, <span class="number">0.1</span>, <span class="number">0.6</span>, <span class="number">1.0f32</span>];</span><br><span class="line">gl::<span class="title function_ invoke__">TexParameterfv</span>(gl::TEXTURE_2D,</span><br><span class="line">                   gl::TEXTURE_BORDER_COLOR, color.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">gl::<span class="title function_ invoke__">TexParameteri</span>(gl::TEXTURE_2D, gl::TEXTURE_WRAP_S,</span><br><span class="line">                  gl::GL_TEXTURE_BORDER_COLOR <span class="keyword">as</span> _);</span><br><span class="line">gl::<span class="title function_ invoke__">TexParameteri</span>(gl::TEXTURE_2D, gl::TEXTURE_WRAP_T,</span><br><span class="line">                  gl::GL_TEXTURE_BORDER_COLOR <span class="keyword">as</span> _);</span><br></pre></td></tr></table></figure>
<p><code>GL_TEXTURE_BORDER_COLOR</code>、<code>GL_MIRRORED_REPEAT</code>、<code>GL_CLAMP_TO_EDGE</code>、<code>GL_REPEAT</code> 对应的效果：</p>

<div class="demo_app" id="_ch5_8_wrapmodes"></div>

<p>还有一种特殊的环绕方式：<code>GL_MIRROR_CLAMP_TO_EDGE</code>，可以看成 <code>GL_MIRRORED_REPEAT</code> 和 <code>GL_CLAMP_TO_EDGE</code> 的组合，只将纹理进行一次镜像平铺，之后拉伸边缘像素：</p>

<div class="demo_app" id="_ch5_9_mirrorclampedge"></div>

<h3 id="数组纹理"><a class="markdownIt-Anchor" href="#数组纹理"></a> 数组纹理</h3>
<p>可以类比为一个相册，将相同尺寸的纹理数据塞到一个对象里，这个对象就是数组纹理，和数组类似，可以根据元素的下标访问里面的元素。其实和多级渐远纹理类似，都是在同一个对象里存储多张纹理数据。</p>
<p>OpenGL 支持 1D、 2D 数组纹理，也支持立方体贴图数组纹理。但还不支持 3D 数组纹理。</p>
<p>创建、初始化 2D 数组纹理：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">tex</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">gl::<span class="title function_ invoke__">CreateTextures</span>(gl::TEXTURE_2D_ARRAY, <span class="number">1</span>, &amp;<span class="keyword">mut</span> tex);</span><br><span class="line"></span><br><span class="line">gl::<span class="title function_ invoke__">TexStorage3D</span>(gl::TEXTURE_2D_ARRAY,</span><br><span class="line">                 <span class="number">1</span>, <span class="comment">// 有多少层多级渐远纹理</span></span><br><span class="line">                 gl::RGBA8,</span><br><span class="line">                 <span class="number">256</span>, <span class="number">256</span>,</span><br><span class="line">                 <span class="number">100</span>);  <span class="comment">// 元素个数</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">100</span> &#123;</span><br><span class="line">  gl::<span class="title function_ invoke__">TexSubImage3D</span>(gl::TEXTURE_2D_ARRAY,</span><br><span class="line">                    <span class="number">0</span>, <span class="comment">// 第 0 层渐远纹理</span></span><br><span class="line">                    <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                    i,  <span class="comment">// 第 i 个元素</span></span><br><span class="line">                    <span class="number">256</span>, <span class="number">256</span>,</span><br><span class="line">                    <span class="number">1</span>,  <span class="comment">// 元素大小 256x256 像素</span></span><br><span class="line">                    gl::RGBA, gl::UNSIGNED_BYTE,</span><br><span class="line">                    img_data[i].<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> _);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有意思的是，分配空间，填充数据用的函数是 <code>glTexStorage3D()</code> / <code>TexSubImage3D()</code>，参数 <code>depth</code> / <code>z</code> 用来表示元素的下标。</p>
<p>在着色器里和 2D 数组纹理对应的采样器是 <code>sampler2DArray</code>，可以用 <code>texture()</code> 来读取数组元素：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">vec4</span> <span class="built_in">texture</span> (<span class="type">sampler2DArray</span> sampler, <span class="type">vec3</span> P)</span><br></pre></td></tr></table></figure>
<p><code>P</code> 的 xy 分量代表 2D 纹理的纹理坐标，z 分量表示数组纹理的下标：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 460 core</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">out</span> <span class="type">vec4</span> color;</span><br><span class="line"></span><br><span class="line"><span class="keyword">in</span> VS_OUT &#123;</span><br><span class="line">  <span class="keyword">flat</span> <span class="type">int</span> alien;</span><br><span class="line">  <span class="type">vec2</span> tc;</span><br><span class="line">&#125; fs_in;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">sampler2DArray</span> tex_aliens;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main(<span class="type">void</span>) &#123;</span><br><span class="line">  color = <span class="built_in">texture</span>(tex_aliens, <span class="type">vec3</span>(fs_in.tc, <span class="type">float</span>(fs_in.alien)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是书里示例 <a target="_blank" rel="noopener" href="https://github.com/openglsuperbible/sb7code/blob/3f80b7a829442e2de9199a15e08ce7d09fd9260e/src/alienrain/alienrain.cpp#L106">alienrain</a> 的片段着色器，传入片段着色器的变量里，<code>tc</code> 表示要读取的纹理坐标，<code>alien</code> 表示要读取的纹理下标。</p>
<p>这个示例大概长这样：</p>

<div class="demo_app" id="_ch5_10_alienrain"></div>

<h3 id="在着色器中向纹理写入数据"><a class="markdownIt-Anchor" href="#在着色器中向纹理写入数据"></a> 在着色器中向纹理写入数据</h3>
<p>OpenGL 里通过 image 变量来向纹理写入数据。sampler 变量代表整个纹理，而 image 变量代表纹理持有的图像数据。</p>
<p>image 变量的类型与其对应的纹理：</p>
<table>
<thead>
<tr>
<th style="text-align:left">变量类型</th>
<th style="text-align:left">对应纹理</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">iamge1D</td>
<td style="text-align:left">1D 纹理</td>
</tr>
<tr>
<td style="text-align:left">iamge2D</td>
<td style="text-align:left">2D 纹理</td>
</tr>
<tr>
<td style="text-align:left">iamge3D</td>
<td style="text-align:left">3D 纹理</td>
</tr>
<tr>
<td style="text-align:left">iamgeCube</td>
<td style="text-align:left">立方体贴图纹理</td>
</tr>
<tr>
<td style="text-align:left">iamgeCubeArray</td>
<td style="text-align:left">立方体贴图数组纹理</td>
</tr>
<tr>
<td style="text-align:left">iamgeRect</td>
<td style="text-align:left">矩形纹理</td>
</tr>
<tr>
<td style="text-align:left">iamge1DArray</td>
<td style="text-align:left">1D 数组纹理</td>
</tr>
<tr>
<td style="text-align:left">iamge2DArray</td>
<td style="text-align:left">2D 数组纹理</td>
</tr>
<tr>
<td style="text-align:left">iamgeBuffer</td>
<td style="text-align:left">缓冲纹理</td>
</tr>
<tr>
<td style="text-align:left">iamge2DMS</td>
<td style="text-align:left">2D 多重采样纹理</td>
</tr>
<tr>
<td style="text-align:left">iamge2DMSArray</td>
<td style="text-align:left">2D 多重采样数组纹理</td>
</tr>
</tbody>
</table>
<p>在着色器里声明 image 变量：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uniform</span> <span class="type">image2D</span> my_image</span><br></pre></td></tr></table></figure>
<p>在着色器里 载入 / 写入 image 变量：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">vec4</span> <span class="built_in">imageLoad</span>(<span class="keyword">readonly</span> <span class="type">image2D</span> image, <span class="type">ivec2</span> P);</span><br><span class="line"><span class="type">void</span> <span class="built_in">imageStore</span>(<span class="type">image2D</span> image, <span class="type">ivec2</span> P, <span class="type">vec4</span> data);</span><br></pre></td></tr></table></figure>
<p>这里坐标纹理 <code>P</code> 是整数向量，说明其范围是在整个纹理数据里查找的。假设纹理的大小为 256x256，那么 P 的有效范围为 (0, 0) ~ (255, 255)。</p>
<p>iimage 和 uimage 变量代表内部存储整型的纹理图像，对应的存取函数为：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ivec4</span> <span class="built_in">imageLoad</span>(<span class="keyword">readonly</span> <span class="type">iimage2D</span> image, <span class="type">ivec2</span> P);</span><br><span class="line"><span class="type">void</span> <span class="built_in">imageStore</span>(<span class="type">iimage2D</span> image, <span class="type">ivec2</span> P, <span class="type">ivec4</span> data);</span><br><span class="line"><span class="type">uvec4</span> <span class="built_in">imageLoad</span>(<span class="keyword">readonly</span> <span class="type">uimage2D</span> image, <span class="type">ivec2</span> P);</span><br><span class="line"><span class="type">void</span> <span class="built_in">imageStore</span>(<span class="type">uimage2D</span> image, <span class="type">ivec2</span> P, <span class="type">uvec4</span> data);</span><br></pre></td></tr></table></figure>
<p>用 <code>glBindImageTexture()</code> 将纹理对象绑到 <strong>图像单元</strong> 上，这样就可以指定 image 变量存取的纹理了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glBindImageTexture</span><span class="params">(GLuint unit,</span></span><br><span class="line"><span class="params">                        GLuint texture,</span></span><br><span class="line"><span class="params">                        GLint level,</span></span><br><span class="line"><span class="params">                        GLboolean layered,</span></span><br><span class="line"><span class="params">                        GLint layer,</span></span><br><span class="line"><span class="params">                        GLenum access,</span></span><br><span class="line"><span class="params">                        GLenum format)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>uint</code>：图像单元，大于等于 0 的整数，类似与纹理单元，和 image 变量相关</li>
<li><code>texture</code>：要绑定的纹理对象，用来存储 image 变量的数据</li>
<li><code>level</code>：要绑定哪一层多级渐远纹理</li>
<li><code>layered</code>：与数组纹理有关，如果设置为 <code>gl_FALSE</code>，将绑定整个数组，设置为 <code>GL_TRUE</code> 则绑定其中一个元素</li>
<li><code>layer</code>：与数组纹理有关，指定要要绑定的数组元素。<code>layered</code> 为 <code>GL_FALSE</code> 时忽略</li>
<li><code>access</code>：权限：<code>GL_READ_ONLY</code>、<code>GL_WRITE_ONLY</code>、<code>GL_READ_WRITE</code></li>
<li><code>format</code>：image 变量存取的数据格式，与 <code>glTextureStorage**()</code> 里设置的格式相关，常用的格式有 <code>GL_RGBA32F</code>、<code>GL_RGBA8</code>，完整的列表可以查阅 <a target="_blank" rel="noopener" href="https://docs.gl/gl4/glBindImageTexture">docs.gl</a></li>
</ul>
<p>需要给 image 变量添加格式修饰符，和 <code>glBindImageTexture()</code> 的 <code>format</code> 对应：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>, <span class="keyword">rgba32ui</span>) <span class="keyword">readonly</span> <span class="keyword">uniform</span> <span class="type">uimage2D</span> image_in;</span><br></pre></td></tr></table></figure>
<p>在 image 对象之间复制数据：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 460 core</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Uniform image variables:</span></span><br><span class="line"><span class="comment">// Input image - note use of format qualifier because of loads</span></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>, <span class="keyword">rgba32ui</span>) <span class="keyword">readonly</span> <span class="keyword">uniform</span> <span class="type">uimage2D</span> image_in;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output image</span></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">1</span>) <span class="keyword">uniform</span> <span class="keyword">writeonly</span> <span class="type">uimage2D</span> image_out;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main(<span class="type">void</span>) &#123;</span><br><span class="line">  <span class="comment">// Use fragment coordinate as image coordinate</span></span><br><span class="line">  <span class="type">ivec2</span> P = <span class="type">ivec2</span>(<span class="built_in">gl_FragCoord</span>.xy);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Read from input image</span></span><br><span class="line">  <span class="type">uvec4</span> data = <span class="built_in">imageLoad</span>(image_in, P);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Write inverted data to output image</span></span><br><span class="line">  <span class="built_in">imageStore</span>(image_out, P, ~data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在多个着色器调用同时读写 image 变量时，需要通过原子操作来保证结果的正确性。</p>
<h3 id="在-image-变量上的原子操作"><a class="markdownIt-Anchor" href="#在-image-变量上的原子操作"></a> 在 image 变量上的原子操作</h3>
<p>原子操作是指一段不可分割的读取——修改——写入序列。重点在于不可分割，多个对象对同一存储进行原子操作可以保证结果正确。image 变量上支持的原子操作：</p>
<table>
<thead>
<tr>
<th style="text-align:left">函数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">uint imageAtomicAdd (image2D image, ivec2 P, uint data)</td>
<td style="text-align:left">在 P 处读取数据，与 data 相加，结果写入 image，返回原来读到的值</td>
</tr>
<tr>
<td style="text-align:left">uint imageAtomicMin (image2D image, ivec2 P, uint data)</td>
<td style="text-align:left">在 P 处读取数据，与 data 求最小值，结果写入 image，返回原来读到的值</td>
</tr>
<tr>
<td style="text-align:left">uint imageAtomicMax (image2D image, ivec2 P, uint data)</td>
<td style="text-align:left">在 P 处读取数据，与 data 求最大值，结果写入 image，返回原来读到的值</td>
</tr>
<tr>
<td style="text-align:left">uint imageAtomicAnd (image2D image, ivec2 P, uint data)</td>
<td style="text-align:left">在 P 处读取数据，与 data 求逻辑与，结果写入 image，返回原来读到的值</td>
</tr>
<tr>
<td style="text-align:left">uint imageAtomicOr (image2D image, ivec2 P, uint data)</td>
<td style="text-align:left">在 P 处读取数据，与 data 求逻辑或，结果写入 image，返回原来读到的值</td>
</tr>
<tr>
<td style="text-align:left">uint imageAtomicXor (image2D image, ivec2 P, uint data)</td>
<td style="text-align:left">在 P 处读取数据，与 data 进行异或，结果写入 image，返回原来读到的值</td>
</tr>
<tr>
<td style="text-align:left">uint imageAtomicExchange (image2D image, ivec2 P, uint data)</td>
<td style="text-align:left">在 P 处读取数据，将 data 写入 image，返回原来读到的值</td>
</tr>
<tr>
<td style="text-align:left">uint imageAtomicCompSwap (image2D image, ivec2 P, uint compare, uint data)</td>
<td style="text-align:left">将在 P 处读取的数据和 compare 比较，如果相等，将 data 写入 image，image，返回原来读到的值</td>
</tr>
</tbody>
</table>
<p>可以通过 image 变量的原子操作，在着色器内实现一些数据结构，如单向链表。虽然着色器内没有指针类型，但可以通过数组实现链表。数组表示的链表结构如下：</p>
<img src="linklist.png" style="scale: 80%">
<p>key 代表存储的元素，next 代表下一个元素的位置，header为头指针，指向第一个元素。上面链表存储的元素：[7, 2, 8, 4]</p>
<p>着色器内链表的实现需要三块内存：</p>
<ol>
<li>第一块用来存储链表元素，可以用着色器存储区块存储</li>
<li>第二块用来存储元素个数，可以用原子计数器存储</li>
<li>第三块用来存储头指针，可以用 image 变量存储，同时存储大量链表</li>
</ol>
<p>添加元素的过程（头插法）：</p>
<ol>
<li>用 <code>atomicCounterIncrement()</code> 将元素个数加1，返回要插入的下标</li>
<li>用 <code>imageAtomicExchange()</code> 更新头指针，返回前一个元素的下标</li>
<li>填充数据，将新元素的 next 设置为前一个元素的下标</li>
</ol>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 460 core</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Atomic counter for filled size</span></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>, <span class="keyword">offset</span> = <span class="number">0</span>) <span class="keyword">uniform</span> <span class="type">atomic_uint</span> fill_counter;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2D image to store header pointer</span></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>) <span class="keyword">uniform</span> <span class="type">uimage2D</span> head_pointer;</span><br><span class="line"></span><br><span class="line"><span class="comment">// element struct</span></span><br><span class="line">struct list_item &#123;</span><br><span class="line">  <span class="type">vec4</span> color;</span><br><span class="line">  <span class="type">float</span> depth;</span><br><span class="line">  <span class="type">int</span> facing;</span><br><span class="line">  <span class="type">uint</span> next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// array to storage elements</span></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>, <span class="keyword">std430</span>) <span class="keyword">buffer</span> list_item_block &#123;</span><br><span class="line">  list_item item[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Input from vertex shader</span></span><br><span class="line"><span class="keyword">in</span> VS_OUT &#123;</span><br><span class="line">  <span class="type">vec4</span> <span class="keyword">in</span>;</span><br><span class="line">&#125; fs_in;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main(<span class="type">void</span>) &#123;</span><br><span class="line">  <span class="type">ivec2</span> P = <span class="type">ivec2</span>(<span class="built_in">gl_FragCoord</span>.xy);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// index of new element</span></span><br><span class="line">  <span class="type">uint</span> <span class="keyword">index</span> = <span class="built_in">atomicCounterIncrement</span>(fill_counter);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get index of prev element</span></span><br><span class="line">  <span class="comment">// update header pointer</span></span><br><span class="line">  <span class="type">uint</span> old_index = <span class="built_in">imageAtomicExchange</span>(head_pointer, P, <span class="keyword">index</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fill data</span></span><br><span class="line">  item[<span class="keyword">index</span>].color = fs_in.color;</span><br><span class="line">  item[<span class="keyword">index</span>].depth = <span class="built_in">gl_FragCoord</span>.z;</span><br><span class="line">  item[<span class="keyword">index</span>].facing = <span class="built_in">gl_FrontFacing</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set next pointer</span></span><br><span class="line">  item[<span class="keyword">index</span>].next = old_index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>gl_FrontFacing</code> 是着色器的内置变量，判断图形是否处于正面</p>
<p>在初始化时，原子计数器内的值为 0，head_pointer 内的数据可以设置为 uint 的最大值 0xFFFFFFFF，表示 nil。插入第一个元素，index = 0，old_index = nil，item[0].next = nil</p>
<p>遍历链表，只需要查询 next 是不是 nil 就行：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 460 core</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Atomic counter for filled size</span></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>, <span class="keyword">offset</span> = <span class="number">0</span>) <span class="keyword">uniform</span> <span class="type">atomic_uint</span> fill_counter;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2D image to store header pointer</span></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>) <span class="keyword">uniform</span> <span class="type">uimage2D</span> head_pointer;</span><br><span class="line"></span><br><span class="line"><span class="comment">// element struct</span></span><br><span class="line">struct list_item &#123;</span><br><span class="line">  <span class="type">vec4</span> color;</span><br><span class="line">  <span class="type">float</span> depth;</span><br><span class="line">  <span class="type">int</span> facing;</span><br><span class="line">  <span class="type">uint</span> next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// array to storage elements</span></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">binding</span> = <span class="number">0</span>, <span class="keyword">std430</span>) <span class="keyword">buffer</span> list_item_block &#123;</span><br><span class="line">  list_item item[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">out</span> <span class="type">vec4</span> color;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="type">uint</span> max_fragments = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main(<span class="type">void</span>) &#123;</span><br><span class="line">  <span class="type">uint</span> frag_count = <span class="number">0</span>;</span><br><span class="line">  <span class="type">float</span> depth_accum = <span class="number">0.0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">ivec2</span> P = <span class="type">ivec2</span>(<span class="built_in">gl_FragCoord</span>.xy);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint</span> <span class="keyword">index</span> = <span class="built_in">imageLoad</span>(head_pointer, P);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (frag_count &lt; max_fragments &amp;&amp; <span class="keyword">index</span> != <span class="number">0xFFFFFFFFFF</span>) &#123;</span><br><span class="line">    list_item this_item = item[<span class="keyword">index</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (this_item.facing != <span class="number">0</span>) &#123;</span><br><span class="line">      depth_accum -= this_item.depth;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      depth_accum += this_item.depth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">index</span> = this_item.next;</span><br><span class="line">    frag_count++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  depth_accum *= <span class="number">3000.0</span>;</span><br><span class="line"></span><br><span class="line">  color = <span class="type">vec3</span>(depth_accum, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行截图（<a target="_blank" rel="noopener" href="https://github.com/openglsuperbible/sb7code/blob/master/src/fragmentlist/fragmentlist.cpp">源码</a>）：</p>
<p><img src="fragmentlist.png" alt="fragmentlists" /></p>
<h3 id="同步存取图像"><a class="markdownIt-Anchor" href="#同步存取图像"></a> 同步存取图像</h3>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// c</span></span><br><span class="line"><span class="comment">// glMemoryBarrier(GL_SHADER_IMAGE_ACCESS_BARRIER_BIT)</span></span><br><span class="line">gl::<span class="title function_ invoke__">MemoryBarrier</span>(gl::SHADER_IMAGE_ACCESS_BARRIER_BIT);</span><br></pre></td></tr></table></figure>
<p>对应的着色器函数：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memoryBarrierImage</span>()</span><br></pre></td></tr></table></figure>
<p>用来保证屏障前所有对 image 对象的读写的着色器都完成后，才执行之后使用 image 对象的着色器。</p>
<!--

摸了，以后需要用到的时候再嗦

### 纹理压缩

### 纹理视图

-->

<script type="module" src="/js/openglsb7th/ch5/index.js" async>
</script>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="../../../../index.html">首页</a></li>
         
          <li><a href="../../../../archives/">归档</a></li>
         
          <li><a href="../../../../tags/">标签</a></li>
         
          <li><a href="../../../../categories/">分类</a></li>
         
          <li><a href="../../../../booklist/">书单</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%86%B2"><span class="toc-number">1.</span> <span class="toc-text"> 缓冲</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%BC%93%E5%86%B2%E5%8C%BA%E5%AF%B9%E8%B1%A1-%E5%88%86%E9%85%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">1.1.</span> <span class="toc-text"> 创建缓冲区对象 &#x2F; 分配空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-number">1.2.</span> <span class="toc-text"> 更新缓冲区的内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A1%AB%E5%85%85%E6%95%B0%E6%8D%AE-%E7%BC%93%E5%86%B2%E5%8C%BA%E9%97%B4%E5%A4%8D%E5%88%B6%E6%95%B0%E6%8D%AE"><span class="toc-number">1.3.</span> <span class="toc-text"> 填充数据、缓冲区间复制数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E7%BC%93%E5%86%B2%E5%8C%BA%E4%BD%9C%E4%B8%BA%E9%A1%B6%E7%82%B9%E7%9D%80%E8%89%B2%E5%99%A8%E7%9A%84%E8%BE%93%E5%85%A5"><span class="toc-number">1.4.</span> <span class="toc-text"> 将缓冲区作为顶点着色器的输入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uniform-%E5%8F%98%E9%87%8F"><span class="toc-number">2.</span> <span class="toc-text"> Uniform 变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%91-uniform-%E5%8F%98%E9%87%8F%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE"><span class="toc-number">2.1.</span> <span class="toc-text"> 向 uniform 变量传递数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#uniform-%E5%8C%BA%E5%9D%97"><span class="toc-number">2.2.</span> <span class="toc-text"> Uniform 区块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9D%80%E8%89%B2%E5%99%A8%E5%AD%98%E5%82%A8%E5%8C%BA%E5%9D%97"><span class="toc-number">3.</span> <span class="toc-text"> 着色器存储区块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="toc-number">3.1.</span> <span class="toc-text"> 原子操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E5%86%85%E5%AD%98"><span class="toc-number">3.2.</span> <span class="toc-text"> 同步访问内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-opengl-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%86%85%E4%BD%BF%E7%94%A8%E5%B1%8F%E9%9A%9C"><span class="toc-number">3.3.</span> <span class="toc-text"> 在 OpenGL 应用程序内使用屏障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E7%9D%80%E8%89%B2%E5%99%A8%E5%86%85%E4%BD%BF%E7%94%A8%E5%B1%8F%E9%9A%9C"><span class="toc-number">3.4.</span> <span class="toc-text"> 在着色器内使用屏障</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E8%AE%A1%E6%95%B0%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text"> 原子计数器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E8%AE%A1%E6%95%B0%E5%99%A8%E7%9A%84%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE"><span class="toc-number">4.1.</span> <span class="toc-text"> 原子计数器的同步访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%B9%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text"> 纹理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BA%B9%E7%90%86"><span class="toc-number">5.1.</span> <span class="toc-text"> 创建、初始化纹理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%B9%E7%90%86%E7%9B%AE%E6%A0%87%E5%92%8C%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.</span> <span class="toc-text"> 纹理目标和类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E7%9D%80%E8%89%B2%E5%99%A8%E9%87%8C%E8%AF%BB%E5%8F%96%E7%BA%B9%E7%90%86%E6%95%B0%E6%8D%AE"><span class="toc-number">5.3.</span> <span class="toc-text"> 在着色器里读取纹理数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%87%E6%A0%B7%E5%99%A8%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.3.1.</span> <span class="toc-text"> 采样器类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E6%96%87%E4%BB%B6%E8%BD%BD%E5%85%A5%E7%BA%B9%E7%90%86"><span class="toc-number">5.4.</span> <span class="toc-text"> 从文件载入纹理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%B9%E7%90%86%E5%9D%90%E6%A0%87"><span class="toc-number">5.4.1.</span> <span class="toc-text"> 纹理坐标</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E7%BA%B9%E7%90%86%E6%95%B0%E6%8D%AE%E7%9A%84%E8%AF%BB%E5%8F%96%E6%96%B9%E5%BC%8F"><span class="toc-number">5.5.</span> <span class="toc-text"> 控制纹理数据的读取方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%B9%E7%90%86%E8%BF%87%E6%BB%A4"><span class="toc-number">5.5.1.</span> <span class="toc-text"> 纹理过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E6%B8%90%E8%BF%9C%E7%BA%B9%E7%90%86mipmap"><span class="toc-number">5.5.2.</span> <span class="toc-text"> 多级渐远纹理（mipmap）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E7%BB%95%E6%96%B9%E5%BC%8F"><span class="toc-number">5.5.3.</span> <span class="toc-text"> 环绕方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E7%BA%B9%E7%90%86"><span class="toc-number">5.6.</span> <span class="toc-text"> 数组纹理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E7%9D%80%E8%89%B2%E5%99%A8%E4%B8%AD%E5%90%91%E7%BA%B9%E7%90%86%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">5.7.</span> <span class="toc-text"> 在着色器中向纹理写入数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-image-%E5%8F%98%E9%87%8F%E4%B8%8A%E7%9A%84%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="toc-number">5.8.</span> <span class="toc-text"> 在 image 变量上的原子操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%AD%98%E5%8F%96%E5%9B%BE%E5%83%8F"><span class="toc-number">5.9.</span> <span class="toc-text"> 同步存取图像</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://yilozt.github.io/2022/01/23/openglsb7rs-5/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&text=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&title=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&is_video=false&description=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=OpenGL超级宝典第七版学习笔记 (5)：数据&body=Check out this article: https://yilozt.github.io/2022/01/23/openglsb7rs-5/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&title=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&title=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&title=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&title=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&name=OpenGL超级宝典第七版学习笔记 (5)：数据&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://yilozt.github.io/2022/01/23/openglsb7rs-5/&t=OpenGL超级宝典第七版学习笔记 (5)：数据"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2023
    yilozt
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="../../../../index.html">首页</a></li><!--
     --><!--
       --><li><a href="../../../../archives/">归档</a></li><!--
     --><!--
       --><li><a href="../../../../tags/">标签</a></li><!--
     --><!--
       --><li><a href="../../../../categories/">分类</a></li><!--
     --><!--
       --><li><a href="../../../../booklist/">书单</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->


 
  <link
    rel="preload"
    href="../../../../lib/font-awesome/css/all.min.css"
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript
    ><link
      rel="stylesheet"
      href="../../../../lib/font-awesome/css/all.min.css"
  /></noscript>


    <!-- jquery -->
 
  
<script src="/lib/jquery/jquery.min.js"></script>





<!-- scrollreveal -->
 
  
<script src="/lib/scrollreveal/scrollreveal.min.js"></script>



<!-- clipboard -->

   
    
<script src="/lib/clipboard/clipboard.min.js"></script>

  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from($(trigger.nextElementSibling.querySelectorAll('.code')).find('.line')).reduce((st, i) => st + i.innerText + '\n', '')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<!-- hiding some code -->

  <script type="text/javascript">
  $(function() {
    'use strict';
    const langs = ['rust', 'glsl'].map(l => '.highlight.' + l + ' .btn-copy').join(',');

    const lines_to_hide = {};

    // hiding-code HTML
    const eye_btn = "<span class=\"btn-eye tooltipped tooltipped-sw\" aria-label=\"expand\">"
                + '  <i class="far fa-eye"></i>';
                + '</span>';
    // mount the btn
    $(langs).before(eye_btn);

    // build the lines to hide
    const eyes = $('.btn-eye');
    const tables = $('.btn-eye~table');

    const match_codes = [];
    const match_gutters = [];
    const arrs = [match_codes, match_gutters];

    const wrap_arrs = (spans) => {
      // wraps lines in array into a span element
      arrs.forEach(arr => {
        if (arr.length > 0) {
          $(arr).wrapAll("<span class='boring'></span>");
          spans.push($(arr[0]).parent());
          arr.length = 0;
        }
      });
    };

    for (let i = 0; i < eyes.length; i++) {
      const id = "eye-" + i;
      eyes[i].id = id;
      const spans = [];
      const gutters = tables[i].querySelectorAll(".gutter .line");
      const codes = tables[i].querySelectorAll(".code .line");

      for (let j = 0; j < codes.length; j++) {
        if (codes[j].firstChild && codes[j].firstChild.textContent.startsWith("# ")) {
          // push lines to hide into array
          codes[j].firstChild.textContent = codes[j].firstChild.textContent.replace("# ", "");
          match_codes.push(codes[j]);
          match_codes.push(codes[j].nextElementSibling);
          if (gutters[j] !== undefined) {
            match_gutters.push(gutters[j]);
            match_gutters.push(gutters[j].nextElementSibling);
          }
        } else {
          wrap_arrs(spans);
        }
      }
      wrap_arrs(spans);

      if (spans.length === 0) {
        $("#" + id).remove();
      } else {
        // add index
        lines_to_hide[id] = spans;
        spans.forEach(t => t.hide());
      }
    }
    $('.code').addClass('show');

    // handle click event
    for ( let id in lines_to_hide) {
      const btn = $("#" + id);
      const icon = btn.find("i");
      btn.on("click", (e) => {
        if (icon.hasClass("fa-eye-slash")) {
          // hide lines
          lines_to_hide[id].forEach(t => t.fadeOut());
          btn.attr("aria-label", "expand");
          icon.removeClass("fa-eye-slash");
        } else {
          // show lines
          lines_to_hide[id].forEach(t => t.fadeIn());
          btn.attr("aria-label", "fold");
          icon.addClass("fa-eye-slash");
        }
      })
    }
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
